import{dynamicAtlasManager,Sprite,SpriteAtlas,CCInteger,CCFloat,SpriteFrame,_decorator,UIRenderer,NodeEventType,cclegacy,InstanceMaterialType,RenderTexture,Material,UITransform,Component,Size}from"cc";import{EDITOR,BUILD}from"cc/env";class Singleton{constructor(){this._isDisposed=!1}static getInst(){let t=this;if(null==t._inst)throw new Error(`Singleton is not initialized or destroyed, name is ${t.name}`);return t._inst}get isDisposed(){return this._isDisposed}dispose(){this._onPreDestroy()}_onPreDestroy(){this._isDisposed||(this.destroy&&this.destroy(),Singleton._inst=null,this._isDisposed=!0)}}class ObjectPool extends Singleton{constructor(){super(...arguments),this._pool=new Map}fetch(t){let e=this._pool.get(t);return e?0===e.length?new t:e.shift():new t}recycle(t){let e=t.constructor,r=this._pool.get(e);r||(r=[],this._pool.set(e,r)),r.length>1e3?console.warn(`pool ${e.name} is too large`):r.push(t)}}class JsHelper{static getMethodName(){let t=(new Error).stack.split("at ")[2],e=t.indexOf(" ");return t.substring(0,e)}static getRootDirName(t){return t.split("/")[0]}static sleep(t){return new Promise((e=>setTimeout(e,t)))}static isNullOrEmpty(t){return null==t||(0==t.length||void 0)}static getStringHashCode(t){let e=5381,r=t.length;for(;r;)e=33*e^t.charCodeAt(--r);return e>>>0}static modeString(t,e){return this.getStringHashCode(t)%e}static formatStr(t,...e){let r;if("string"!=typeof t){let t=new Error("formatStr args[0] is not string");return t.name+t.stack}return 0==e.length?t:(r=t.replace(/\{\{|\}\}|\{(\d+)\}/g,(function(t,r){return"{{"==t?"{":"}}"==t?"}":e[r]})),r)}}class Options extends Singleton{constructor(){super(...arguments),this.isServer=!1,this.process=1,this.zone=1,this.logLevel=1,this.develop=!0,this.console=!1,this._argsMap=new Map}_setArgs(t,e){this._argsMap.set(t,e)}getArgs(t){if(!this._argsMap.has(t))throw new Error(`Options.getArgs ${t} not exist`);return this._argsMap.get(t)}}class Logger extends Singleton{set iLog(t){this._iLog=t}log(t,...e){if(this.checkLogLevel(Logger.LOG_LEVEL)){let r=JsHelper.formatStr(t,...e);this._iLog.log(r)}}warn(t,...e){if(this.checkLogLevel(Logger.WARN_LEVEL)){let r=JsHelper.formatStr(t,...e);this._iLog.warn(r)}}error(t,...e){let r=JsHelper.formatStr(t,...e),i=new Error,s=JsHelper.formatStr("{0}, stack: {1}",r,i.stack);this._iLog.error(s)}checkLogLevel(t){return Options.getInst().logLevel<=t}coreLog(t,...e){let r=JsHelper.formatStr(t,...e);this._iLog.log(r)}coreWarn(t,...e){let r=JsHelper.formatStr(t,...e);this._iLog.warn(r)}coreError(t,...e){let r=JsHelper.formatStr(t,...e),i=new Error,s=JsHelper.formatStr("{0}, stack: {1}",r,i.stack);this._iLog.error(s)}}function log(t,...e){Logger.getInst().log(t,...e)}function warn(t,...e){Logger.getInst().warn(t,...e)}function error(t,...e){Logger.getInst().error(t,...e)}Logger.LOG_LEVEL=1,Logger.WARN_LEVEL=2;class TimeInfo extends Singleton{awake(){this.serverMinusClientTime=0}clientNow(){return Date.now()}serverNow(){return this.clientNow()+this.serverMinusClientTime}}function coreWarn(t,...e){let r=`[core]: ${JsHelper.formatStr(t,...e)}`;try{Logger.getInst().coreWarn(r)}catch(t){console.warn(r)}}function coreError(t,...e){let r=`[core]: ${JsHelper.formatStr(t,...e)}`;try{Logger.getInst().coreError(r)}catch(t){console.error(r)}}const timeBit$1=30n,processBit=14n,valueBit$1=20n,powTimeBit$1=2n**timeBit$1-1n,powProcessBit=2n**processBit-1n,powValueBit$1=2n**valueBit$1-1n,epoch$1=new Date(2023,4,1).getTime();class IdStruct{static get inst(){return null==IdStruct._inst&&(IdStruct._inst=new IdStruct),IdStruct._inst}static generate(){0==this.lastTime&&(this.lastTime=this.timeSinceEpoch(),this.lastTime<=0&&(coreWarn(`${(new this).constructor.name}: lastTime less than 0: ${this.lastTime}`),this.lastTime=1));let t=this.timeSinceEpoch();t>this.lastTime?(this.lastTime=t,this.idCount=0):(++this.idCount,this.idCount>powValueBit$1&&(++this.lastTime,this.idCount=0,coreError(`${(new this).constructor.name}: idCount per sec overflow: ${t} ${this.lastTime}`)));let e=IdStruct.inst;return e.init(this.lastTime,Options.getInst().process,this.idCount),e.result}static convertToId(t,e,r){return IdStruct.inst.init(t,e,r).result}static parseId(t){return IdStruct.inst.initById(t)}static timeSinceEpoch(){let t=(TimeInfo.getInst().clientNow()-epoch$1)/1e3;return Math.floor(t)}initById(t){return this.result=t,this.time=t&powTimeBit$1,t>>=timeBit$1,this.process=t&powProcessBit,t>>=processBit,this.value=t&powValueBit$1,this}init(t,e,r){return this.time=BigInt(t),this.process=BigInt(e),this.value=BigInt(r),this.updateResult(),this}updateResult(){this.result=this.value,this.result<<=processBit,this.result|=this.process,this.result<<=timeBit$1,this.result|=this.time}}IdStruct.lastTime=0,IdStruct.idCount=0;const timeBit=32n,valueBit=32n,powTimeBit=2n**timeBit-1n,powValueBit=2n**valueBit-1n,epoch=new Date(2023,4,1).getTime();class InstanceIdStruct{static get inst(){return null==InstanceIdStruct._inst&&(InstanceIdStruct._inst=new InstanceIdStruct),InstanceIdStruct._inst}static generate(){0==this.lastTime&&(this.lastTime=this.timeSinceEpoch(),this.lastTime<=0&&(coreWarn(`${(new this).constructor.name}: lastTime less than 0: ${this.lastTime}`),this.lastTime=1));let t=this.timeSinceEpoch();t>this.lastTime?(this.lastTime=t,this.idCount=0):(++this.idCount,this.idCount>powValueBit&&(++this.lastTime,this.idCount=0,coreError(`${(new this).constructor.name}: idCount per sec overflow: ${t} ${this.lastTime}`)));let e=InstanceIdStruct.inst;return e.init(this.lastTime,this.idCount),e.result}static convertToId(t,e){return InstanceIdStruct.inst.init(t,e).result}static parseId(t){return InstanceIdStruct.inst.initById(t)}static timeSinceEpoch(){let t=(TimeInfo.getInst().clientNow()-epoch)/1e3;return Math.floor(t)}initById(t){return this.result=t,this.time=t&powTimeBit,t>>=timeBit,this.value=t&powValueBit,this}init(t,e){return this.time=BigInt(t),this.value=BigInt(e),this.updateResult(),this}updateResult(){this.result=this.value,this.result<<=timeBit,this.result|=this.time}}InstanceIdStruct.lastTime=0,InstanceIdStruct.idCount=0;class IdGenerator extends Singleton{generateInstanceId(){return InstanceIdStruct.generate()}generateId(){return IdStruct.generate()}}const RoundBoxAssembler={GetIndexBuffer(t){let e=[0,1,2,2,3,0,4,5,6,6,7,4,8,9,10,10,11,8],r=12,i=function(i,s,o){let n=s;for(let s=0;s<t.segments-1;s++){let t=r;r++,e.push(i,n,t),n=t}e.push(i,n,o)};return t.leftBottom&&i(3,4,0),t.leftTop&&i(2,1,5),t.rightTop&&i(9,6,10),t.rightBottom&&i(8,11,7),e},createData(t){const e=t.requestRenderData();let r=0;r+=t.leftBottom?1:0,r+=t.leftTop?1:0,r+=t.rightTop?1:0,r+=t.rightBottom?1:0;let i=12+(t.segments-1)*r;e.dataLength=i,e.resize(i,18+3*t.segments*r);let s=RoundBoxAssembler.GetIndexBuffer(t);return e.chunk.setIndexBuffer(s),e},updateRenderData(t){const e=t.spriteFrame;dynamicAtlasManager.packToDynamicAtlas(t,e),this.updateUVs(t);const r=t.renderData;r&&e&&(r.vertDirty&&this.updateVertexData(t),r.updateRenderData(t,e))},updateWorldVerts(t,e){const r=t.renderData,i=e.vb,s=r.data,o=t.node.worldMatrix,n=r.floatStride;let a=0;const l=s.length;for(let t=0;t<l;t++){const e=s[t],r=e.x,l=e.y;let h=o.m03*r+o.m07*l+o.m15;h=h?1/h:1,a=t*n,i[a+0]=(o.m00*r+o.m04*l+o.m12)*h,i[a+1]=(o.m01*r+o.m05*l+o.m13)*h,i[a+2]=(o.m02*r+o.m06*l+o.m14)*h}},fillBuffers(t){if(null===t)return;const e=t.renderData,r=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVerts(t,r),e.vertDirty=!1),r.bufferId;const i=r.vertexOffset,s=r.meshBuffer,o=r.meshBuffer.iData;let n=s.indexOffset;const a=i;let l=RoundBoxAssembler.GetIndexBuffer(t);for(let t=0;t<e.indexCount;t++)o[n++]=a+l[t];s.indexOffset+=e.indexCount},updateVertexData(t){const e=t.renderData;if(!e)return;const r=t.node._uiProps.uiTransformComp,i=e.data,s=r.width,o=r.height,n=r.anchorX*s,a=r.anchorY*o,l=0-n,h=s-n,p=o-a,c=0-a,d=l+t.radius,u=c+t.radius,_=p-t.radius,m=h-t.radius;i[0].x=l,i[0].y=t.leftBottom?u:c,i[1].x=l,i[1].y=t.leftTop?_:p,i[2].x=d,i[2].y=t.leftTop?_:p,i[3].x=d,i[3].y=t.leftBottom?u:c,i[4].x=d,i[4].y=c,i[5].x=d,i[5].y=p,i[6].x=m,i[6].y=p,i[7].x=m,i[7].y=c,i[8].x=m,i[8].y=t.rightBottom?u:c,i[9].x=m,i[9].y=t.rightTop?_:p,i[10].x=h,i[10].y=t.rightTop?_:p,i[11].x=h,i[11].y=t.rightBottom?u:c;let g=12,f=function(e,r){for(let s=1;s<t.segments;s++){let o=r*Math.PI/180-s/t.segments*.5*Math.PI;i[g].x=e.x+Math.cos(o)*t.radius,i[g].y=e.y+Math.sin(o)*t.radius,g++}};t.leftBottom&&f(i[3],270),t.leftTop&&f(i[2],180),t.rightTop&&f(i[9],90),t.rightBottom&&f(i[8],0),e.vertDirty=!0},updateUVs(t){if(!t.spriteFrame)return;const e=t.renderData,r=e.chunk.vb,i=t.spriteFrame.uv,s=i[0],o=i[1],n=i[2],a=i[5],l=Math.abs(n-s),h=a-o,p=t.node._uiProps.uiTransformComp,c=e.data,d=p.width,u=p.height,_=p.anchorX*d,m=p.anchorY*u;for(let t=0;t<e.dataLength;t++)r[t*e.floatStride+3]=s+(c[t].x+_)/d*l,r[t*e.floatStride+4]=o+(c[t].y+m)/u*h},updateColor(t){const e=t.renderData,r=e.chunk.vb;let i=5;const s=t.color,o=s.r/255,n=s.g/255,a=s.b/255,l=s.a/255;for(let t=0;t<e.dataLength;t++,i+=e.floatStride)r[i]=o,r[i+1]=n,r[i+2]=a,r[i+3]=l}};var __decorate$1=function(t,e,r,i){var s,o=arguments.length,n=o<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,r,i);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(n=(o<3?s(n):o>3?s(e,r,n):s(e,r))||n);return o>3&&n&&Object.defineProperty(e,r,n),n};const{ccclass:ccclass$1,property:property$1,type:type,menu:menu$1}=_decorator;var EventType;!function(t){t.SPRITE_FRAME_CHANGED="spriteframe-changed"}(EventType||(EventType={}));let RoundBoxSprite=class extends UIRenderer{constructor(){super(...arguments),this._sizeMode=Sprite.SizeMode.TRIMMED,this._atlas=null,this._segments=10,this._radius=20,this._spriteFrame=null,this._leftTop=!0,this._rightTop=!0,this._leftBottom=!0,this._rightBottom=!0}get sizeMode(){return this._sizeMode}set sizeMode(t){this._sizeMode!==t&&(this._sizeMode=t,t!==Sprite.SizeMode.CUSTOM&&this._applySpriteSize())}get spriteAtlas(){return this._atlas}set spriteAtlas(t){this._atlas!==t&&(this._atlas=t)}get segments(){return this._segments}set segments(t){this._segments=t,this._renderData=null,this._flushAssembler()}get radius(){return this._radius}set radius(t){this._radius=t,this._updateUVs(),this.markForUpdateRenderData(!0)}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){if(this._spriteFrame===t)return;const e=this._spriteFrame;this._spriteFrame=t,this.markForUpdateRenderData(),this._applySpriteFrame(e),EDITOR&&this.node.emit(EventType.SPRITE_FRAME_CHANGED,this)}get leftTop(){return this._leftTop}set leftTop(t){this._leftTop=t,this.resetAssembler()}get rightTop(){return this._rightTop}set rightTop(t){this._rightTop=t,this.resetAssembler()}get leftBottom(){return this._leftBottom}set leftBottom(t){this._leftBottom=t,this.resetAssembler()}get rightBottom(){return this._rightBottom}set rightBottom(t){this._rightBottom=t,this.resetAssembler()}onLoad(){this._flushAssembler()}__preload(){this.changeMaterialForDefine(),super.__preload(),EDITOR&&(this._resized(),this.node.on(NodeEventType.SIZE_CHANGED,this._resized,this))}onEnable(){super.onEnable(),this._activateMaterial();this._spriteFrame&&this._updateUVs()}onDestroy(){EDITOR&&this.node.off(NodeEventType.SIZE_CHANGED,this._resized,this),super.onDestroy()}changeSpriteFrameFromAtlas(t){if(!this._atlas)return void console.warn("SpriteAtlas is null.");const e=this._atlas.getSpriteFrame(t);this.spriteFrame=e}changeMaterialForDefine(){let t;const e=this._instanceMaterialType;this._spriteFrame&&(t=this._spriteFrame.texture);let r=!1;if(t instanceof cclegacy.TextureBase){const e=t.getPixelFormat();r=e===cclegacy.TextureBase.PixelFormat.RGBA_ETC1||e===cclegacy.TextureBase.PixelFormat.RGB_A_PVRTC_4BPPV1||e===cclegacy.TextureBase.PixelFormat.RGB_A_PVRTC_2BPPV1}this._instanceMaterialType=r?InstanceMaterialType.USE_ALPHA_SEPARATED:InstanceMaterialType.ADD_COLOR_AND_TEXTURE,e!==this._instanceMaterialType&&this.updateMaterial()}_updateBuiltinMaterial(){let t=super._updateBuiltinMaterial();if(this.spriteFrame&&this.spriteFrame.texture instanceof RenderTexture){const e={SAMPLE_FROM_RT:!0,...t.passes[0].defines},r=new Material;r.initialize({effectAsset:t.effectAsset,defines:e}),t=r}return t}_render(t){t.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)}_canRender(){if(!super._canRender())return!1;const t=this._spriteFrame;return!(!t||!t.texture)}resetAssembler(){this._assembler=null,this._flushAssembler()}_flushAssembler(){const t=RoundBoxAssembler;this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateRenderData(this),this._updateColor())}_applySpriteSize(){if(this._spriteFrame){if(BUILD||!this._spriteFrame)if(Sprite.SizeMode.RAW===this._sizeMode){const t=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(t)}else if(Sprite.SizeMode.TRIMMED===this._sizeMode){const t=this._spriteFrame.rect;this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this.markForUpdateRenderData(!0),this._assembler.updateRenderData(this)}}_resized(){if(EDITOR&&this._spriteFrame){const t=this.node._uiProps.uiTransformComp.contentSize;let e=t.width,r=t.height;if(this._sizeMode===Sprite.SizeMode.RAW){const t=this._spriteFrame.originalSize;e=t.width,r=t.height}else if(this._sizeMode===Sprite.SizeMode.TRIMMED){const t=this._spriteFrame.rect;e=t.width,r=t.height}e===t.width&&r===t.height||(this._sizeMode=Sprite.SizeMode.CUSTOM)}}_activateMaterial(){const t=this._spriteFrame,e=this.getRenderMaterial(0);t&&e&&this.markForUpdateRenderData(),this.renderData&&(this.renderData.material=e)}_updateUVs(){this._assembler&&this._assembler.updateUVs(this)}_applySpriteFrame(t){const e=this._spriteFrame;let r=!1;e&&(t&&t.texture===e.texture||(r=!0),r&&(this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize())}};__decorate$1([property$1({serializable:!0})],RoundBoxSprite.prototype,"_sizeMode",void 0),__decorate$1([type(Sprite.SizeMode)],RoundBoxSprite.prototype,"sizeMode",null),__decorate$1([property$1({serializable:!0})],RoundBoxSprite.prototype,"_atlas",void 0),__decorate$1([type(SpriteAtlas)],RoundBoxSprite.prototype,"spriteAtlas",null),__decorate$1([property$1({type:CCInteger,serializable:!0})],RoundBoxSprite.prototype,"_segments",void 0),__decorate$1([property$1({type:CCInteger,serializable:!0,min:1})],RoundBoxSprite.prototype,"segments",null),__decorate$1([property$1({type:CCFloat,serializable:!0})],RoundBoxSprite.prototype,"_radius",void 0),__decorate$1([property$1({type:CCFloat,serializable:!0,min:0})],RoundBoxSprite.prototype,"radius",null),__decorate$1([property$1({serializable:!0})],RoundBoxSprite.prototype,"_spriteFrame",void 0),__decorate$1([type(SpriteFrame)],RoundBoxSprite.prototype,"spriteFrame",null),__decorate$1([property$1({serializable:!0})],RoundBoxSprite.prototype,"_leftTop",void 0),__decorate$1([property$1({serializable:!0})],RoundBoxSprite.prototype,"leftTop",null),__decorate$1([property$1({serializable:!0})],RoundBoxSprite.prototype,"_rightTop",void 0),__decorate$1([property$1({serializable:!0})],RoundBoxSprite.prototype,"rightTop",null),__decorate$1([property$1({serializable:!0})],RoundBoxSprite.prototype,"_leftBottom",void 0),__decorate$1([property$1({serializable:!0})],RoundBoxSprite.prototype,"leftBottom",null),__decorate$1([property$1({serializable:!0})],RoundBoxSprite.prototype,"_rightBottom",void 0),__decorate$1([property$1({serializable:!0})],RoundBoxSprite.prototype,"rightBottom",null),RoundBoxSprite=__decorate$1([menu$1("moye/RoundBoxSprite"),ccclass$1("RoundBoxSprite")],RoundBoxSprite);var __decorate=function(t,e,r,i){var s,o=arguments.length,n=o<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,r):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(t,e,r,i);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(n=(o<3?s(n):o>3?s(e,r,n):s(e,r))||n);return o>3&&n&&Object.defineProperty(e,r,n),n};const{ccclass:ccclass,property:property,menu:menu}=_decorator;let SizeFollow=class extends Component{constructor(){super(...arguments),this._heightFollow=!0,this._widthFollow=!0,this._heightOffset=0,this._widthOffset=0,this._changeSize=new Size}get target(){return this._target}set target(t){this._target=t,this.updateSizeOffset()}set heightFollow(t){this._heightFollow=t,this.updateSizeOffset()}get heightFollow(){return this._heightFollow}set widthFollow(t){this._widthFollow=t,this.updateSizeOffset()}get widthFollow(){return this._widthFollow}onLoad(){null!=this._target&&this._target.node.on(NodeEventType.SIZE_CHANGED,this.onTargetSizeChange,this)}onDestroy(){null!=this._target&&(this._target.isValid?(this._target.node.off(NodeEventType.SIZE_CHANGED,this.onTargetSizeChange,this),this._target=null):this._target=null)}onTargetSizeChange(){let t=this.node.getComponent(UITransform),e=this._target;this._changeSize.set(t.contentSize),this._widthFollow&&(this._changeSize.width=Math.max(0,e.width+this._widthOffset)),this._heightFollow&&(this._changeSize.height=Math.max(0,e.height+this._heightOffset)),t.setContentSize(this._changeSize)}updateSizeOffset(){if(null==this._target)return;let t=this.node.getComponent(UITransform),e=this._target;if(this._widthFollow){let r=t.width,i=e.width;this._widthOffset=r-i}if(this._heightFollow){let r=t.height,i=e.height;this._heightOffset=r-i}}};__decorate([property({type:UITransform})],SizeFollow.prototype,"target",null),__decorate([property({type:UITransform})],SizeFollow.prototype,"_target",void 0),__decorate([property],SizeFollow.prototype,"heightFollow",null),__decorate([property],SizeFollow.prototype,"_heightFollow",void 0),__decorate([property],SizeFollow.prototype,"widthFollow",null),__decorate([property],SizeFollow.prototype,"_widthFollow",void 0),__decorate([property({type:CCFloat})],SizeFollow.prototype,"_heightOffset",void 0),__decorate([property({type:CCFloat})],SizeFollow.prototype,"_widthOffset",void 0),SizeFollow=__decorate([menu("moye/SizeFollow"),ccclass("SizeFollow")],SizeFollow);export{IdGenerator,Logger,ObjectPool,RoundBoxSprite,SizeFollow,error,log,warn};