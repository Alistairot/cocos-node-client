import{_decorator,Component,director,SpriteFrame,Texture2D,instantiate,native,assetManager,Node,UITransform,CCFloat,Size,NodeEventType,Enum,Vec3,Label,v3,dynamicAtlasManager,Sprite,SpriteAtlas,CCInteger,UIRenderer,cclegacy,InstanceMaterialType,RenderTexture,Material}from"cc";import{NATIVE,EDITOR,BUILD}from"cc/env";class Singleton{constructor(){this._isDisposed=!1}static get(){const e=this;if(null==e._inst)throw new Error(`Singleton is not initialized or destroyed, name is ${e.name}`);return e._inst}get isDisposed(){return this._isDisposed}dispose(){this._onPreDestroy()}_onPreDestroy(){this._isDisposed||(this.destroy&&this.destroy(),Singleton._inst=null,this._isDisposed=!0)}}class TimeInfo extends Singleton{awake(){this.serverMinusClientTime=0}clientNow(){return Date.now()}serverNow(){return this.clientNow()+this.serverMinusClientTime}}class JsHelper{static getMethodName(){const e=(new Error).stack.split("at ")[2],t=e.indexOf(" ");return e.substring(0,t)}static getRootDirName(e){return e.split("/")[0]}static sleep(e){return new Promise((t=>setTimeout(t,e)))}static isNullOrEmpty(e){return null==e||(0==e.length||void 0)}static getStringHashCode(e){let t=5381,i=e.length;for(;i;)t=33*t^e.charCodeAt(--i);return t>>>0}static modeString(e,t){return this.getStringHashCode(e)%t}static powBigInt(e,t){let i=BigInt(1);for(let s=0;s<t;s++)i*=e;return i}static formatStr(e,...t){if("string"!=typeof e){const e=new Error("formatStr args[0] is not string");return e.name+e.stack}if(0==t.length)return e;return e.replace(/\{\{|\}\}|\{(\d+)\}/g,(function(e,i){return"{{"==e?"{":"}}"==e?"}":t[i]}))}}class Options extends Singleton{constructor(){super(...arguments),this.isServer=!1,this.logLevel=1,this.develop=!0}}class LoggerDefault{log(e){console.log(e)}warn(e){console.warn(e)}error(e){console.error(e)}}class Logger extends Singleton{set iLog(e){this._logInst=e}get _iLog(){return this._logInst||(this._logInst=new LoggerDefault,this._logInst.warn("not set iLog, use default logger")),this._logInst}log(e,...t){if(this.checkLogLevel(Logger.LOG_LEVEL)){const i=JsHelper.formatStr(e,...t);this._iLog.log(i)}}warn(e,...t){if(this.checkLogLevel(Logger.WARN_LEVEL)){const i=JsHelper.formatStr(e,...t);this._iLog.warn(i)}}error(e,...t){const i=JsHelper.formatStr(e,...t);this._iLog.error(i)}checkLogLevel(e){return Options.get().logLevel<=e}coreLog(e){this._iLog.log(e)}coreWarn(e){this._iLog.warn(e)}coreError(e){this._iLog.error(e)}}function log(e,...t){Logger.get().log(e,...t)}function warn(e,...t){Logger.get().warn(e,...t)}function error(e,...t){Logger.get().error(e,...t)}function coreLog(e,t,...i){const s=`[${e}]: ${JsHelper.formatStr(t,...i)}`;try{Logger.get().coreLog(s)}catch(e){console.log(s)}}function coreWarn(e,t,...i){const s=`[${e}]: ${JsHelper.formatStr(t,...i)}`;try{Logger.get().coreWarn(s)}catch(e){console.warn(s)}}function coreError(e,t,...i){const s=`[${e}]: ${JsHelper.formatStr(t,...i)}`;try{Logger.get().coreError(s)}catch(e){console.error(s)}}Logger.LOG_LEVEL=1,Logger.WARN_LEVEL=2;const IdGeneratorTag="IdGenerator",timeBit$1=30n,processBit=14n,valueBit$1=20n,powTimeBit$1=JsHelper.powBigInt(2n,timeBit$1)-1n,powProcessBit=JsHelper.powBigInt(2n,processBit)-1n,powValueBit$1=JsHelper.powBigInt(2n,valueBit$1)-1n,epoch$1=new Date(2023,4,1).getTime();class IdStruct{static get inst(){return null==IdStruct._inst&&(IdStruct._inst=new IdStruct),IdStruct._inst}static generate(){0==this._lastTime&&(this._lastTime=this.timeSinceEpoch(),this._lastTime<=0&&(coreWarn("IdGenerator","{0}: lastTime less than 0: {1}",(new this).constructor.name,this._lastTime),this._lastTime=1));const e=this.timeSinceEpoch();e>this._lastTime?(this._lastTime=e,this._idCount=0):(++this._idCount,this._idCount>powValueBit$1&&(++this._lastTime,this._idCount=0,coreError("IdGenerator","{0}: idCount per sec overflow: {1} {2}",(new this).constructor.name,e,this._lastTime)));const t=IdStruct.inst;return t.init(this._lastTime,1,this._idCount),t.result}static convertToId(e,t,i){return IdStruct.inst.init(e,t,i).result}static parseId(e){return IdStruct.inst.initById(e)}static timeSinceEpoch(){const e=(TimeInfo.get().clientNow()-epoch$1)/1e3;return Math.floor(e)}initById(e){return this.result=e,this.time=e&powTimeBit$1,e>>=timeBit$1,this.process=e&powProcessBit,e>>=processBit,this.value=e&powValueBit$1,this}init(e,t,i){return this.time=BigInt(e),this.process=BigInt(t),this.value=BigInt(i),this.updateResult(),this}updateResult(){this.result=this.value,this.result<<=processBit,this.result|=this.process,this.result<<=timeBit$1,this.result|=this.time}}IdStruct._lastTime=0,IdStruct._idCount=0;const timeBit=32n,valueBit=32n,powTimeBit=JsHelper.powBigInt(2n,timeBit)-1n,powValueBit=JsHelper.powBigInt(2n,valueBit)-1n,epoch=new Date(2023,4,1).getTime();class InstanceIdStruct{static get inst(){return null==InstanceIdStruct._inst&&(InstanceIdStruct._inst=new InstanceIdStruct),InstanceIdStruct._inst}static generate(){0==this._lastTime&&(this._lastTime=this.timeSinceEpoch(),this._lastTime<=0&&(coreWarn("IdGenerator","{0}: lastTime less than 0: {1}",(new this).constructor.name,this._lastTime),this._lastTime=1));const e=this.timeSinceEpoch();e>this._lastTime?(this._lastTime=e,this._idCount=0):(++this._idCount,this._idCount>powValueBit&&(++this._lastTime,this._idCount=0,coreError("IdGenerator","{0}: idCount per sec overflow: {1} {2}",(new this).constructor.name,e,this._lastTime)));const t=InstanceIdStruct.inst;return t.init(this._lastTime,this._idCount),t.result}static convertToId(e,t){return InstanceIdStruct.inst.init(e,t).result}static parseId(e){return InstanceIdStruct.inst.initById(e)}static timeSinceEpoch(){const e=(TimeInfo.get().clientNow()-epoch)/1e3;return Math.floor(e)}initById(e){return this.result=e,this.time=e&powTimeBit,e>>=timeBit,this.value=e&powValueBit,this}init(e,t){return this.time=BigInt(e),this.value=BigInt(t),this.updateResult(),this}updateResult(){this.result=this.value,this.result<<=timeBit,this.result|=this.time}}InstanceIdStruct._lastTime=0,InstanceIdStruct._idCount=0;class IdGenerator extends Singleton{generateInstanceId(){return InstanceIdStruct.generate()}generateId(){return IdStruct.generate()}}class ObjectPool extends Singleton{constructor(){super(...arguments),this._pool=new Map}fetch(e){const t=this._pool.get(e);return t?0===t.length?new e:t.shift():new e}recycle(e){const t=e.constructor;let i=this._pool.get(t);i||(i=[],this._pool.set(t,i)),i.length>1e3?console.warn(`pool ${t.name} is too large`):i.push(e)}}class EntityCenter extends Singleton{constructor(){super(...arguments),this._allEntities=new Map}add(e){this._allEntities.set(e.instanceId,e)}remove(e){this._allEntities.delete(e)}get(e){return this._allEntities.get(e)}}var InstanceQueueIndex,EntityStatus,SceneType;!function(e){e[e.NONE=-1]="NONE",e[e.UPDATE=0]="UPDATE",e[e.LATE_UPDATE=1]="LATE_UPDATE",e[e.MAX=2]="MAX"}(InstanceQueueIndex||(InstanceQueueIndex={}));class EntityLifiCycleMgr extends Singleton{constructor(){super(...arguments),this._queues=new Array(InstanceQueueIndex.MAX)}awake(){for(let e=0;e<this._queues.length;e++)this._queues[e]=[]}registerSystem(e){e.update&&this._queues[InstanceQueueIndex.UPDATE].push(e.instanceId),e.lateUpdate&&this._queues[InstanceQueueIndex.LATE_UPDATE].push(e.instanceId)}awakeComEvent(e){e.awake()}destroyComEvent(e){e.destroy()}update(){const e=this._queues[InstanceQueueIndex.UPDATE],t=EntityCenter.get();for(let i=e.length-1;i>=0;i--){const s=e[i],r=t.get(s);r?r.isDisposed?e.splice(i,1):r.update():e.splice(i,1)}}lateUpdate(){const e=this._queues[InstanceQueueIndex.LATE_UPDATE],t=EntityCenter.get();for(let i=e.length-1;i>=0;i--){const s=e[i],r=t.get(s);r?r.isDisposed?e.splice(i,1):r.lateUpdate():e.splice(i,1)}}}!function(e){e[e.NONE=0]="NONE",e[e.IS_FROM_POOL=1]="IS_FROM_POOL",e[e.IS_REGISTER=2]="IS_REGISTER",e[e.IS_COMPONENT=4]="IS_COMPONENT",e[e.IS_CREATED=8]="IS_CREATED",e[e.IS_NEW=16]="IS_NEW"}(EntityStatus||(EntityStatus={}));class Entity{constructor(){this._status=EntityStatus.NONE}get parent(){return this._parent}set parent(e){if(null==e)throw new Error(`cant set parent null: ${this.constructor.name}`);if(e==this)throw new Error(`cant set parent self: ${this.constructor.name}`);if(null==e.domain)throw new Error(`cant set parent because parent domain is null: ${this.constructor.name} ${e.constructor.name}`);if(null!=this._parent){if(this._parent==e)throw new Error(`重复设置了Parent: ${this.constructor.name} parent: ${this._parent.constructor.name}`);this._parent.removeFromChildren(this)}this._parent=e,this.isComponent=!1,this._parent.addToChildren(this),this.domain=this.parent.domain}get domain(){return this._domain}set domain(e){if(null==e)throw new Error(`domain cant set null: ${this.constructor.name}`);if(this._domain==e)return;const t=this._domain;if(this._domain=e,null==t&&(this.instanceId=IdGenerator.get().generateInstanceId(),this.isRegister=!0),null!=this._children)for(const[e,t]of this._children.entries())t.domain=this._domain;if(null!=this._components)for(const[e,t]of this._components.entries())t.domain=this._domain;this.isCreated||(this.isCreated=!0)}get isDisposed(){return 0n==this.instanceId}get children(){return this._children??(this._children=ObjectPool.get().fetch(Map))}get components(){return this._components??(this._components=ObjectPool.get().fetch(Map))}get isFromPool(){return(this._status&EntityStatus.IS_FROM_POOL)==EntityStatus.IS_FROM_POOL}set isFromPool(e){e?this._status|=EntityStatus.IS_FROM_POOL:this._status&=~EntityStatus.IS_FROM_POOL}get isComponent(){return(this._status&EntityStatus.IS_COMPONENT)==EntityStatus.IS_COMPONENT}set isComponent(e){e?this._status|=EntityStatus.IS_COMPONENT:this._status&=~EntityStatus.IS_COMPONENT}get isCreated(){return(this._status&EntityStatus.IS_CREATED)==EntityStatus.IS_CREATED}set isCreated(e){e?this._status|=EntityStatus.IS_CREATED:this._status&=~EntityStatus.IS_CREATED}get isNew(){return(this._status&EntityStatus.IS_NEW)==EntityStatus.IS_NEW}set isNew(e){e?this._status|=EntityStatus.IS_NEW:this._status&=~EntityStatus.IS_NEW}get isRegister(){return(this._status&EntityStatus.IS_REGISTER)==EntityStatus.IS_REGISTER}set isRegister(e){if(this.isRegister!=e)if(e?this._status|=EntityStatus.IS_REGISTER:this._status&=~EntityStatus.IS_REGISTER,e){const e=this;EntityCenter.get().add(e),EntityLifiCycleMgr.get().registerSystem(e)}else EntityCenter.get().remove(this.instanceId)}set componentParent(e){if(null==e)throw new Error(`cant set parent null: ${this.constructor.name}`);if(e==this)throw new Error(`cant set parent self: ${this.constructor.name}`);if(null==e.domain)throw new Error(`cant set parent because parent domain is null: ${this.constructor.name} ${e.constructor.name}`);if(null!=this.parent){if(this.parent==e)throw new Error(`重复设置了Parent: ${this.constructor.name} parent: ${this.parent.constructor.name}`);this.parent.removeFromComponents(this)}this._parent=e,this.isComponent=!0,this._parent.addToComponents(this),this.domain=this.parent.domain}addCom(e,t){return e instanceof Entity?this.addComByEntity(e):this.addComByType(e,t)}tryAddCom(e){let t=this.getCom(e);return null==t&&(t=this.addCom(e)),t}addComByEntity(e){const t=e.constructor;if(null!=this._components&&this._components.has(t))throw new Error(`entity already has component: ${t.name}`);return e.componentParent=this,e}addComByType(e,t=!1){if(null!=this._components&&this._components.has(e))throw new Error(`entity already has component: ${e.name}`);const i=this.create(e,t);return i.id=this.id,i.componentParent=this,i.awake&&EntityLifiCycleMgr.get().awakeComEvent(i),i}addChild(e,t){return e instanceof Entity?this.addChildByEntity(e):this.addChildByType(e,t)}addChildWithId(e,t,i=!1){const s=this.create(e,i);return s.id=t,s.parent=this,s.awake&&EntityLifiCycleMgr.get().awakeComEvent(s),s}addChildByEntity(e){return e.parent=this,e}addChildByType(e,t=!1){const i=this.create(e,t);return i.id=IdGenerator.get().generateId(),i.parent=this,i.awake&&EntityLifiCycleMgr.get().awakeComEvent(i),i}create(e,t){let i;return i=t?ObjectPool.get().fetch(e):new e,i.isFromPool=t,i.isCreated=!0,i.isNew=!0,i.id=0n,i}removeFromChildren(e){null!=this._children&&(this._children.delete(e.id),0==this._children.size&&(ObjectPool.get().recycle(this._children),this._children=null))}removeFromComponents(e){null!=this._components&&(this._components.delete(e.constructor),0==this._components.size&&(ObjectPool.get().recycle(this._components),this._components=null))}addToComponents(e){this.components.set(e.constructor,e)}addToChildren(e){if(this.children.has(e.id))throw new Error(`entity already has child: ${e.id}`);this.children.set(e.id,e)}getCom(e){if(null==this._components)return null;const t=this._components.get(e);return t||null}removeCom(e){if(this.isDisposed)return;if(null==this._components)return;const t=this.getCom(e);null!=t&&(this.removeFromComponents(t),t.dispose())}getParent(e){return this.parent}getChild(e,t){if(null==this._children)return null;return this._children.get(t)}removeChild(e){if(null==this._children)return;const t=this._children.get(e);t&&(this._children.delete(e),t.dispose())}dispose(){if(!this.isDisposed){if(this.isRegister=!1,this.instanceId=0n,null!=this._children){for(const[e,t]of this._children.entries())t.dispose();this._children.clear(),ObjectPool.get().recycle(this._children),this._children=null}if(null!=this._components){for(const[e,t]of this._components.entries())t.dispose();this._components.clear(),ObjectPool.get().recycle(this._components),this._components=null}this.destroy&&EntityLifiCycleMgr.get().destroyComEvent(this),this._domain=null,null==this._parent||this._parent.isDisposed||(this.isComponent?this._parent.removeCom(this.getType()):this._parent.removeFromChildren(this)),this._parent=null,this.isFromPool&&ObjectPool.get().recycle(this),this._status=EntityStatus.NONE}}domainScene(){return this.domain}getType(){return this.constructor}}class Scene extends Entity{set domain(e){this._domain=e}get domain(){return this._domain}set parent(e){null!=e&&(this._parent=e,this._parent.children.set(this.id,this))}init(e){this.id=e.id,this.instanceId=e.instanceId,this.sceneType=e.sceneType,this.name=e.name,this.parent=e.parent,this.isCreated=!0,this.isNew=!0,this.domain=this,this.isRegister=!0,coreLog("scene","scene create sceneType = {0}, name = {1}, id = {2}",this.sceneType,this.name,this.id)}}!function(e){e.NONE="NONE",e.PROCESS="PROCESS",e.CLIENT="CLIENT",e.CURRENT="CURRENT"}(SceneType||(SceneType={}));class Root extends Singleton{get scene(){return this._scene}awake(){const e=new Scene;e.init({id:0n,sceneType:SceneType.PROCESS,name:"Process",instanceId:IdGenerator.get().generateInstanceId()}),this._scene=e}}class RecycleObj{constructor(){this._isRecycle=!1}static create(e){const t=ObjectPool.get().fetch(this);return e&&Object.assign(t,e),t._isRecycle=!0,t}dispose(){this._isRecycle&&ObjectPool.get().recycle(this)}}class AEvent extends RecycleObj{}class BeforeSingletonAdd extends AEvent{}class AfterSingletonAdd extends AEvent{}class BeforeProgramInit extends AEvent{}class AfterProgramInit extends AEvent{}class BeforeProgramStart extends AEvent{}class AfterProgramStart extends AEvent{}class AfterCreateClientScene extends AEvent{}class AfterCreateCurrentScene extends AEvent{}class DecoratorCollector{constructor(){this._decorators=new Map}static get inst(){return null==DecoratorCollector._inst&&(DecoratorCollector._inst=new DecoratorCollector),DecoratorCollector._inst}add(e,...t){let i=this._decorators.get(e);i||(i=[],this._decorators.set(e,i)),i.push(t)}get(e){return this._decorators.get(e)||[]}}const EventDecoratorType="EventDecoratorType";function EventDecorator(e,t){return function(i){null==t&&console.error("EventDecorator必须要传 sceneType"),DecoratorCollector.inst.add(EventDecoratorType,e,i,t)}}class EventInfo{constructor(e,t){this.eventHandler=e,this.sceneType=t}}class MoyeEventCenter{constructor(){this.allEvents=new Map}static get inst(){return null==this._inst&&(this._inst=new MoyeEventCenter,this._inst.reloadEvent()),this._inst}reloadEvent(){const e=DecoratorCollector.inst.get(EventDecoratorType);this.allEvents.clear();for(const t of e){const e=t[0],i=t[1],s=t[2];let r=this.allEvents.get(e);r||(r=[],this.allEvents.set(e,r)),r.push(new EventInfo(new i,s))}}publish(e){const t=this.allEvents.get(e.constructor);if(t){for(let i=0;i<t.length;i++){t[i].eventHandler.handle(null,e)}e.dispose()}}}class Task extends Promise{static create(e){let t;const i=new Task((e=>{t=e}));return i._resolve=t,i}setResult(e){if(!this._resolve)throw new Error("setResult but task has been disposed");this._resolve(e),this.dispose()}constructor(e){super(e)}dispose(){this._resolve=null}}class Game{static addSingleton(e,t=!0){if(Game._singletonMap.has(e))throw new Error(`already exist singleton: ${e.name}`);t&&MoyeEventCenter.inst.publish(BeforeSingletonAdd.create({singletonType:e}));const i=new e;e._inst=i,Game._singletonMap.set(e,i),Game._singletons.push(i);const s=i;return s.awake&&s.awake(),Game._destroys.push(s),s.update&&Game._updates.push(s),s.lateUpdate&&Game._lateUpdates.push(s),t&&MoyeEventCenter.inst.publish(AfterSingletonAdd.create({singletonType:e})),i}static async waitFrameFinish(){const e=Task.create();Game._frameFinishTaskQueue.push(e),await e}static update(){for(let e=0;e<Game._updates.length;e++){const t=Game._updates[e];t.isDisposed||t.update()}}static lateUpdate(){for(let e=0;e<Game._lateUpdates.length;e++){const t=Game._lateUpdates[e];t.isDisposed||t.lateUpdate()}}static frameFinishUpdate(){const e=Game._frameFinishTaskQueue.length;if(0!=e){for(let t=0;t<e;t++){Game._frameFinishTaskQueue[t].setResult()}Game._frameFinishTaskQueue=[]}}static dispose(){for(let e=Game._singletons.length-1;e>=0;e--){const t=Game._singletons[e];t.isDisposed||t._onPreDestroy()}}}Game._singletonMap=new Map,Game._singletons=[],Game._destroys=[],Game._updates=[],Game._lateUpdates=[],Game._frameFinishTaskQueue=[];class EventSystem extends Singleton{async publishAsync(e,t){const i=MoyeEventCenter.inst.allEvents.get(t.constructor);if(!i)return;const s=[];for(let r=0;r<i.length;r++){const n=i[r];n.sceneType!=e.sceneType&&"None"!=n.sceneType||s.push(n.eventHandler.handleAsync(e,t))}await Promise.all(s),t.dispose()}publish(e,t){const i=MoyeEventCenter.inst.allEvents.get(t.constructor);if(i){for(let s=0;s<i.length;s++){const r=i[s];r.sceneType!=e.sceneType&&"None"!=r.sceneType||r.eventHandler.handle(e,t)}t.dispose()}}}var __decorate$4=function(e,t,i,s){var r,n=arguments.length,o=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,s);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(n<3?r(o):n>3?r(t,i,o):r(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o};const{ccclass:ccclass$3,property:property$3}=_decorator;let MoyeRuntime=class extends Component{start(){director.addPersistRootNode(this.node)}update(e){Game.update()}lateUpdate(e){Game.lateUpdate(),Game.frameFinishUpdate()}onDestroy(){Game.dispose()}};MoyeRuntime=__decorate$4([ccclass$3("MoyeRuntime")],MoyeRuntime);class TimeHelper{static clientNow(){return TimeInfo.get().clientNow()}static clientNowSeconds(){return Math.floor(TimeHelper.clientNow()/1e3)}static serverNow(){return TimeInfo.get().serverNow()}}var TimerType;TimeHelper.oneDay=864e5,TimeHelper.oneHour=36e5,TimeHelper.oneMinute=6e4,function(e){e[e.ONCE=0]="ONCE",e[e.REPEAT=1]="REPEAT"}(TimerType||(TimerType={}));class Timer{static create(){const e=ObjectPool.get().fetch(Timer);return e.reset(),e.id=Timer.getId(),e}static getId(){return++this._idGenerator}reset(){this.cb=null,this.tcs=null,this.id=0,this.expireTime=0,this.interval=0}dispose(){this.reset(),ObjectPool.get().recycle(this)}}Timer._idGenerator=1e3;class TimerMgr extends Singleton{constructor(){super(...arguments),this._timerMap=new Map,this._timers=[]}newRepeatedTimer(e,t,i=!1){const s=Timer.create();return s.type=TimerType.REPEAT,s.cb=t,s.interval=e,s.expireTime=e+TimeHelper.clientNow(),this._timerMap.set(s.id,s),this._timers.push(s),s.id}newOnceTimer(e,t){const i=Timer.create();return i.type=TimerType.ONCE,i.cb=t,i.expireTime=e+TimeHelper.clientNow(),this._timerMap.set(i.id,i),this._timers.push(i),i.id}newFrameTimer(e){const t=Timer.create();return t.type=TimerType.REPEAT,t.cb=e,t.interval=1,t.expireTime=t.interval+TimeHelper.clientNow(),this._timerMap.set(t.id,t),this._timers.push(t),t.id}remove(e){const t=this._timerMap.get(e);return!!t&&(t.id=0,this._timerMap.delete(e),!0)}update(){const e=TimeHelper.clientNow();for(let t=this._timers.length-1;t>=0;t--){const i=this._timers[t];0!=i.id?i.expireTime>e||(null!=i.cb&&i.cb(),null!=i.tcs&&i.tcs.setResult(),i.type==TimerType.REPEAT?i.expireTime+=i.interval:this.remove(i.id)):(this._timers.splice(t,1),i.dispose())}}async waitAsync(e,t){if(e<=0)return;const i=Task.create(),s=Timer.create();let r;s.type=TimerType.ONCE,s.tcs=i,s.expireTime=e+TimeHelper.clientNow(),this._timerMap.set(s.id,s),this._timers.push(s),t&&(r=()=>{this.remove(s.id)&&i.setResult()},t.add(r));try{await i}finally{t?.remove(r),r=null}}}const CoroutineLockTag="CoroutineLock";class CoroutineLockItem{init(e){this.key=e,this.task=Task.create(),Options.get().develop&&this.setTimeout(6e4,"CoroutineLock timeout")}setTimeout(e,t){this.deleteTimeout(),this._timerId=TimerMgr.get().newOnceTimer(e,this.timeout.bind(this)),this._timeoutInfo=t}deleteTimeout(){null!=this._timerId&&(TimerMgr.get().remove(this._timerId),this._timerId=null)}async timeout(){coreWarn("CoroutineLock","CoroutineLock timeout key: {0}, info: {1}",this.key,this._timeoutInfo)}dispose(){null!=this.key?(this.deleteTimeout(),CoroutineLock.get().runNextLock(this),this.key=null,this.task=null):coreWarn("CoroutineLock","repeat dispose CoroutineLockItem")}}class CoroutineLock extends Singleton{constructor(){super(...arguments),this._lockMap=new Map}async wait(e,t){const i=`${e}_${t}`;let s=this._lockMap.get(i);s||(s=new Set,this._lockMap.set(i,s));const r=ObjectPool.get().fetch(CoroutineLockItem);return r.init(i),s.add(r),s.size>1?await r.task:r.task.setResult(),r}runNextLock(e){const t=this._lockMap.get(e.key);t.delete(e),ObjectPool.get().recycle(e);for(const e of Array.from(t.values())){e.task.setResult();break}}}class SceneRefCom extends Entity{}class SceneFactory{static createClientScene(){const e=Root.get().scene.getCom(SceneRefCom);e.scene?.dispose();const t=new Scene;return t.init({id:1n,sceneType:SceneType.CLIENT,name:"Game",instanceId:IdGenerator.get().generateInstanceId(),parent:e}),t.addCom(SceneRefCom),e.scene=t,EventSystem.get().publish(t,AfterCreateClientScene.create()),t}static createCurrentScene(e,t){const i=Root.get().scene.getCom(SceneRefCom).scene.getCom(SceneRefCom);i.scene?.dispose();const s=new Scene;return s.init({id:e,sceneType:SceneType.CURRENT,name:t,instanceId:IdGenerator.get().generateInstanceId(),parent:i}),i.scene=s,EventSystem.get().publish(s,AfterCreateCurrentScene.create()),s}}class Program{static init(e){MoyeEventCenter.inst.publish(new BeforeProgramInit),Game.addSingleton(ObjectPool,!1),Game.addSingleton(Options),Game.addSingleton(Logger),Game.addSingleton(EventSystem),Game.addSingleton(TimeInfo),Game.addSingleton(TimerMgr),Game.addSingleton(CoroutineLock),Game.addSingleton(IdGenerator),Game.addSingleton(EntityCenter),Game.addSingleton(EntityLifiCycleMgr),Game.addSingleton(Root),e.addComponent(MoyeRuntime),MoyeEventCenter.inst.publish(new AfterProgramInit)}static start(){MoyeEventCenter.inst.reloadEvent(),MoyeEventCenter.inst.publish(new BeforeProgramStart),MoyeEventCenter.inst.publish(new AfterProgramStart),Root.get().scene.addCom(SceneRefCom),SceneFactory.createClientScene()}}async function safeCall(e){try{return await e}catch(e){coreError("safeCall",e)}}const EventHandlerTag="EventHandler";class AEventHandler{async handleAsync(e,t){try{await this.run(e,t)}catch(e){coreError("EventHandler",e)}}handle(e,t){try{const i=this.run(e,t);i instanceof Promise&&(coreWarn("EventHandler","{0}的run方法是异步的, 请尽量不要用publish来通知",this.constructor.name),safeCall(i))}catch(e){coreError("EventHandler",e)}}}const CancellationTokenTag="CancellationToken";class CancellationToken{constructor(){this._actions=new Set}add(e){null!=e?this._actions.add(e):coreError("CancellationToken","CancellationToken add error, callback is null")}remove(e){this._actions.delete(e)}cancel(){null!=this._actions?this.invoke():coreError("CancellationToken","CancellationToken cancel error, repeat cancel")}isCancel(){return null==this._actions}invoke(){const e=this._actions;this._actions=null;try{for(const t of e)t();e.clear()}catch(e){coreError("CancellationToken",e)}}}class AssetInfo{init(e,t){const i=(t=this.parseLocation(e,t)).split("/");let s="";for(let e=1;e<i.length;e++)s+=i[e],e!=i.length-1&&(s+="/");this.bundleName=i[0],this.assetPath=s,this.assetType=e,this.uuid=`${t}.${e.name}`}parseLocation(e,t){return e==SpriteFrame?t.endsWith("spriteFrame")||(t+="/spriteFrame"):e==Texture2D&&(t.endsWith("texture")||(t+="/texture")),t}}class AssetSystem{constructor(){this._waitLoads=[],this._loadingSet=new Set,this._frameAddCount=0}update(){this._frameAddCount=0,this.updateLoadingSet()}addProvider(e){this._waitLoads.push(e),this.updateLoadingSet()}updateLoadingSet(){if(this._frameAddCount>=AssetSystem._frameMaxAddQueueProvider)return;if(this._loadingSet.size>=AssetSystem._maxLoadingProvider)return;if(0==this._waitLoads.length)return;const e=this._waitLoads.shift();this._loadingSet.add(e),e.internalLoad()}removeProvider(e){this._loadingSet.delete(e),this.updateLoadingSet()}}AssetSystem._maxLoadingProvider=1,AssetSystem._frameMaxAddQueueProvider=1;const MoyeAssetTag="MoyeAsset";class AssetOperationHandle{constructor(){this.isDisposed=!1}getAsset(e){return this.provider.asset}dispose(){this.isDisposed?coreError("MoyeAsset","重复销毁AssetOperationHandle"):(this.isDisposed=!0,this.provider.releaseHandle(this))}instantiateSync(){return instantiate(this.provider.asset)}async instantiateAsync(){return instantiate(this.provider.asset)}}class BundleAssetProvider{constructor(){this.refCount=0,this._handleSet=new Set}async internalLoad(){const e=this.assetInfo.assetPath,t=this.assetInfo.assetType;this.bundleAsset.bundle.load(e,t,((e,t)=>{e?coreError("MoyeAsset","加载资源错误:{0},{1}",this.assetInfo.uuid,e):this.asset=t,this._task.setResult(),this.assetSystem.removeProvider(this)}))}async load(){this._task=Task.create(),this.assetSystem.addProvider(this),await this._task}createHandle(){this.refCount++;const e=new AssetOperationHandle;return e.provider=this,this._handleSet.add(e),e}releaseHandle(e){this.refCount<=0&&coreWarn("MoyeAsset","Asset provider reference count is already zero. There may be resource leaks !"),0==this._handleSet.delete(e)&&coreError("MoyeAsset","Should never get here !"),this.refCount--}}var AssetLockType;!function(e){e.BUNDLE_ASSET_LOAD="bundle_asset_load",e.BUNDLE_LOAD="bundle_load"}(AssetLockType||(AssetLockType={}));class BundleAsset{constructor(){this.refCount=0,this.isAutoRelease=!0,this._providerMap=new Map}async loadAssetAsync(e){let t=this._providerMap.get(e.uuid);t||(t=await this.createProvider(e));return t.createHandle()}async createProvider(e){const t=await CoroutineLock.get().wait(AssetLockType.BUNDLE_ASSET_LOAD,e.uuid);try{let t=this._providerMap.get(e.uuid);return t||(t=new BundleAssetProvider,t.assetInfo=e,t.assetSystem=this.assetSystem,t.bundleAsset=this,this.refCount++,await t.load(),this._providerMap.set(e.uuid,t),t)}finally{t.dispose()}}unloadUnusedAssets(){for(const[e,t]of this._providerMap)0==t.refCount&&(this.bundle.release(t.assetInfo.assetPath,t.assetInfo.assetType),this._providerMap.delete(e),this.refCount--)}}class MoyeAssets extends Singleton{awake(){MoyeAssets.assetSystem=new AssetSystem}update(){MoyeAssets.assetSystem.update()}static async loadAssetAsync(e,t){try{const i=new AssetInfo;i.init(e,t);const s=i.bundleName;let r=MoyeAssets._bundleMap.get(s);r||(r=await this.loadBundleAsync(s));return await r.loadAssetAsync(i)}catch(e){coreError("MoyeAsset",e)}}static async loadBundleAsync(e){const t=await CoroutineLock.get().wait(AssetLockType.BUNDLE_LOAD,e);try{let t=MoyeAssets._bundleMap.get(e);if(t)return t;const i=Task.create();if(!this._bundlePathMap.has(e)&&(this._bundlePathMap.set(e,e),NATIVE)){const t=`${native.fileUtils.getWritablePath()}hot/${e}`;native.fileUtils.isDirectoryExist(t)&&this._bundlePathMap.set(e,t)}const s=this._bundlePathMap.get(e);coreLog("MoyeAsset","加载bundle: {0}",s),assetManager.loadBundle(s,((t,s)=>{t?coreLog("MoyeAsset","加载Bundle错误, bundle={0}, error={1}",e,t):coreLog("MoyeAsset","加载Bundle完成, bundle={0}",e),i.setResult(s)}));const r=await i;return t=new BundleAsset,t.bundle=r,t.bundleName=e,t.assetSystem=MoyeAssets.assetSystem,MoyeAssets._bundleMap.set(e,t),t}finally{t.dispose()}}static releaseBundle(e){0==e.refCount?(this._bundleMap.delete(e.bundleName),assetManager.removeBundle(e.bundle),coreLog("MoyeAsset","卸载bundle:{0}",e.bundleName)):coreError("MoyeAsset","释放的bundle:{0}, 引用计数不为0",e.bundleName)}static unloadUnusedAssets(){for(const[e,t]of this._bundleMap)t.unloadUnusedAssets(),0==t.refCount&&t.isAutoRelease&&MoyeAssets.releaseBundle(t)}}MoyeAssets._bundleMap=new Map,MoyeAssets._bundlePathMap=new Map;var __decorate$3=function(e,t,i,s){var r,n=arguments.length,o=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,s);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(n<3?r(o):n>3?r(t,i,o):r(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o};let AfterProgramInitHandler=class extends AEventHandler{run(e,t){Game.addSingleton(MoyeAssets)}};AfterProgramInitHandler=__decorate$3([EventDecorator(AfterProgramInit,SceneType.NONE)],AfterProgramInitHandler);const ViewDecoratorType="ViewDecorator";function ViewDecorator(e,t,i){return function(s){DecoratorCollector.inst.add("ViewDecorator",s,e,t,i)}}var ViewLayer;!function(e){e[e.SCENE=1]="SCENE",e[e.BACKGROUND=2]="BACKGROUND",e[e.NORMAL=3]="NORMAL",e[e.INFO=4]="INFO",e[e.TIPS=5]="TIPS",e[e.TOP=6]="TOP"}(ViewLayer||(ViewLayer={}));class ViewCleanCom extends Entity{constructor(){super(...arguments),this._views=new Set}init(e){return this._viewMgr=e,this}add(e){this._views.add(e)}remove(e){this._views.delete(e)}destroy(){for(const e of this._views)this._viewMgr.hide(e)}}const MoyeViewTag="MoyeView",viewLoadLock="MoyeViewLoadLock";class MoyeViewMgr extends Entity{constructor(){super(...arguments),this._views=new Map,this._type2Names=new Map,this._showingViews=new Set,this._hideViews=new Set,this._viewCfgs=new Map,this._layers=new Map,this._checkInterval=5e3}awake(){MoyeViewMgr.inst=this}destroy(){null!=this._checkTimerId&&(TimerMgr.get().remove(this._checkTimerId),this._checkTimerId=null),MoyeViewMgr.inst=null}init(e,t){return null!=this._uiRoot?coreError("MoyeView","MoyeViewMgr is already inited"):(this._uiRoot=e,this._globalViewCfgType=t,this.reload(),this._checkTimerId=TimerMgr.get().newRepeatedTimer(this._checkInterval,this.check.bind(this)),this)}async show(e,t){let i;if(i="string"==typeof e?e:this._type2Names.get(e),JsHelper.isNullOrEmpty(i))return void coreError("MoyeView","MoyeView name is null or empty, name={0}",i);const s=await CoroutineLock.get().wait(viewLoadLock,i);coreLog("MoyeView","show view, name={0}",i);try{if(null==this._uiRoot)throw new Error("MoyeViewMgr is not inited");if(this._showingViews.has(i)){return this._views.get(i)}if(this._views.has(i)){const e=this._views.get(i);return await this.enterViewShow(e,t),e}const e=this._viewCfgs.get(i),s=await e.load(i),r=this.getLayerNode(e.layer);s.parent=r;const n=this.addCom(e.viewType);return n.node=s,n.layer=e.layer,n.viewName=i,n.onLoad?.(),n._viewMgr=this,this._views.set(i,n),await this.enterViewShow(n,t),n}catch(e){coreError("MoyeView","show view errr, {0}",e)}finally{s.dispose()}}async hide(e){const t=await CoroutineLock.get().wait(viewLoadLock,e);coreLog("MoyeView","hide view, name={0}",e);try{if(!this._showingViews.has(e))return;const t=this._views.get(e);await this.enterViewHide(t)}catch(e){coreError("MoyeView","hide view errr, {0}",e)}finally{t.dispose()}}reload(){const e=DecoratorCollector.inst.get("ViewDecorator");for(const t of e){const e=t[0],i=t[1],s=t[2],r=t[3];if(this._viewCfgs.has(i))continue;let n;n=null!=r?new r:new this._globalViewCfgType,n.layer=s,n.name=i,n.viewType=e,n.cleanEntitys=new Set,this._type2Names.set(e,i),this._viewCfgs.set(i,n)}}check(){const e=TimeInfo.get().clientNow();for(const t of this._hideViews){e>=this._viewCfgs.get(t).expireTime&&this.enterViewDestroy(this._views.get(t))}}getLayerNode(e){let t=this._layers.get(e);if(null==t){t=new Node,t.name=ViewLayer[e],t.parent=this._uiRoot,t.setSiblingIndex(e),this._layers.set(e,t);const i=this._uiRoot.getComponent(UITransform).contentSize;t.addComponent(UITransform).setContentSize(i)}return t}addToCleanCom(e,t){if(null==e)return;let i=e.getCom(ViewCleanCom);const s=this._viewCfgs.get(t);null==i&&(i=e.addCom(ViewCleanCom).init(this)),s.cleanEntitys.add(i),i.add(t)}async enterViewShow(e,t){e.node.active=!0,e.bringToFront();const i=this._viewCfgs.get(e.viewName);if(null!=i.doShowAnimation){const t=Task.create();i.doShowAnimation(e,t),await t}this._showingViews.add(e.viewName),this._hideViews.delete(e.viewName),this.addToCleanCom(t,e.viewName),e.onShow?.()}async enterViewHide(e){const t=this._viewCfgs.get(e.viewName);if(null!=t.doHideAnimation){const i=Task.create();t.doHideAnimation(e,i),await i}e.onHide?.(),e.node.active=!1,this._hideViews.add(e.viewName),this._showingViews.delete(e.viewName);for(const i of t.cleanEntitys)i.remove(e.viewName);t.cleanEntitys.clear(),t.expireTime=TimeInfo.get().clientNow()+t.expire}enterViewDestroy(e){e._realDispose(),e.node.destroy(),this._views.delete(e.viewName),this._hideViews.delete(e.viewName);this._viewCfgs.get(e.viewName).destroy()}}class AMoyeView extends Entity{_realDispose(){super.dispose()}dispose(){this._viewMgr.hide(this.viewName)}bringToFront(){this.node.setSiblingIndex(-1)}}var __decorate$2=function(e,t,i,s){var r,n=arguments.length,o=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,s);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(n<3?r(o):n>3?r(t,i,o):r(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o};const{ccclass:ccclass$2,property:property$2,menu:menu$2}=_decorator;let SizeFollow=class extends Component{constructor(){super(...arguments),this._heightFollow=!0,this._widthFollow=!0,this._heightOffset=0,this._widthOffset=0,this._changeSize=new Size}get target(){return this._target}set target(e){this._target=e,this.updateSizeOffset()}set heightFollow(e){this._heightFollow=e,this.updateSizeOffset()}get heightFollow(){return this._heightFollow}set widthFollow(e){this._widthFollow=e,this.updateSizeOffset()}get widthFollow(){return this._widthFollow}onLoad(){null!=this._target&&this._target.node.on(NodeEventType.SIZE_CHANGED,this.onTargetSizeChange,this)}onDestroy(){null!=this._target&&(this._target.isValid?(this._target.node.off(NodeEventType.SIZE_CHANGED,this.onTargetSizeChange,this),this._target=null):this._target=null)}onTargetSizeChange(){const e=this.node.getComponent(UITransform),t=this._target;this._changeSize.set(e.contentSize),this._widthFollow&&(this._changeSize.width=Math.max(0,t.width+this._widthOffset)),this._heightFollow&&(this._changeSize.height=Math.max(0,t.height+this._heightOffset)),e.setContentSize(this._changeSize)}updateSizeOffset(){if(null==this._target)return;const e=this.node.getComponent(UITransform),t=this._target;if(this._widthFollow){const i=e.width,s=t.width;this._widthOffset=i-s}if(this._heightFollow){const i=e.height,s=t.height;this._heightOffset=i-s}}};__decorate$2([property$2({type:UITransform})],SizeFollow.prototype,"target",null),__decorate$2([property$2({type:UITransform})],SizeFollow.prototype,"_target",void 0),__decorate$2([property$2],SizeFollow.prototype,"heightFollow",null),__decorate$2([property$2],SizeFollow.prototype,"_heightFollow",void 0),__decorate$2([property$2],SizeFollow.prototype,"widthFollow",null),__decorate$2([property$2],SizeFollow.prototype,"_widthFollow",void 0),__decorate$2([property$2({type:CCFloat})],SizeFollow.prototype,"_heightOffset",void 0),__decorate$2([property$2({type:CCFloat})],SizeFollow.prototype,"_widthOffset",void 0),SizeFollow=__decorate$2([ccclass$2("SizeFollow"),menu$2("moye/SizeFollow")],SizeFollow);var __decorate$1=function(e,t,i,s){var r,n=arguments.length,o=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,s);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(n<3?r(o):n>3?r(t,i,o):r(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o};const{ccclass:ccclass$1,property:property$1,executeInEditMode:executeInEditMode,menu:menu$1}=_decorator;var WidgetBase,WidgetDirection;!function(e){e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.TOP=3]="TOP",e[e.BOTTOM=4]="BOTTOM"}(WidgetBase||(WidgetBase={})),function(e){e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.TOP=3]="TOP",e[e.BOTTOM=4]="BOTTOM",e[e.LEFT_EXTEND=5]="LEFT_EXTEND",e[e.RIGHT_EXTEND=6]="RIGHT_EXTEND",e[e.TOP_EXTEND=7]="TOP_EXTEND",e[e.BOTTOM_EXTEND=8]="BOTTOM_EXTEND"}(WidgetDirection||(WidgetDirection={}));let CTWidget=class extends Component{constructor(){super(...arguments),this._targetDir=WidgetDirection.TOP,this._dir=WidgetDirection.TOP,this.visibleOffset=0,this._isVertical=!0,this._distance=0,this._changePos=new Vec3(0,0,0),this._targetOldPos=new Vec3(0,0,0),this._targetOldSize=0,this._selfOldPos=new Vec3(0,0,0),this._selfOldSize=0}get target(){return this._target}set target(e){this._target=e,this.unregisterEvt(),this.registerEvt(),this.updateData()}set targetDir(e){if(EDITOR){if(e==WidgetDirection.LEFT||e==WidgetDirection.RIGHT){switch(this._dir){case WidgetDirection.TOP:case WidgetDirection.TOP_EXTEND:case WidgetDirection.BOTTOM:case WidgetDirection.BOTTOM_EXTEND:this._dir=WidgetDirection.LEFT}this._isVertical=!1}else{switch(this._dir){case WidgetDirection.LEFT:case WidgetDirection.LEFT_EXTEND:case WidgetDirection.RIGHT:case WidgetDirection.RIGHT_EXTEND:this._dir=WidgetDirection.TOP}this._isVertical=!0}this._targetDir=e,this.updateData()}}get targetDir(){return this._targetDir}set dir(e){if(EDITOR){switch(e){case WidgetDirection.LEFT:case WidgetDirection.LEFT_EXTEND:case WidgetDirection.RIGHT:case WidgetDirection.RIGHT_EXTEND:switch(this._targetDir){case WidgetDirection.TOP:case WidgetDirection.BOTTOM:this._targetDir=WidgetDirection.LEFT}this._isVertical=!1;break;case WidgetDirection.TOP:case WidgetDirection.TOP_EXTEND:case WidgetDirection.BOTTOM:case WidgetDirection.BOTTOM_EXTEND:switch(this._targetDir){case WidgetDirection.LEFT:case WidgetDirection.RIGHT:this._targetDir=WidgetDirection.TOP}this._isVertical=!0}this._dir=e,this.updateData()}}get dir(){return this._dir}onEnable(){EDITOR&&(this.registerEvt(),this.updateData())}onDisable(){EDITOR&&this.unregisterEvt()}onLoad(){this._trans=this.node.getComponent(UITransform),EDITOR||this.registerEvt()}onDestroy(){EDITOR||(this.unregisterEvt(),this._trans=null,this._target=null,this._changePos=null)}registerEvt(){this._target&&(EDITOR&&(this._target.node.on(NodeEventType.ANCHOR_CHANGED,this.updateData,this),this.node.on(NodeEventType.TRANSFORM_CHANGED,this.updateData,this),this.node.on(NodeEventType.SIZE_CHANGED,this.updateData,this)),this._target.node.on(NodeEventType.SIZE_CHANGED,this.onTargetChange,this),this._target.node.on(NodeEventType.TRANSFORM_CHANGED,this.onTargetChange,this),this._target.node.on(NodeEventType.ACTIVE_IN_HIERARCHY_CHANGED,this.onTargetChange,this))}unregisterEvt(){this._target&&this._target.isValid&&(EDITOR&&(this._target.node.off(NodeEventType.ANCHOR_CHANGED,this.updateData,this),this.node.off(NodeEventType.TRANSFORM_CHANGED,this.updateData,this),this.node.off(NodeEventType.SIZE_CHANGED,this.updateData,this)),this._target.node.off(NodeEventType.SIZE_CHANGED,this.onTargetChange,this),this._target.node.off(NodeEventType.TRANSFORM_CHANGED,this.onTargetChange,this),this._target.node.off(NodeEventType.ACTIVE_IN_HIERARCHY_CHANGED,this.onTargetChange,this))}updateData(){if(null!=this._target)switch(this._dir){case WidgetDirection.TOP:case WidgetDirection.BOTTOM:case WidgetDirection.LEFT:case WidgetDirection.RIGHT:this.updateDistance();break;case WidgetDirection.TOP_EXTEND:case WidgetDirection.BOTTOM_EXTEND:case WidgetDirection.LEFT_EXTEND:case WidgetDirection.RIGHT_EXTEND:this.updateTargetPos()}}onTargetChange(){if(null!=this._target)switch(this._dir){case WidgetDirection.TOP:case WidgetDirection.BOTTOM:case WidgetDirection.LEFT:case WidgetDirection.RIGHT:this.updatePos();break;case WidgetDirection.TOP_EXTEND:case WidgetDirection.BOTTOM_EXTEND:case WidgetDirection.LEFT_EXTEND:case WidgetDirection.RIGHT_EXTEND:this.updateSize()}}updateSize(){if(this._isVertical){const e=this._targetOldPos.y-this._target.node.position.y;let t=this._target.height-this._targetOldSize;const i=this._trans.anchorY;this._changePos.set(this._selfOldPos),this._target.getComponent(Label)&&!this._target.node.active&&(t=this._targetOldSize);const s=e+t;this._trans.height=this._selfOldSize+s,this._dir==WidgetDirection.TOP_EXTEND?this.node.setPosition(this._changePos):this._dir==WidgetDirection.BOTTOM_EXTEND&&(this._changePos.y-=s*(1-i),this.node.setPosition(v3(this._changePos)))}}updatePos(){const e=this._trans,t=this._target;let i=this.getPos(t,this._targetDir)-this._distance;if(this._changePos.set(this.node.worldPosition),this._isVertical){switch(this._dir){case WidgetDirection.TOP:i-=e.height*(1-e.anchorY);break;case WidgetDirection.BOTTOM:i+=e.height*e.anchorY;break}this._changePos.y=i}else this._changePos.x=i;this.node.worldPosition=this._changePos}updateTargetPos(){EDITOR&&null==this._changePos&&(console.error("编辑器数据错乱, 请重新添加本组件"),this._changePos=v3()),this.target.node.getPosition(this._targetOldPos),this.node.getPosition(this._selfOldPos),this._isVertical?(this._selfOldSize=this._trans.height,this._targetOldSize=this._target.height):(this._selfOldSize=this._trans.width,this._targetOldSize=this._target.height)}updateDistance(){if(!EDITOR)return;if(null==this._target)return;const e=this.node.getComponent(UITransform),t=this._target,i=this.getPos(e,this._dir),s=this.getPos(t,this._targetDir);this._distance=s-i}getPos(e,t){if(this._isVertical){let i=e.node.worldPosition.y;const s=e.height,r=e.anchorY;switch(t){case WidgetDirection.TOP:case WidgetDirection.TOP_EXTEND:return e.node.active||(i=i-s-this.visibleOffset),i+s*(1-r);case WidgetDirection.BOTTOM:case WidgetDirection.BOTTOM_EXTEND:return e.node.active||(i=i+s+this.visibleOffset),i-s*r}}else{const i=e.node.worldPosition.x,s=e.width,r=e.anchorX;switch(t){case WidgetDirection.LEFT:return i-s*r;case WidgetDirection.RIGHT:return i+s*(1-r)}}}};__decorate$1([property$1({type:UITransform})],CTWidget.prototype,"target",null),__decorate$1([property$1({type:UITransform})],CTWidget.prototype,"_target",void 0),__decorate$1([property$1({type:Enum(WidgetBase)})],CTWidget.prototype,"targetDir",null),__decorate$1([property$1],CTWidget.prototype,"_targetDir",void 0),__decorate$1([property$1({type:Enum(WidgetDirection)})],CTWidget.prototype,"dir",null),__decorate$1([property$1],CTWidget.prototype,"_dir",void 0),__decorate$1([property$1({type:CCFloat})],CTWidget.prototype,"visibleOffset",void 0),__decorate$1([property$1],CTWidget.prototype,"_isVertical",void 0),__decorate$1([property$1],CTWidget.prototype,"_distance",void 0),__decorate$1([property$1],CTWidget.prototype,"_changePos",void 0),__decorate$1([property$1],CTWidget.prototype,"_targetOldPos",void 0),__decorate$1([property$1],CTWidget.prototype,"_targetOldSize",void 0),__decorate$1([property$1],CTWidget.prototype,"_selfOldPos",void 0),__decorate$1([property$1],CTWidget.prototype,"_selfOldSize",void 0),CTWidget=__decorate$1([ccclass$1("CTWidget"),menu$1("moye/CTWidget"),executeInEditMode],CTWidget);const RoundBoxAssembler={GetIndexBuffer(e){const t=[0,1,2,2,3,0,4,5,6,6,7,4,8,9,10,10,11,8];let i=12;const s=function(s,r,n){let o=r;for(let r=0;r<e.segments-1;r++){const e=i;i++,t.push(s,o,e),o=e}t.push(s,o,n)};return e.leftBottom&&s(3,4,0),e.leftTop&&s(2,1,5),e.rightTop&&s(9,6,10),e.rightBottom&&s(8,11,7),t},createData(e){const t=e.requestRenderData();let i=0;i+=e.leftBottom?1:0,i+=e.leftTop?1:0,i+=e.rightTop?1:0,i+=e.rightBottom?1:0;const s=12+(e.segments-1)*i;t.dataLength=s,t.resize(s,18+3*e.segments*i);const r=RoundBoxAssembler.GetIndexBuffer(e);return t.chunk.setIndexBuffer(r),t},updateRenderData(e){const t=e.spriteFrame;dynamicAtlasManager.packToDynamicAtlas(e,t),this.updateUVs(e);const i=e.renderData;i&&t&&(i.vertDirty&&this.updateVertexData(e),i.updateRenderData(e,t))},updateWorldVerts(e,t){const i=e.renderData,s=t.vb,r=i.data,n=e.node.worldMatrix,o=i.floatStride;let a=0;const c=r.length;for(let e=0;e<c;e++){const t=r[e],i=t.x,c=t.y;let l=n.m03*i+n.m07*c+n.m15;l=l?1/l:1,a=e*o,s[a+0]=(n.m00*i+n.m04*c+n.m12)*l,s[a+1]=(n.m01*i+n.m05*c+n.m13)*l,s[a+2]=(n.m02*i+n.m06*c+n.m14)*l}},fillBuffers(e){if(null===e)return;const t=e.renderData,i=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVerts(e,i),t.vertDirty=!1),i.bufferId;const s=i.vertexOffset,r=i.meshBuffer,n=i.meshBuffer.iData;let o=r.indexOffset;const a=s,c=RoundBoxAssembler.GetIndexBuffer(e);for(let e=0;e<t.indexCount;e++)n[o++]=a+c[e];r.indexOffset+=t.indexCount},updateVertexData(e){const t=e.renderData;if(!t)return;const i=e.node._uiProps.uiTransformComp,s=t.data,r=i.width,n=i.height,o=i.anchorX*r,a=i.anchorY*n,c=0-o,l=r-o,h=n-a,d=0-a,p=c+e.radius,u=d+e.radius,_=h-e.radius,g=l-e.radius;s[0].x=c,s[0].y=e.leftBottom?u:d,s[1].x=c,s[1].y=e.leftTop?_:h,s[2].x=p,s[2].y=e.leftTop?_:h,s[3].x=p,s[3].y=e.leftBottom?u:d,s[4].x=p,s[4].y=d,s[5].x=p,s[5].y=h,s[6].x=g,s[6].y=h,s[7].x=g,s[7].y=d,s[8].x=g,s[8].y=e.rightBottom?u:d,s[9].x=g,s[9].y=e.rightTop?_:h,s[10].x=l,s[10].y=e.rightTop?_:h,s[11].x=l,s[11].y=e.rightBottom?u:d;let m=12;const y=function(t,i){for(let r=1;r<e.segments;r++){const n=i*Math.PI/180-r/e.segments*.5*Math.PI;s[m].x=t.x+Math.cos(n)*e.radius,s[m].y=t.y+Math.sin(n)*e.radius,m++}};e.leftBottom&&y(s[3],270),e.leftTop&&y(s[2],180),e.rightTop&&y(s[9],90),e.rightBottom&&y(s[8],0),t.vertDirty=!0},updateUVs(e){if(!e.spriteFrame)return;const t=e.renderData,i=t.chunk.vb,s=e.spriteFrame.uv,r=s[0],n=s[1],o=s[2],a=s[5],c=Math.abs(o-r),l=a-n,h=e.node._uiProps.uiTransformComp,d=t.data,p=h.width,u=h.height,_=h.anchorX*p,g=h.anchorY*u;for(let e=0;e<t.dataLength;e++)i[e*t.floatStride+3]=r+(d[e].x+_)/p*c,i[e*t.floatStride+4]=n+(d[e].y+g)/u*l},updateColor(e){const t=e.renderData,i=t.chunk.vb;let s=5;const r=e.color,n=r.r/255,o=r.g/255,a=r.b/255,c=r.a/255;for(let e=0;e<t.dataLength;e++,s+=t.floatStride)i[s]=n,i[s+1]=o,i[s+2]=a,i[s+3]=c}};var __decorate=function(e,t,i,s){var r,n=arguments.length,o=n<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,i,s);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(n<3?r(o):n>3?r(t,i,o):r(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o};const{ccclass:ccclass,property:property,type:type,menu:menu}=_decorator;var EventType;!function(e){e.SPRITE_FRAME_CHANGED="spriteframe-changed"}(EventType||(EventType={}));let RoundBoxSprite=class extends UIRenderer{constructor(){super(...arguments),this._sizeMode=Sprite.SizeMode.TRIMMED,this._atlas=null,this._segments=10,this._radius=20,this._spriteFrame=null,this._leftTop=!0,this._rightTop=!0,this._leftBottom=!0,this._rightBottom=!0}get sizeMode(){return this._sizeMode}set sizeMode(e){this._sizeMode!==e&&(this._sizeMode=e,e!==Sprite.SizeMode.CUSTOM&&this._applySpriteSize())}get spriteAtlas(){return this._atlas}set spriteAtlas(e){this._atlas!==e&&(this._atlas=e)}get segments(){return this._segments}set segments(e){this._segments=e,this._renderData=null,this._flushAssembler()}get radius(){return this._radius}set radius(e){this._radius=e,this._updateUVs(),this.markForUpdateRenderData(!0)}get spriteFrame(){return this._spriteFrame}set spriteFrame(e){if(this._spriteFrame===e)return;const t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(),this._applySpriteFrame(t),EDITOR&&this.node.emit(EventType.SPRITE_FRAME_CHANGED,this)}get leftTop(){return this._leftTop}set leftTop(e){this._leftTop=e,this.resetAssembler()}get rightTop(){return this._rightTop}set rightTop(e){this._rightTop=e,this.resetAssembler()}get leftBottom(){return this._leftBottom}set leftBottom(e){this._leftBottom=e,this.resetAssembler()}get rightBottom(){return this._rightBottom}set rightBottom(e){this._rightBottom=e,this.resetAssembler()}onLoad(){this._flushAssembler()}__preload(){this.changeMaterialForDefine(),super.__preload(),EDITOR&&(this._resized(),this.node.on(NodeEventType.SIZE_CHANGED,this._resized,this))}onEnable(){super.onEnable(),this._activateMaterial();this._spriteFrame&&this._updateUVs()}onDestroy(){EDITOR&&this.node.off(NodeEventType.SIZE_CHANGED,this._resized,this),super.onDestroy()}changeSpriteFrameFromAtlas(e){if(!this._atlas)return void console.warn("SpriteAtlas is null.");const t=this._atlas.getSpriteFrame(e);this.spriteFrame=t}changeMaterialForDefine(){let e;const t=this._instanceMaterialType;this._spriteFrame&&(e=this._spriteFrame.texture);let i=!1;if(e instanceof cclegacy.TextureBase){const t=e.getPixelFormat();i=t===cclegacy.TextureBase.PixelFormat.RGBA_ETC1||t===cclegacy.TextureBase.PixelFormat.RGB_A_PVRTC_4BPPV1||t===cclegacy.TextureBase.PixelFormat.RGB_A_PVRTC_2BPPV1}this._instanceMaterialType=i?InstanceMaterialType.USE_ALPHA_SEPARATED:InstanceMaterialType.ADD_COLOR_AND_TEXTURE,t!==this._instanceMaterialType&&this.updateMaterial()}_updateBuiltinMaterial(){let e=super._updateBuiltinMaterial();if(this.spriteFrame&&this.spriteFrame.texture instanceof RenderTexture){const t={SAMPLE_FROM_RT:!0,...e.passes[0].defines},i=new Material;i.initialize({effectAsset:e.effectAsset,defines:t}),e=i}return e}_render(e){e.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)}_canRender(){if(!super._canRender())return!1;const e=this._spriteFrame;return!(!e||!e.texture)}resetAssembler(){this._assembler=null,this._flushAssembler()}_flushAssembler(){const e=RoundBoxAssembler;this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateRenderData(this),this._updateColor())}_applySpriteSize(){if(this._spriteFrame){if(BUILD||!this._spriteFrame)if(Sprite.SizeMode.RAW===this._sizeMode){const e=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(e)}else if(Sprite.SizeMode.TRIMMED===this._sizeMode){const e=this._spriteFrame.rect;this.node._uiProps.uiTransformComp.setContentSize(e.width,e.height)}this.markForUpdateRenderData(!0),this._assembler.updateRenderData(this)}}_resized(){if(EDITOR&&this._spriteFrame){const e=this.node._uiProps.uiTransformComp.contentSize;let t=e.width,i=e.height;if(this._sizeMode===Sprite.SizeMode.RAW){const e=this._spriteFrame.originalSize;t=e.width,i=e.height}else if(this._sizeMode===Sprite.SizeMode.TRIMMED){const e=this._spriteFrame.rect;t=e.width,i=e.height}t===e.width&&i===e.height||(this._sizeMode=Sprite.SizeMode.CUSTOM)}}_activateMaterial(){const e=this._spriteFrame,t=this.getRenderMaterial(0);e&&t&&this.markForUpdateRenderData(),this.renderData&&(this.renderData.material=t)}_updateUVs(){this._assembler&&this._assembler.updateUVs(this)}_applySpriteFrame(e){const t=this._spriteFrame;let i=!1;t&&(e&&e.texture===t.texture||(i=!0),i&&(this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize())}};__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"_sizeMode",void 0),__decorate([type(Sprite.SizeMode)],RoundBoxSprite.prototype,"sizeMode",null),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"_atlas",void 0),__decorate([type(SpriteAtlas)],RoundBoxSprite.prototype,"spriteAtlas",null),__decorate([property({type:CCInteger,serializable:!0})],RoundBoxSprite.prototype,"_segments",void 0),__decorate([property({type:CCInteger,serializable:!0,min:1})],RoundBoxSprite.prototype,"segments",null),__decorate([property({type:CCFloat,serializable:!0})],RoundBoxSprite.prototype,"_radius",void 0),__decorate([property({type:CCFloat,serializable:!0,min:0})],RoundBoxSprite.prototype,"radius",null),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"_spriteFrame",void 0),__decorate([type(SpriteFrame)],RoundBoxSprite.prototype,"spriteFrame",null),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"_leftTop",void 0),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"leftTop",null),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"_rightTop",void 0),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"rightTop",null),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"_leftBottom",void 0),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"leftBottom",null),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"_rightBottom",void 0),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"rightBottom",null),RoundBoxSprite=__decorate([ccclass("RoundBoxSprite"),menu("moye/RoundBoxSprite")],RoundBoxSprite);export{AEvent,AEventHandler,AMoyeView,AfterCreateClientScene,AfterCreateCurrentScene,AfterProgramInit,AfterProgramStart,AfterSingletonAdd,AssetOperationHandle,BeforeProgramInit,BeforeProgramStart,BeforeSingletonAdd,BundleAsset,CTWidget,CancellationToken,CancellationTokenTag,CoroutineLock,CoroutineLockItem,CoroutineLockTag,DecoratorCollector,Entity,EntityCenter,EventDecorator,EventDecoratorType,EventHandlerTag,EventSystem,Game,IdGenerator,IdStruct,InstanceIdStruct,JsHelper,Logger,MoyeAssets,MoyeViewMgr,ObjectPool,Options,Program,RecycleObj,Root,RoundBoxSprite,Scene,SceneFactory,SceneRefCom,SceneType,Singleton,SizeFollow,Task,TimeHelper,TimeInfo,TimerMgr,ViewDecorator,ViewDecoratorType,ViewLayer,error,log,safeCall,warn};