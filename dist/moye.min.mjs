import{_decorator,Component,director,SpriteFrame,Texture2D,instantiate,native,assetManager,UITransform,CCFloat,Size,NodeEventType,Enum,Vec3,Label,v3,dynamicAtlasManager,Sprite,SpriteAtlas,CCInteger,UIRenderer,cclegacy,InstanceMaterialType,RenderTexture,Material}from"cc";import{NATIVE,EDITOR,BUILD}from"cc/env";class Singleton{constructor(){this._isDisposed=!1}static getInst(){const t=this;if(null==t._inst)throw new Error(`Singleton is not initialized or destroyed, name is ${t.name}`);return t._inst}get isDisposed(){return this._isDisposed}dispose(){this._onPreDestroy()}_onPreDestroy(){this._isDisposed||(this.destroy&&this.destroy(),Singleton._inst=null,this._isDisposed=!0)}}class TimeInfo extends Singleton{awake(){this.serverMinusClientTime=0}clientNow(){return Date.now()}serverNow(){return this.clientNow()+this.serverMinusClientTime}}class JsHelper{static getMethodName(){const t=(new Error).stack.split("at ")[2],e=t.indexOf(" ");return t.substring(0,e)}static getRootDirName(t){return t.split("/")[0]}static sleep(t){return new Promise((e=>setTimeout(e,t)))}static isNullOrEmpty(t){return null==t||(0==t.length||void 0)}static getStringHashCode(t){let e=5381,s=t.length;for(;s;)e=33*e^t.charCodeAt(--s);return e>>>0}static modeString(t,e){return this.getStringHashCode(t)%e}static formatStr(t,...e){if("string"!=typeof t){const t=new Error("formatStr args[0] is not string");return t.name+t.stack}if(0==e.length)return t;return t.replace(/\{\{|\}\}|\{(\d+)\}/g,(function(t,s){return"{{"==t?"{":"}}"==t?"}":e[s]}))}}class Options extends Singleton{constructor(){super(...arguments),this.isServer=!1,this.logLevel=1,this.develop=!0}}class LoggerDefault{log(t){console.log(t)}warn(t){console.warn(t)}error(t){console.error(t)}}class Logger extends Singleton{set iLog(t){this._logInst=t}get _iLog(){return this._logInst||(this._logInst=new LoggerDefault,this._logInst.warn("not set iLog, use default logger")),this._logInst}log(t,...e){if(this.checkLogLevel(Logger.LOG_LEVEL)){const s=JsHelper.formatStr(t,...e);this._iLog.log(s)}}warn(t,...e){if(this.checkLogLevel(Logger.WARN_LEVEL)){const s=JsHelper.formatStr(t,...e);this._iLog.warn(s)}}error(t,...e){const s=JsHelper.formatStr(t,...e);this._iLog.error(s)}checkLogLevel(t){return Options.getInst().logLevel<=t}coreLog(t){this._iLog.log(t)}coreWarn(t){this._iLog.warn(t)}coreError(t){this._iLog.error(t)}}function log(t,...e){Logger.getInst().log(t,...e)}function warn(t,...e){Logger.getInst().warn(t,...e)}function error(t,...e){Logger.getInst().error(t,...e)}function coreLog(t,e,...s){const i=`[${t}]: ${JsHelper.formatStr(e,...s)}`;try{Logger.getInst().coreLog(i)}catch(t){console.log(i)}}function coreWarn(t,e,...s){const i=`[${t}]: ${JsHelper.formatStr(e,...s)}`;try{Logger.getInst().coreWarn(i)}catch(t){console.warn(i)}}function coreError(t,e,...s){const i=`[${t}]: ${JsHelper.formatStr(e,...s)}`;try{Logger.getInst().coreError(i)}catch(t){console.error(i)}}Logger.LOG_LEVEL=1,Logger.WARN_LEVEL=2;const IdGeneratorTag="IdGenerator",timeBit$1=30n,processBit=14n,valueBit$1=20n,powTimeBit$1=2n**timeBit$1-1n,powProcessBit=2n**processBit-1n,powValueBit$1=2n**valueBit$1-1n,epoch$1=new Date(2023,4,1).getTime();class IdStruct{static get inst(){return null==IdStruct._inst&&(IdStruct._inst=new IdStruct),IdStruct._inst}static generate(){0==this._lastTime&&(this._lastTime=this.timeSinceEpoch(),this._lastTime<=0&&(coreWarn("IdGenerator","{0}: lastTime less than 0: {1}",(new this).constructor.name,this._lastTime),this._lastTime=1));const t=this.timeSinceEpoch();t>this._lastTime?(this._lastTime=t,this._idCount=0):(++this._idCount,this._idCount>powValueBit$1&&(++this._lastTime,this._idCount=0,coreError("IdGenerator","{0}: idCount per sec overflow: {1} {2}",(new this).constructor.name,t,this._lastTime)));const e=IdStruct.inst;return e.init(this._lastTime,1,this._idCount),e.result}static convertToId(t,e,s){return IdStruct.inst.init(t,e,s).result}static parseId(t){return IdStruct.inst.initById(t)}static timeSinceEpoch(){const t=(TimeInfo.getInst().clientNow()-epoch$1)/1e3;return Math.floor(t)}initById(t){return this.result=t,this.time=t&powTimeBit$1,t>>=timeBit$1,this.process=t&powProcessBit,t>>=processBit,this.value=t&powValueBit$1,this}init(t,e,s){return this.time=BigInt(t),this.process=BigInt(e),this.value=BigInt(s),this.updateResult(),this}updateResult(){this.result=this.value,this.result<<=processBit,this.result|=this.process,this.result<<=timeBit$1,this.result|=this.time}}IdStruct._lastTime=0,IdStruct._idCount=0;const timeBit=32n,valueBit=32n,powTimeBit=2n**timeBit-1n,powValueBit=2n**valueBit-1n,epoch=new Date(2023,4,1).getTime();class InstanceIdStruct{static get inst(){return null==InstanceIdStruct._inst&&(InstanceIdStruct._inst=new InstanceIdStruct),InstanceIdStruct._inst}static generate(){0==this._lastTime&&(this._lastTime=this.timeSinceEpoch(),this._lastTime<=0&&(coreWarn("IdGenerator","{0}: lastTime less than 0: {1}",(new this).constructor.name,this._lastTime),this._lastTime=1));const t=this.timeSinceEpoch();t>this._lastTime?(this._lastTime=t,this._idCount=0):(++this._idCount,this._idCount>powValueBit&&(++this._lastTime,this._idCount=0,coreError("IdGenerator","{0}: idCount per sec overflow: {1} {2}",(new this).constructor.name,t,this._lastTime)));const e=InstanceIdStruct.inst;return e.init(this._lastTime,this._idCount),e.result}static convertToId(t,e){return InstanceIdStruct.inst.init(t,e).result}static parseId(t){return InstanceIdStruct.inst.initById(t)}static timeSinceEpoch(){const t=(TimeInfo.getInst().clientNow()-epoch)/1e3;return Math.floor(t)}initById(t){return this.result=t,this.time=t&powTimeBit,t>>=timeBit,this.value=t&powValueBit,this}init(t,e){return this.time=BigInt(t),this.value=BigInt(e),this.updateResult(),this}updateResult(){this.result=this.value,this.result<<=timeBit,this.result|=this.time}}InstanceIdStruct._lastTime=0,InstanceIdStruct._idCount=0;class IdGenerator extends Singleton{generateInstanceId(){return InstanceIdStruct.generate()}generateId(){return IdStruct.generate()}}class ObjectPool extends Singleton{constructor(){super(...arguments),this._pool=new Map}fetch(t){const e=this._pool.get(t);return e?0===e.length?new t:e.shift():new t}recycle(t){const e=t.constructor;let s=this._pool.get(e);s||(s=[],this._pool.set(e,s)),s.length>1e3?console.warn(`pool ${e.name} is too large`):s.push(t)}}class EntityCenter extends Singleton{constructor(){super(...arguments),this._allEntities=new Map}add(t){this._allEntities.set(t.instanceId,t)}remove(t){this._allEntities.delete(t)}get(t){return this._allEntities.get(t)}}var InstanceQueueIndex,EntityStatus,SceneType;!function(t){t[t.NONE=-1]="NONE",t[t.UPDATE=0]="UPDATE",t[t.LATE_UPDATE=1]="LATE_UPDATE",t[t.MAX=2]="MAX"}(InstanceQueueIndex||(InstanceQueueIndex={}));class EntityLifiCycleMgr extends Singleton{constructor(){super(...arguments),this._queues=new Array(InstanceQueueIndex.MAX)}awake(){for(let t=0;t<this._queues.length;t++)this._queues[t]=[]}registerSystem(t){t.update&&this._queues[InstanceQueueIndex.UPDATE].push(t.instanceId),t.lateUpdate&&this._queues[InstanceQueueIndex.LATE_UPDATE].push(t.instanceId)}awakeComEvent(t){t.awake()}destroyComEvent(t){t.destroy()}update(){const t=this._queues[InstanceQueueIndex.UPDATE],e=EntityCenter.getInst();for(let s=t.length-1;s>=0;s--){const i=t[s],r=e.get(i);r?r.isDisposed?t.splice(s,1):r.update():t.splice(s,1)}}lateUpdate(){const t=this._queues[InstanceQueueIndex.LATE_UPDATE],e=EntityCenter.getInst();for(let s=t.length-1;s>=0;s--){const i=t[s],r=e.get(i);r?r.isDisposed?t.splice(s,1):r.lateUpdate():t.splice(s,1)}}}!function(t){t[t.NONE=0]="NONE",t[t.IS_FROM_POOL=1]="IS_FROM_POOL",t[t.IS_REGISTER=2]="IS_REGISTER",t[t.IS_COMPONENT=4]="IS_COMPONENT",t[t.IS_CREATED=8]="IS_CREATED",t[t.IS_NEW=16]="IS_NEW"}(EntityStatus||(EntityStatus={}));class Entity{constructor(){this._status=EntityStatus.NONE}get parent(){return this._parent}set parent(t){if(null==t)throw new Error(`cant set parent null: ${this.constructor.name}`);if(t==this)throw new Error(`cant set parent self: ${this.constructor.name}`);if(null==t.domain)throw new Error(`cant set parent because parent domain is null: ${this.constructor.name} ${t.constructor.name}`);if(null!=this._parent){if(this._parent==t)throw new Error(`重复设置了Parent: ${this.constructor.name} parent: ${this._parent.constructor.name}`);this._parent.removeFromChildren(this)}this._parent=t,this.isComponent=!1,this._parent.addToChildren(this),this.domain=this.parent.domain}get domain(){return this._domain}set domain(t){if(null==t)throw new Error(`domain cant set null: ${this.constructor.name}`);if(this._domain==t)return;const e=this._domain;if(this._domain=t,null==e&&(this.instanceId=IdGenerator.getInst().generateInstanceId(),this.isRegister=!0),null!=this._children)for(const[t,e]of this._children.entries())e.domain=this._domain;if(null!=this._components)for(const[t,e]of this._components.entries())e.domain=this._domain;this.isCreated||(this.isCreated=!0)}get isDisposed(){return 0n==this.instanceId}get children(){return this._children??(this._children=ObjectPool.getInst().fetch(Map))}get components(){return this._components??(this._components=ObjectPool.getInst().fetch(Map))}get isFromPool(){return(this._status&EntityStatus.IS_FROM_POOL)==EntityStatus.IS_FROM_POOL}set isFromPool(t){t?this._status|=EntityStatus.IS_FROM_POOL:this._status&=~EntityStatus.IS_FROM_POOL}get isComponent(){return(this._status&EntityStatus.IS_COMPONENT)==EntityStatus.IS_COMPONENT}set isComponent(t){t?this._status|=EntityStatus.IS_COMPONENT:this._status&=~EntityStatus.IS_COMPONENT}get isCreated(){return(this._status&EntityStatus.IS_CREATED)==EntityStatus.IS_CREATED}set isCreated(t){t?this._status|=EntityStatus.IS_CREATED:this._status&=~EntityStatus.IS_CREATED}get isNew(){return(this._status&EntityStatus.IS_NEW)==EntityStatus.IS_NEW}set isNew(t){t?this._status|=EntityStatus.IS_NEW:this._status&=~EntityStatus.IS_NEW}get isRegister(){return(this._status&EntityStatus.IS_REGISTER)==EntityStatus.IS_REGISTER}set isRegister(t){if(this.isRegister!=t)if(t?this._status|=EntityStatus.IS_REGISTER:this._status&=~EntityStatus.IS_REGISTER,t){const t=this;EntityCenter.getInst().add(t),EntityLifiCycleMgr.getInst().registerSystem(t)}else EntityCenter.getInst().remove(this.instanceId)}set componentParent(t){if(null==t)throw new Error(`cant set parent null: ${this.constructor.name}`);if(t==this)throw new Error(`cant set parent self: ${this.constructor.name}`);if(null==t.domain)throw new Error(`cant set parent because parent domain is null: ${this.constructor.name} ${t.constructor.name}`);if(null!=this.parent){if(this.parent==t)throw new Error(`重复设置了Parent: ${this.constructor.name} parent: ${this.parent.constructor.name}`);this.parent.removeFromComponents(this)}this._parent=t,this.isComponent=!0,this._parent.addToComponents(this),this.domain=this.parent.domain}addCom(t,e){return t instanceof Entity?this.addComByEntity(t):this.addComByType(t,e)}tryAddCom(t){let e=this.getCom(t);return null==e&&(e=this.addCom(t)),e}addComByEntity(t){const e=t.constructor;if(null!=this._components&&this._components.has(e))throw new Error(`entity already has component: ${e.name}`);return t.componentParent=this,t}addComByType(t,e=!1){if(null!=this._components&&this._components.has(t))throw new Error(`entity already has component: ${t.name}`);const s=this.create(t,e);return s.id=this.id,s.componentParent=this,s.awake&&EntityLifiCycleMgr.getInst().awakeComEvent(s),s}addChild(t,e){return t instanceof Entity?this.addChildByEntity(t):this.addChildByType(t,e)}addChildWithId(t,e,s=!1){const i=this.create(t,s);return i.id=e,i.parent=this,i.awake&&EntityLifiCycleMgr.getInst().awakeComEvent(i),i}addChildByEntity(t){return t.parent=this,t}addChildByType(t,e=!1){const s=this.create(t,e);return s.id=IdGenerator.getInst().generateId(),s.parent=this,s.awake&&EntityLifiCycleMgr.getInst().awakeComEvent(s),s}create(t,e){let s;return s=e?ObjectPool.getInst().fetch(t):new t,s.isFromPool=e,s.isCreated=!0,s.isNew=!0,s.id=0n,s}removeFromChildren(t){null!=this._children&&(this._children.delete(t.id),0==this._children.size&&(ObjectPool.getInst().recycle(this._children),this._children=null))}removeFromComponents(t){null!=this._components&&(this._components.delete(t.constructor),0==this._components.size&&(ObjectPool.getInst().recycle(this._components),this._components=null))}addToComponents(t){this.components.set(t.constructor,t)}addToChildren(t){if(this.children.has(t.id))throw new Error(`entity already has child: ${t.id}`);this.children.set(t.id,t)}getCom(t){if(null==this._components)return null;const e=this._components.get(t);return e||null}removeCom(t){if(this.isDisposed)return;if(null==this._components)return;const e=this.getCom(t);null!=e&&(this.removeFromComponents(e),e.dispose())}getParent(t){return this.parent}getChild(t,e){if(null==this._children)return null;return this._children.get(e)}removeChild(t){if(null==this._children)return;const e=this._children.get(t);e&&(this._children.delete(t),e.dispose())}dispose(){if(!this.isDisposed){if(this.isRegister=!1,this.instanceId=0n,null!=this._children){for(const[t,e]of this._children.entries())e.dispose();this._children.clear(),ObjectPool.getInst().recycle(this._children),this._children=null}if(null!=this._components){for(const[t,e]of this._components.entries())e.dispose();this._components.clear(),ObjectPool.getInst().recycle(this._components),this._components=null}this.destroy&&EntityLifiCycleMgr.getInst().destroyComEvent(this),this._domain=null,null==this._parent||this._parent.isDisposed||(this.isComponent?this._parent.removeCom(this.getType()):this._parent.removeFromChildren(this)),this._parent=null,this.isFromPool&&ObjectPool.getInst().recycle(this),this._status=EntityStatus.NONE}}domainScene(){return this.domain}getType(){return this.constructor}}class Scene extends Entity{set domain(t){this._domain=t}get domain(){return this._domain}set parent(t){null!=t&&(this._parent=t,this._parent.children.set(this.id,this))}init(t){this.id=t.id,this.instanceId=t.instanceId,this.sceneType=t.sceneType,this.name=t.name,this.parent=t.parent,this.isCreated=!0,this.isNew=!0,this.domain=this,this.isRegister=!0,coreLog("scene","scene create sceneType = {0}, name = {1}, id = {2}",this.sceneType,this.name,this.id)}}!function(t){t.NONE="NONE",t.PROCESS="PROCESS",t.CLIENT="CLIENT",t.CURRENT="CURRENT"}(SceneType||(SceneType={}));class RecycleObj{constructor(){this._isRecycle=!1}static create(t){const e=ObjectPool.getInst().fetch(this);return t&&Object.assign(e,t),e._isRecycle=!0,e}dispose(){this._isRecycle&&ObjectPool.getInst().recycle(this)}}class AEvent extends RecycleObj{}class BeforeSingletonAdd extends AEvent{}class AfterSingletonAdd extends AEvent{}class BeforeProgramInit extends AEvent{}class AfterProgramInit extends AEvent{}class BeforeProgramStart extends AEvent{}class AfterProgramStart extends AEvent{}class DecoratorCollector{constructor(){this._decorators=new Map}static get inst(){return null==DecoratorCollector._inst&&(DecoratorCollector._inst=new DecoratorCollector),DecoratorCollector._inst}add(t,...e){let s=this._decorators.get(t);s||(s=[],this._decorators.set(t,s)),s.push(e)}get(t){return this._decorators.get(t)||[]}}const EventDecoratorType="EventDecoratorType";function EventDecorator(t,e){return function(s){null==e&&console.error("EventDecorator必须要传 sceneType"),DecoratorCollector.inst.add(EventDecoratorType,t,s,e)}}class EventInfo{constructor(t,e){this.eventHandler=t,this.sceneType=e}}class MoyeEventCenter{constructor(){this.allEvents=new Map}static get inst(){return null==this._inst&&(this._inst=new MoyeEventCenter,this._inst.reloadEvent()),this._inst}reloadEvent(){const t=DecoratorCollector.inst.get(EventDecoratorType);this.allEvents.clear();for(const e of t){const t=e[0],s=e[1],i=e[2];let r=this.allEvents.get(t);r||(r=[],this.allEvents.set(t,r)),r.push(new EventInfo(new s,i))}}publish(t){const e=this.allEvents.get(t.constructor);if(e){for(let s=0;s<e.length;s++){e[s].eventHandler.handle(null,t)}t.dispose()}}}class Task extends Promise{static create(t){let e;const s=new Task((t=>{e=t}));return s._resolve=e,s}setResult(t){if(!this._resolve)throw new Error("setResult but task has been disposed");this._resolve(t),this.dispose()}constructor(t){super(t)}dispose(){this._resolve=null}}class Game{static addSingleton(t,e=!0){if(Game._singletonMap.has(t))throw new Error(`already exist singleton: ${t.name}`);e&&MoyeEventCenter.inst.publish(BeforeSingletonAdd.create({singletonType:t}));const s=new t;t._inst=s,Game._singletonMap.set(t,s),Game._singletons.push(s);const i=s;return i.awake&&i.awake(),Game._destroys.push(i),i.update&&Game._updates.push(i),i.lateUpdate&&Game._lateUpdates.push(i),e&&MoyeEventCenter.inst.publish(AfterSingletonAdd.create({singletonType:t})),s}static async waitFrameFinish(){const t=Task.create();Game._frameFinishTaskQueue.push(t),await t}static update(){for(let t=0;t<Game._updates.length;t++){const e=Game._updates[t];e.isDisposed||e.update()}}static lateUpdate(){for(let t=0;t<Game._lateUpdates.length;t++){const e=Game._lateUpdates[t];e.isDisposed||e.lateUpdate()}}static frameFinishUpdate(){const t=Game._frameFinishTaskQueue.length;if(0!=t){for(let e=0;e<t;e++){Game._frameFinishTaskQueue[e].setResult()}Game._frameFinishTaskQueue=[]}}static dispose(){for(let t=Game._singletons.length-1;t>=0;t--){const e=Game._singletons[t];e.isDisposed||e._onPreDestroy()}}}Game._singletonMap=new Map,Game._singletons=[],Game._destroys=[],Game._updates=[],Game._lateUpdates=[],Game._frameFinishTaskQueue=[];class EventSystem extends Singleton{async publishAsync(t,e){const s=MoyeEventCenter.inst.allEvents.get(e.constructor);if(!s)return;const i=[];for(let r=0;r<s.length;r++){const n=s[r];n.sceneType!=t.sceneType&&"None"!=n.sceneType||i.push(n.eventHandler.handleAsync(t,e))}await Promise.all(i),e.dispose()}publish(t,e){const s=MoyeEventCenter.inst.allEvents.get(e.constructor);if(s){for(let i=0;i<s.length;i++){const r=s[i];r.sceneType!=t.sceneType&&"None"!=r.sceneType||r.eventHandler.handle(t,e)}e.dispose()}}}var __decorate$4=function(t,e,s,i){var r,n=arguments.length,o=n<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,s,i);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(o=(n<3?r(o):n>3?r(e,s,o):r(e,s))||o);return n>3&&o&&Object.defineProperty(e,s,o),o};const{ccclass:ccclass$3,property:property$3}=_decorator;let MoyeRuntime=class extends Component{start(){director.addPersistRootNode(this.node)}update(t){Game.update()}lateUpdate(t){Game.lateUpdate(),Game.frameFinishUpdate()}onDestroy(){Game.dispose()}};MoyeRuntime=__decorate$4([ccclass$3("MoyeRuntime")],MoyeRuntime);class Root extends Singleton{get scene(){return this._scene}awake(){const t=new Scene;t.init({id:0n,sceneType:SceneType.PROCESS,name:"Process",instanceId:IdGenerator.getInst().generateInstanceId()}),this._scene=t}}class TimeHelper{static clientNow(){return TimeInfo.getInst().clientNow()}static clientNowSeconds(){return Math.floor(TimeHelper.clientNow()/1e3)}static serverNow(){return TimeInfo.getInst().serverNow()}}var TimerType;TimeHelper.OneDay=864e5,TimeHelper.Hour=36e5,TimeHelper.Minute=6e4,function(t){t[t.ONCE=0]="ONCE",t[t.REPEAT=1]="REPEAT"}(TimerType||(TimerType={}));class Timer{static create(){const t=ObjectPool.getInst().fetch(Timer);return t.reset(),t.id=Timer.getId(),t}static getId(){return++this._idGenerator}reset(){this.cb=null,this.tcs=null,this.id=0,this.expireTime=0,this.interval=0}dispose(){this.reset(),ObjectPool.getInst().recycle(this)}}Timer._idGenerator=1e3;class TimerMgr extends Singleton{constructor(){super(...arguments),this._timerMap=new Map,this._timers=[]}newRepeatedTimer(t,e,s=!1){const i=Timer.create();return i.type=TimerType.REPEAT,i.cb=e,i.interval=t,i.expireTime=t+TimeHelper.clientNow(),this._timerMap.set(i.id,i),this._timers.push(i),i.id}newOnceTimer(t,e){const s=Timer.create();return s.type=TimerType.ONCE,s.cb=e,s.expireTime=t+TimeHelper.clientNow(),this._timerMap.set(s.id,s),this._timers.push(s),s.id}newFrameTimer(t){const e=Timer.create();return e.type=TimerType.REPEAT,e.cb=t,e.interval=1,e.expireTime=e.interval+TimeHelper.clientNow(),this._timerMap.set(e.id,e),this._timers.push(e),e.id}remove(t){const e=this._timerMap.get(t);return!!e&&(e.id=0,this._timerMap.delete(t),!0)}update(){const t=TimeHelper.clientNow();for(let e=this._timers.length-1;e>=0;e--){const s=this._timers[e];0!=s.id?s.expireTime>t||(null!=s.cb&&s.cb(),null!=s.tcs&&s.tcs.setResult(),s.type==TimerType.REPEAT?s.expireTime+=s.interval:this.remove(s.id)):(this._timers.splice(e,1),s.dispose())}}async waitAsync(t,e){if(t<=0)return;const s=Task.create(),i=Timer.create();let r;i.type=TimerType.ONCE,i.tcs=s,i.expireTime=t+TimeHelper.clientNow(),this._timerMap.set(i.id,i),this._timers.push(i),e&&(r=()=>{this.remove(i.id)&&s.setResult()},e.add(r));try{await s}finally{e?.remove(r),r=null}}}const CoroutineLockTag="CoroutineLock";class CoroutineLockItem{init(t){this.key=t,this.task=Task.create(),Options.getInst().develop&&this.setTimeout(6e4,"CoroutineLock timeout")}setTimeout(t,e){this.deleteTimeout(),this._timerId=TimerMgr.getInst().newOnceTimer(t,this.timeout.bind(this)),this._timeoutInfo=e}deleteTimeout(){null!=this._timerId&&(TimerMgr.getInst().remove(this._timerId),this._timerId=null)}async timeout(){coreWarn("CoroutineLock","CoroutineLock timeout key: {0}, info: {1}",this.key,this._timeoutInfo)}dispose(){null!=this.key?(this.deleteTimeout(),CoroutineLock.getInst().runNextLock(this),this.key=null,this.task=null):coreWarn("CoroutineLock","repeat dispose CoroutineLockItem")}}class CoroutineLock extends Singleton{constructor(){super(...arguments),this._lockMap=new Map}async wait(t,e){const s=`${t}_${e}`;let i=this._lockMap.get(s);i||(i=new Set,this._lockMap.set(s,i));const r=ObjectPool.getInst().fetch(CoroutineLockItem);return r.init(s),i.add(r),i.size>1?await r.task:r.task.setResult(),r}runNextLock(t){const e=this._lockMap.get(t.key);e.delete(t),ObjectPool.getInst().recycle(t);for(const t of Array.from(e.values())){t.task.setResult();break}}}class Program{static init(t){MoyeEventCenter.inst.publish(new BeforeProgramInit),Game.addSingleton(ObjectPool,!1),Game.addSingleton(Options),Game.addSingleton(Logger),Game.addSingleton(EventSystem),Game.addSingleton(TimeInfo),Game.addSingleton(TimerMgr),Game.addSingleton(CoroutineLock),Game.addSingleton(IdGenerator),Game.addSingleton(EntityCenter),Game.addSingleton(EntityLifiCycleMgr),Game.addSingleton(Root),t.addComponent(MoyeRuntime),MoyeEventCenter.inst.publish(new AfterProgramInit)}static start(){MoyeEventCenter.inst.reloadEvent(),MoyeEventCenter.inst.publish(new BeforeProgramStart),MoyeEventCenter.inst.publish(new AfterProgramStart)}}async function safeCall(t){try{return await t}catch(t){coreError("safeCall",t)}}const EventHandlerTag="EventHandler";class AEventHandler{async handleAsync(t,e){try{await this.run(t,e)}catch(t){coreError("EventHandler",t)}}handle(t,e){try{const s=this.run(t,e);s instanceof Promise&&(coreWarn("EventHandler","{0}的run方法是异步的, 请尽量不要用publish来通知",this.constructor.name),safeCall(s))}catch(t){coreError("EventHandler",t)}}}const CancellationTokenTag="CancellationToken";class CancellationToken{constructor(){this._actions=new Set}add(t){null!=t?this._actions.add(t):coreError("CancellationToken","CancellationToken add error, callback is null")}remove(t){this._actions.delete(t)}cancel(){null!=this._actions?this.invoke():coreError("CancellationToken","CancellationToken cancel error, repeat cancel")}isCancel(){return null==this._actions}invoke(){const t=this._actions;this._actions=null;try{for(const e of t)e();t.clear()}catch(t){coreError("CancellationToken",t)}}}class AssetInfo{init(t,e){const s=(e=this.parseLocation(t,e)).split("/");let i="";for(let t=1;t<s.length;t++)i+=s[t],t!=s.length-1&&(i+="/");this.bundleName=s[0],this.assetPath=i,this.assetType=t,this.uuid=`${e}.${t.name}`}parseLocation(t,e){return t.name==SpriteFrame.name?e.endsWith("spriteFrame")||(e+="/spriteFrame"):t.name==Texture2D.name&&(e.endsWith("texture")||(e+="/texture")),e}}class AssetSystem{constructor(){this._waitLoads=[],this._loadingSet=new Set,this._frameAddCount=0}update(){this._frameAddCount=0,this.updateLoadingSet()}addProvider(t){this._waitLoads.push(t),this.updateLoadingSet()}updateLoadingSet(){if(this._frameAddCount>=AssetSystem._frameMaxAddQueueProvider)return;if(this._loadingSet.size>=AssetSystem._maxLoadingProvider)return;if(0==this._waitLoads.length)return;const t=this._waitLoads.shift();this._loadingSet.add(t),t.internalLoad()}removeProvider(t){this._loadingSet.delete(t),this.updateLoadingSet()}}AssetSystem._maxLoadingProvider=1,AssetSystem._frameMaxAddQueueProvider=1;const MoyeAssetTag="MoyeAsset";class AssetOperationHandle{constructor(){this.isDisposed=!1}getAsset(t){return this.provider.asset}dispose(){this.isDisposed?coreError("MoyeAsset","重复销毁AssetOperationHandle"):(this.isDisposed=!0,this.provider.releaseHandle(this))}instantiateSync(){return instantiate(this.provider.asset)}async instantiateAsync(){return instantiate(this.provider.asset)}}class BundleAssetProvider{constructor(){this.refCount=0,this._handleSet=new Set}async internalLoad(){const t=this.assetInfo.assetPath,e=this.assetInfo.assetType;this.bundleAsset.bundle.load(t,e,((t,e)=>{t?coreError("MoyeAsset","加载资源错误:{0},{1}",this.assetInfo.uuid,t):this.asset=e,this._task.setResult(),this.assetSystem.removeProvider(this)}))}async load(){this._task=Task.create(),this.assetSystem.addProvider(this),await this._task}createHandle(){this.refCount++;const t=new AssetOperationHandle;return t.provider=this,this._handleSet.add(t),t}releaseHandle(t){this.refCount<=0&&coreWarn("MoyeAsset","Asset provider reference count is already zero. There may be resource leaks !"),0==this._handleSet.delete(t)&&coreError("MoyeAsset","Should never get here !"),this.refCount--}}var AssetLockType;!function(t){t.BUNDLE_ASSET_LOAD="bundle_asset_load",t.BUNDLE_LOAD="bundle_load"}(AssetLockType||(AssetLockType={}));class BundleAsset{constructor(){this.refCount=0,this.isAutoRelease=!0,this._providerMap=new Map}async loadAssetAsync(t){let e=this._providerMap.get(t.uuid);e||(e=await this.createProvider(t));return e.createHandle()}async createProvider(t){const e=await CoroutineLock.getInst().wait(AssetLockType.BUNDLE_ASSET_LOAD,t.uuid);try{let e=this._providerMap.get(t.uuid);return e||(e=new BundleAssetProvider,e.assetInfo=t,e.assetSystem=this.assetSystem,e.bundleAsset=this,this.refCount++,await e.load(),this._providerMap.set(t.uuid,e),e)}finally{e.dispose()}}unloadUnusedAssets(){for(const[t,e]of this._providerMap)0==e.refCount&&(this.bundle.release(e.assetInfo.assetPath,e.assetInfo.assetType),this._providerMap.delete(t),this.refCount--)}}class MoyeAssets extends Singleton{awake(){MoyeAssets.assetSystem=new AssetSystem}update(){MoyeAssets.assetSystem.update()}static async loadAssetAsync(t,e){try{const s=new AssetInfo;s.init(t,e);const i=s.bundleName;let r=MoyeAssets._bundleMap.get(i);r||(r=await this.loadBundleAsync(i));return await r.loadAssetAsync(s)}catch(t){coreError("MoyeAsset",t)}}static async loadBundleAsync(t){const e=await CoroutineLock.getInst().wait(AssetLockType.BUNDLE_LOAD,t);try{let e=MoyeAssets._bundleMap.get(t);if(e)return e;const s=Task.create();if(!this._bundlePathMap.has(t)&&(this._bundlePathMap.set(t,t),NATIVE)){const e=`${native.fileUtils.getWritablePath()}hot/${t}`;native.fileUtils.isDirectoryExist(e)&&this._bundlePathMap.set(t,e)}const i=this._bundlePathMap.get(t);coreLog("MoyeAsset","加载bundle: {0}",i),assetManager.loadBundle(i,((e,i)=>{e?coreLog("MoyeAsset","加载Bundle错误, bundle={0}, error={1}",t,e):coreLog("MoyeAsset","加载Bundle完成, bundle={0}",t),s.setResult(i)}));const r=await s;return e=new BundleAsset,e.bundle=r,e.bundleName=t,e.assetSystem=MoyeAssets.assetSystem,MoyeAssets._bundleMap.set(t,e),e}finally{e.dispose()}}static releaseBundle(t){0==t.refCount?(this._bundleMap.delete(t.bundleName),assetManager.removeBundle(t.bundle),coreLog("卸载bundle:{0}",t.bundleName)):coreError("MoyeAsset","释放的bundle:{0}, 引用计数不为0",t.bundleName)}static unloadUnusedAssets(){for(const[t,e]of this._bundleMap)e.unloadUnusedAssets(),0==e.refCount&&e.isAutoRelease&&MoyeAssets.releaseBundle(e)}}MoyeAssets._bundleMap=new Map,MoyeAssets._bundlePathMap=new Map;var __decorate$3=function(t,e,s,i){var r,n=arguments.length,o=n<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,s,i);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(o=(n<3?r(o):n>3?r(e,s,o):r(e,s))||o);return n>3&&o&&Object.defineProperty(e,s,o),o};let AfterProgramInitHandler=class extends AEventHandler{run(t,e){Game.addSingleton(MoyeAssets)}};AfterProgramInitHandler=__decorate$3([EventDecorator(AfterProgramInit,SceneType.NONE)],AfterProgramInitHandler);var __decorate$2=function(t,e,s,i){var r,n=arguments.length,o=n<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,s,i);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(o=(n<3?r(o):n>3?r(e,s,o):r(e,s))||o);return n>3&&o&&Object.defineProperty(e,s,o),o};const{ccclass:ccclass$2,property:property$2,menu:menu$2}=_decorator;let SizeFollow=class extends Component{constructor(){super(...arguments),this._heightFollow=!0,this._widthFollow=!0,this._heightOffset=0,this._widthOffset=0,this._changeSize=new Size}get target(){return this._target}set target(t){this._target=t,this.updateSizeOffset()}set heightFollow(t){this._heightFollow=t,this.updateSizeOffset()}get heightFollow(){return this._heightFollow}set widthFollow(t){this._widthFollow=t,this.updateSizeOffset()}get widthFollow(){return this._widthFollow}onLoad(){null!=this._target&&this._target.node.on(NodeEventType.SIZE_CHANGED,this.onTargetSizeChange,this)}onDestroy(){null!=this._target&&(this._target.isValid?(this._target.node.off(NodeEventType.SIZE_CHANGED,this.onTargetSizeChange,this),this._target=null):this._target=null)}onTargetSizeChange(){const t=this.node.getComponent(UITransform),e=this._target;this._changeSize.set(t.contentSize),this._widthFollow&&(this._changeSize.width=Math.max(0,e.width+this._widthOffset)),this._heightFollow&&(this._changeSize.height=Math.max(0,e.height+this._heightOffset)),t.setContentSize(this._changeSize)}updateSizeOffset(){if(null==this._target)return;const t=this.node.getComponent(UITransform),e=this._target;if(this._widthFollow){const s=t.width,i=e.width;this._widthOffset=s-i}if(this._heightFollow){const s=t.height,i=e.height;this._heightOffset=s-i}}};__decorate$2([property$2({type:UITransform})],SizeFollow.prototype,"target",null),__decorate$2([property$2({type:UITransform})],SizeFollow.prototype,"_target",void 0),__decorate$2([property$2],SizeFollow.prototype,"heightFollow",null),__decorate$2([property$2],SizeFollow.prototype,"_heightFollow",void 0),__decorate$2([property$2],SizeFollow.prototype,"widthFollow",null),__decorate$2([property$2],SizeFollow.prototype,"_widthFollow",void 0),__decorate$2([property$2({type:CCFloat})],SizeFollow.prototype,"_heightOffset",void 0),__decorate$2([property$2({type:CCFloat})],SizeFollow.prototype,"_widthOffset",void 0),SizeFollow=__decorate$2([ccclass$2("SizeFollow"),menu$2("moye/SizeFollow")],SizeFollow);var __decorate$1=function(t,e,s,i){var r,n=arguments.length,o=n<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,s,i);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(o=(n<3?r(o):n>3?r(e,s,o):r(e,s))||o);return n>3&&o&&Object.defineProperty(e,s,o),o};const{ccclass:ccclass$1,property:property$1,executeInEditMode:executeInEditMode,menu:menu$1}=_decorator;var WidgetBase,WidgetDirection;!function(t){t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.TOP=3]="TOP",t[t.BOTTOM=4]="BOTTOM"}(WidgetBase||(WidgetBase={})),function(t){t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.TOP=3]="TOP",t[t.BOTTOM=4]="BOTTOM",t[t.LEFT_EXTEND=5]="LEFT_EXTEND",t[t.RIGHT_EXTEND=6]="RIGHT_EXTEND",t[t.TOP_EXTEND=7]="TOP_EXTEND",t[t.BOTTOM_EXTEND=8]="BOTTOM_EXTEND"}(WidgetDirection||(WidgetDirection={}));let CTWidget=class extends Component{constructor(){super(...arguments),this._targetDir=WidgetDirection.TOP,this._dir=WidgetDirection.TOP,this.visibleOffset=0,this._isVertical=!0,this._distance=0,this._changePos=new Vec3(0,0,0),this._targetOldPos=new Vec3(0,0,0),this._targetOldSize=0,this._selfOldPos=new Vec3(0,0,0),this._selfOldSize=0}get target(){return this._target}set target(t){this._target=t,this.unregisterEvt(),this.registerEvt(),this.updateData()}set targetDir(t){if(EDITOR){if(t==WidgetDirection.LEFT||t==WidgetDirection.RIGHT){switch(this._dir){case WidgetDirection.TOP:case WidgetDirection.TOP_EXTEND:case WidgetDirection.BOTTOM:case WidgetDirection.BOTTOM_EXTEND:this._dir=WidgetDirection.LEFT}this._isVertical=!1}else{switch(this._dir){case WidgetDirection.LEFT:case WidgetDirection.LEFT_EXTEND:case WidgetDirection.RIGHT:case WidgetDirection.RIGHT_EXTEND:this._dir=WidgetDirection.TOP}this._isVertical=!0}this._targetDir=t,this.updateData()}}get targetDir(){return this._targetDir}set dir(t){if(EDITOR){switch(t){case WidgetDirection.LEFT:case WidgetDirection.LEFT_EXTEND:case WidgetDirection.RIGHT:case WidgetDirection.RIGHT_EXTEND:switch(this._targetDir){case WidgetDirection.TOP:case WidgetDirection.BOTTOM:this._targetDir=WidgetDirection.LEFT}this._isVertical=!1;break;case WidgetDirection.TOP:case WidgetDirection.TOP_EXTEND:case WidgetDirection.BOTTOM:case WidgetDirection.BOTTOM_EXTEND:switch(this._targetDir){case WidgetDirection.LEFT:case WidgetDirection.RIGHT:this._targetDir=WidgetDirection.TOP}this._isVertical=!0}this._dir=t,this.updateData()}}get dir(){return this._dir}onEnable(){EDITOR&&(this.registerEvt(),this.updateData())}onDisable(){EDITOR&&this.unregisterEvt()}onLoad(){this._trans=this.node.getComponent(UITransform),EDITOR||this.registerEvt()}onDestroy(){EDITOR||(this.unregisterEvt(),this._trans=null,this._target=null,this._changePos=null)}registerEvt(){this._target&&(EDITOR&&(this._target.node.on(NodeEventType.ANCHOR_CHANGED,this.updateData,this),this.node.on(NodeEventType.TRANSFORM_CHANGED,this.updateData,this),this.node.on(NodeEventType.SIZE_CHANGED,this.updateData,this)),this._target.node.on(NodeEventType.SIZE_CHANGED,this.onTargetChange,this),this._target.node.on(NodeEventType.TRANSFORM_CHANGED,this.onTargetChange,this),this._target.node.on(NodeEventType.ACTIVE_IN_HIERARCHY_CHANGED,this.onTargetChange,this))}unregisterEvt(){this._target&&this._target.isValid&&(EDITOR&&(this._target.node.off(NodeEventType.ANCHOR_CHANGED,this.updateData,this),this.node.off(NodeEventType.TRANSFORM_CHANGED,this.updateData,this),this.node.off(NodeEventType.SIZE_CHANGED,this.updateData,this)),this._target.node.off(NodeEventType.SIZE_CHANGED,this.onTargetChange,this),this._target.node.off(NodeEventType.TRANSFORM_CHANGED,this.onTargetChange,this),this._target.node.off(NodeEventType.ACTIVE_IN_HIERARCHY_CHANGED,this.onTargetChange,this))}updateData(){if(null!=this._target)switch(this._dir){case WidgetDirection.TOP:case WidgetDirection.BOTTOM:case WidgetDirection.LEFT:case WidgetDirection.RIGHT:this.updateDistance();break;case WidgetDirection.TOP_EXTEND:case WidgetDirection.BOTTOM_EXTEND:case WidgetDirection.LEFT_EXTEND:case WidgetDirection.RIGHT_EXTEND:this.updateTargetPos()}}onTargetChange(){if(null!=this._target)switch(this._dir){case WidgetDirection.TOP:case WidgetDirection.BOTTOM:case WidgetDirection.LEFT:case WidgetDirection.RIGHT:this.updatePos();break;case WidgetDirection.TOP_EXTEND:case WidgetDirection.BOTTOM_EXTEND:case WidgetDirection.LEFT_EXTEND:case WidgetDirection.RIGHT_EXTEND:this.updateSize()}}updateSize(){if(this._isVertical){const t=this._targetOldPos.y-this._target.node.position.y;let e=this._target.height-this._targetOldSize;const s=this._trans.anchorY;this._changePos.set(this._selfOldPos),this._target.getComponent(Label)&&!this._target.node.active&&(e=this._targetOldSize);const i=t+e;this._trans.height=this._selfOldSize+i,this._dir==WidgetDirection.TOP_EXTEND?this.node.setPosition(this._changePos):this._dir==WidgetDirection.BOTTOM_EXTEND&&(this._changePos.y-=i*(1-s),this.node.setPosition(v3(this._changePos)))}}updatePos(){const t=this._trans,e=this._target;let s=this.getPos(e,this._targetDir)-this._distance;if(this._changePos.set(this.node.worldPosition),this._isVertical){switch(this._dir){case WidgetDirection.TOP:s-=t.height*(1-t.anchorY);break;case WidgetDirection.BOTTOM:s+=t.height*t.anchorY;break}this._changePos.y=s}else this._changePos.x=s;this.node.worldPosition=this._changePos}updateTargetPos(){EDITOR&&null==this._changePos&&(console.error("编辑器数据错乱, 请重新添加本组件"),this._changePos=v3()),this.target.node.getPosition(this._targetOldPos),this.node.getPosition(this._selfOldPos),this._isVertical?(this._selfOldSize=this._trans.height,this._targetOldSize=this._target.height):(this._selfOldSize=this._trans.width,this._targetOldSize=this._target.height)}updateDistance(){if(!EDITOR)return;if(null==this._target)return;const t=this.node.getComponent(UITransform),e=this._target,s=this.getPos(t,this._dir),i=this.getPos(e,this._targetDir);this._distance=i-s}getPos(t,e){if(this._isVertical){let s=t.node.worldPosition.y;const i=t.height,r=t.anchorY;switch(e){case WidgetDirection.TOP:case WidgetDirection.TOP_EXTEND:return t.node.active||(s=s-i-this.visibleOffset),s+i*(1-r);case WidgetDirection.BOTTOM:case WidgetDirection.BOTTOM_EXTEND:return t.node.active||(s=s+i+this.visibleOffset),s-i*r}}else{const s=t.node.worldPosition.x,i=t.width,r=t.anchorX;switch(e){case WidgetDirection.LEFT:return s-i*r;case WidgetDirection.RIGHT:return s+i*(1-r)}}}};__decorate$1([property$1({type:UITransform})],CTWidget.prototype,"target",null),__decorate$1([property$1({type:UITransform})],CTWidget.prototype,"_target",void 0),__decorate$1([property$1({type:Enum(WidgetBase)})],CTWidget.prototype,"targetDir",null),__decorate$1([property$1],CTWidget.prototype,"_targetDir",void 0),__decorate$1([property$1({type:Enum(WidgetDirection)})],CTWidget.prototype,"dir",null),__decorate$1([property$1],CTWidget.prototype,"_dir",void 0),__decorate$1([property$1({type:CCFloat})],CTWidget.prototype,"visibleOffset",void 0),__decorate$1([property$1],CTWidget.prototype,"_isVertical",void 0),__decorate$1([property$1],CTWidget.prototype,"_distance",void 0),__decorate$1([property$1],CTWidget.prototype,"_changePos",void 0),__decorate$1([property$1],CTWidget.prototype,"_targetOldPos",void 0),__decorate$1([property$1],CTWidget.prototype,"_targetOldSize",void 0),__decorate$1([property$1],CTWidget.prototype,"_selfOldPos",void 0),__decorate$1([property$1],CTWidget.prototype,"_selfOldSize",void 0),CTWidget=__decorate$1([ccclass$1("CTWidget"),menu$1("moye/CTWidget"),executeInEditMode],CTWidget);const RoundBoxAssembler={GetIndexBuffer(t){const e=[0,1,2,2,3,0,4,5,6,6,7,4,8,9,10,10,11,8];let s=12;const i=function(i,r,n){let o=r;for(let r=0;r<t.segments-1;r++){const t=s;s++,e.push(i,o,t),o=t}e.push(i,o,n)};return t.leftBottom&&i(3,4,0),t.leftTop&&i(2,1,5),t.rightTop&&i(9,6,10),t.rightBottom&&i(8,11,7),e},createData(t){const e=t.requestRenderData();let s=0;s+=t.leftBottom?1:0,s+=t.leftTop?1:0,s+=t.rightTop?1:0,s+=t.rightBottom?1:0;const i=12+(t.segments-1)*s;e.dataLength=i,e.resize(i,18+3*t.segments*s);const r=RoundBoxAssembler.GetIndexBuffer(t);return e.chunk.setIndexBuffer(r),e},updateRenderData(t){const e=t.spriteFrame;dynamicAtlasManager.packToDynamicAtlas(t,e),this.updateUVs(t);const s=t.renderData;s&&e&&(s.vertDirty&&this.updateVertexData(t),s.updateRenderData(t,e))},updateWorldVerts(t,e){const s=t.renderData,i=e.vb,r=s.data,n=t.node.worldMatrix,o=s.floatStride;let a=0;const c=r.length;for(let t=0;t<c;t++){const e=r[t],s=e.x,c=e.y;let l=n.m03*s+n.m07*c+n.m15;l=l?1/l:1,a=t*o,i[a+0]=(n.m00*s+n.m04*c+n.m12)*l,i[a+1]=(n.m01*s+n.m05*c+n.m13)*l,i[a+2]=(n.m02*s+n.m06*c+n.m14)*l}},fillBuffers(t){if(null===t)return;const e=t.renderData,s=e.chunk;(t.node.hasChangedFlags||e.vertDirty)&&(this.updateWorldVerts(t,s),e.vertDirty=!1),s.bufferId;const i=s.vertexOffset,r=s.meshBuffer,n=s.meshBuffer.iData;let o=r.indexOffset;const a=i,c=RoundBoxAssembler.GetIndexBuffer(t);for(let t=0;t<e.indexCount;t++)n[o++]=a+c[t];r.indexOffset+=e.indexCount},updateVertexData(t){const e=t.renderData;if(!e)return;const s=t.node._uiProps.uiTransformComp,i=e.data,r=s.width,n=s.height,o=s.anchorX*r,a=s.anchorY*n,c=0-o,l=r-o,h=n-a,d=0-a,u=c+t.radius,p=d+t.radius,_=h-t.radius,g=l-t.radius;i[0].x=c,i[0].y=t.leftBottom?p:d,i[1].x=c,i[1].y=t.leftTop?_:h,i[2].x=u,i[2].y=t.leftTop?_:h,i[3].x=u,i[3].y=t.leftBottom?p:d,i[4].x=u,i[4].y=d,i[5].x=u,i[5].y=h,i[6].x=g,i[6].y=h,i[7].x=g,i[7].y=d,i[8].x=g,i[8].y=t.rightBottom?p:d,i[9].x=g,i[9].y=t.rightTop?_:h,i[10].x=l,i[10].y=t.rightTop?_:h,i[11].x=l,i[11].y=t.rightBottom?p:d;let m=12;const T=function(e,s){for(let r=1;r<t.segments;r++){const n=s*Math.PI/180-r/t.segments*.5*Math.PI;i[m].x=e.x+Math.cos(n)*t.radius,i[m].y=e.y+Math.sin(n)*t.radius,m++}};t.leftBottom&&T(i[3],270),t.leftTop&&T(i[2],180),t.rightTop&&T(i[9],90),t.rightBottom&&T(i[8],0),e.vertDirty=!0},updateUVs(t){if(!t.spriteFrame)return;const e=t.renderData,s=e.chunk.vb,i=t.spriteFrame.uv,r=i[0],n=i[1],o=i[2],a=i[5],c=Math.abs(o-r),l=a-n,h=t.node._uiProps.uiTransformComp,d=e.data,u=h.width,p=h.height,_=h.anchorX*u,g=h.anchorY*p;for(let t=0;t<e.dataLength;t++)s[t*e.floatStride+3]=r+(d[t].x+_)/u*c,s[t*e.floatStride+4]=n+(d[t].y+g)/p*l},updateColor(t){const e=t.renderData,s=e.chunk.vb;let i=5;const r=t.color,n=r.r/255,o=r.g/255,a=r.b/255,c=r.a/255;for(let t=0;t<e.dataLength;t++,i+=e.floatStride)s[i]=n,s[i+1]=o,s[i+2]=a,s[i+3]=c}};var __decorate=function(t,e,s,i){var r,n=arguments.length,o=n<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(t,e,s,i);else for(var a=t.length-1;a>=0;a--)(r=t[a])&&(o=(n<3?r(o):n>3?r(e,s,o):r(e,s))||o);return n>3&&o&&Object.defineProperty(e,s,o),o};const{ccclass:ccclass,property:property,type:type,menu:menu}=_decorator;var EventType;!function(t){t.SPRITE_FRAME_CHANGED="spriteframe-changed"}(EventType||(EventType={}));let RoundBoxSprite=class extends UIRenderer{constructor(){super(...arguments),this._sizeMode=Sprite.SizeMode.TRIMMED,this._atlas=null,this._segments=10,this._radius=20,this._spriteFrame=null,this._leftTop=!0,this._rightTop=!0,this._leftBottom=!0,this._rightBottom=!0}get sizeMode(){return this._sizeMode}set sizeMode(t){this._sizeMode!==t&&(this._sizeMode=t,t!==Sprite.SizeMode.CUSTOM&&this._applySpriteSize())}get spriteAtlas(){return this._atlas}set spriteAtlas(t){this._atlas!==t&&(this._atlas=t)}get segments(){return this._segments}set segments(t){this._segments=t,this._renderData=null,this._flushAssembler()}get radius(){return this._radius}set radius(t){this._radius=t,this._updateUVs(),this.markForUpdateRenderData(!0)}get spriteFrame(){return this._spriteFrame}set spriteFrame(t){if(this._spriteFrame===t)return;const e=this._spriteFrame;this._spriteFrame=t,this.markForUpdateRenderData(),this._applySpriteFrame(e),EDITOR&&this.node.emit(EventType.SPRITE_FRAME_CHANGED,this)}get leftTop(){return this._leftTop}set leftTop(t){this._leftTop=t,this.resetAssembler()}get rightTop(){return this._rightTop}set rightTop(t){this._rightTop=t,this.resetAssembler()}get leftBottom(){return this._leftBottom}set leftBottom(t){this._leftBottom=t,this.resetAssembler()}get rightBottom(){return this._rightBottom}set rightBottom(t){this._rightBottom=t,this.resetAssembler()}onLoad(){this._flushAssembler()}__preload(){this.changeMaterialForDefine(),super.__preload(),EDITOR&&(this._resized(),this.node.on(NodeEventType.SIZE_CHANGED,this._resized,this))}onEnable(){super.onEnable(),this._activateMaterial();this._spriteFrame&&this._updateUVs()}onDestroy(){EDITOR&&this.node.off(NodeEventType.SIZE_CHANGED,this._resized,this),super.onDestroy()}changeSpriteFrameFromAtlas(t){if(!this._atlas)return void console.warn("SpriteAtlas is null.");const e=this._atlas.getSpriteFrame(t);this.spriteFrame=e}changeMaterialForDefine(){let t;const e=this._instanceMaterialType;this._spriteFrame&&(t=this._spriteFrame.texture);let s=!1;if(t instanceof cclegacy.TextureBase){const e=t.getPixelFormat();s=e===cclegacy.TextureBase.PixelFormat.RGBA_ETC1||e===cclegacy.TextureBase.PixelFormat.RGB_A_PVRTC_4BPPV1||e===cclegacy.TextureBase.PixelFormat.RGB_A_PVRTC_2BPPV1}this._instanceMaterialType=s?InstanceMaterialType.USE_ALPHA_SEPARATED:InstanceMaterialType.ADD_COLOR_AND_TEXTURE,e!==this._instanceMaterialType&&this.updateMaterial()}_updateBuiltinMaterial(){let t=super._updateBuiltinMaterial();if(this.spriteFrame&&this.spriteFrame.texture instanceof RenderTexture){const e={SAMPLE_FROM_RT:!0,...t.passes[0].defines},s=new Material;s.initialize({effectAsset:t.effectAsset,defines:e}),t=s}return t}_render(t){t.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)}_canRender(){if(!super._canRender())return!1;const t=this._spriteFrame;return!(!t||!t.texture)}resetAssembler(){this._assembler=null,this._flushAssembler()}_flushAssembler(){const t=RoundBoxAssembler;this._assembler!==t&&(this.destroyRenderData(),this._assembler=t),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateRenderData(this),this._updateColor())}_applySpriteSize(){if(this._spriteFrame){if(BUILD||!this._spriteFrame)if(Sprite.SizeMode.RAW===this._sizeMode){const t=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(t)}else if(Sprite.SizeMode.TRIMMED===this._sizeMode){const t=this._spriteFrame.rect;this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this.markForUpdateRenderData(!0),this._assembler.updateRenderData(this)}}_resized(){if(EDITOR&&this._spriteFrame){const t=this.node._uiProps.uiTransformComp.contentSize;let e=t.width,s=t.height;if(this._sizeMode===Sprite.SizeMode.RAW){const t=this._spriteFrame.originalSize;e=t.width,s=t.height}else if(this._sizeMode===Sprite.SizeMode.TRIMMED){const t=this._spriteFrame.rect;e=t.width,s=t.height}e===t.width&&s===t.height||(this._sizeMode=Sprite.SizeMode.CUSTOM)}}_activateMaterial(){const t=this._spriteFrame,e=this.getRenderMaterial(0);t&&e&&this.markForUpdateRenderData(),this.renderData&&(this.renderData.material=e)}_updateUVs(){this._assembler&&this._assembler.updateUVs(this)}_applySpriteFrame(t){const e=this._spriteFrame;let s=!1;e&&(t&&t.texture===e.texture||(s=!0),s&&(this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize())}};__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"_sizeMode",void 0),__decorate([type(Sprite.SizeMode)],RoundBoxSprite.prototype,"sizeMode",null),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"_atlas",void 0),__decorate([type(SpriteAtlas)],RoundBoxSprite.prototype,"spriteAtlas",null),__decorate([property({type:CCInteger,serializable:!0})],RoundBoxSprite.prototype,"_segments",void 0),__decorate([property({type:CCInteger,serializable:!0,min:1})],RoundBoxSprite.prototype,"segments",null),__decorate([property({type:CCFloat,serializable:!0})],RoundBoxSprite.prototype,"_radius",void 0),__decorate([property({type:CCFloat,serializable:!0,min:0})],RoundBoxSprite.prototype,"radius",null),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"_spriteFrame",void 0),__decorate([type(SpriteFrame)],RoundBoxSprite.prototype,"spriteFrame",null),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"_leftTop",void 0),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"leftTop",null),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"_rightTop",void 0),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"rightTop",null),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"_leftBottom",void 0),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"leftBottom",null),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"_rightBottom",void 0),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"rightBottom",null),RoundBoxSprite=__decorate([ccclass("RoundBoxSprite"),menu("moye/RoundBoxSprite")],RoundBoxSprite);export{AEvent,AEventHandler,AfterProgramInit,AfterProgramStart,AfterSingletonAdd,BeforeProgramInit,BeforeProgramStart,BeforeSingletonAdd,BundleAsset,CTWidget,CancellationToken,CancellationTokenTag,CoroutineLock,CoroutineLockItem,CoroutineLockTag,DecoratorCollector,Entity,EntityCenter,EventDecorator,EventDecoratorType,EventHandlerTag,EventSystem,Game,IdGenerator,IdStruct,InstanceIdStruct,JsHelper,Logger,MoyeAssets,ObjectPool,Options,Program,RecycleObj,RoundBoxSprite,Scene,SceneType,Singleton,SizeFollow,TimeInfo,TimerMgr,error,log,safeCall,warn};