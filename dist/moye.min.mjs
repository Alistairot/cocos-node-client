import{_decorator,Component,director,SpriteFrame,Texture2D,instantiate,native,assetManager,UITransform,CCFloat,Size,NodeEventType,Enum,Vec3,Label,v3,dynamicAtlasManager,Sprite,SpriteAtlas,CCInteger,UIRenderer,cclegacy,InstanceMaterialType,RenderTexture,Material}from"cc";import{NATIVE,EDITOR,BUILD}from"cc/env";class Singleton{constructor(){this._isDisposed=!1}static get(){const e=this;if(null==e._inst)throw new Error(`Singleton is not initialized or destroyed, name is ${e.name}`);return e._inst}get isDisposed(){return this._isDisposed}dispose(){this._onPreDestroy()}_onPreDestroy(){this._isDisposed||(this.destroy&&this.destroy(),Singleton._inst=null,this._isDisposed=!0)}}class TimeInfo extends Singleton{awake(){this.serverMinusClientTime=0}clientNow(){return Date.now()}serverNow(){return this.clientNow()+this.serverMinusClientTime}}class JsHelper{static getMethodName(){const e=(new Error).stack.split("at ")[2],t=e.indexOf(" ");return e.substring(0,t)}static getRootDirName(e){return e.split("/")[0]}static sleep(e){return new Promise((t=>setTimeout(t,e)))}static isNullOrEmpty(e){return null==e||(0==e.length||void 0)}static getStringHashCode(e){let t=5381,s=e.length;for(;s;)t=33*t^e.charCodeAt(--s);return t>>>0}static modeString(e,t){return this.getStringHashCode(e)%t}static formatStr(e,...t){if("string"!=typeof e){const e=new Error("formatStr args[0] is not string");return e.name+e.stack}if(0==t.length)return e;return e.replace(/\{\{|\}\}|\{(\d+)\}/g,(function(e,s){return"{{"==e?"{":"}}"==e?"}":t[s]}))}}class Options extends Singleton{constructor(){super(...arguments),this.isServer=!1,this.logLevel=1,this.develop=!0}}class LoggerDefault{log(e){console.log(e)}warn(e){console.warn(e)}error(e){console.error(e)}}class Logger extends Singleton{set iLog(e){this._logInst=e}get _iLog(){return this._logInst||(this._logInst=new LoggerDefault,this._logInst.warn("not set iLog, use default logger")),this._logInst}log(e,...t){if(this.checkLogLevel(Logger.LOG_LEVEL)){const s=JsHelper.formatStr(e,...t);this._iLog.log(s)}}warn(e,...t){if(this.checkLogLevel(Logger.WARN_LEVEL)){const s=JsHelper.formatStr(e,...t);this._iLog.warn(s)}}error(e,...t){const s=JsHelper.formatStr(e,...t);this._iLog.error(s)}checkLogLevel(e){return Options.get().logLevel<=e}coreLog(e){this._iLog.log(e)}coreWarn(e){this._iLog.warn(e)}coreError(e){this._iLog.error(e)}}function log(e,...t){Logger.get().log(e,...t)}function warn(e,...t){Logger.get().warn(e,...t)}function error(e,...t){Logger.get().error(e,...t)}function coreLog(e,t,...s){const i=`[${e}]: ${JsHelper.formatStr(t,...s)}`;try{Logger.get().coreLog(i)}catch(e){console.log(i)}}function coreWarn(e,t,...s){const i=`[${e}]: ${JsHelper.formatStr(t,...s)}`;try{Logger.get().coreWarn(i)}catch(e){console.warn(i)}}function coreError(e,t,...s){const i=`[${e}]: ${JsHelper.formatStr(t,...s)}`;try{Logger.get().coreError(i)}catch(e){console.error(i)}}Logger.LOG_LEVEL=1,Logger.WARN_LEVEL=2;const IdGeneratorTag="IdGenerator",timeBit$1=30n,processBit=14n,valueBit$1=20n,powTimeBit$1=2n**timeBit$1-1n,powProcessBit=2n**processBit-1n,powValueBit$1=2n**valueBit$1-1n,epoch$1=new Date(2023,4,1).getTime();class IdStruct{static get inst(){return null==IdStruct._inst&&(IdStruct._inst=new IdStruct),IdStruct._inst}static generate(){0==this._lastTime&&(this._lastTime=this.timeSinceEpoch(),this._lastTime<=0&&(coreWarn("IdGenerator","{0}: lastTime less than 0: {1}",(new this).constructor.name,this._lastTime),this._lastTime=1));const e=this.timeSinceEpoch();e>this._lastTime?(this._lastTime=e,this._idCount=0):(++this._idCount,this._idCount>powValueBit$1&&(++this._lastTime,this._idCount=0,coreError("IdGenerator","{0}: idCount per sec overflow: {1} {2}",(new this).constructor.name,e,this._lastTime)));const t=IdStruct.inst;return t.init(this._lastTime,1,this._idCount),t.result}static convertToId(e,t,s){return IdStruct.inst.init(e,t,s).result}static parseId(e){return IdStruct.inst.initById(e)}static timeSinceEpoch(){const e=(TimeInfo.get().clientNow()-epoch$1)/1e3;return Math.floor(e)}initById(e){return this.result=e,this.time=e&powTimeBit$1,e>>=timeBit$1,this.process=e&powProcessBit,e>>=processBit,this.value=e&powValueBit$1,this}init(e,t,s){return this.time=BigInt(e),this.process=BigInt(t),this.value=BigInt(s),this.updateResult(),this}updateResult(){this.result=this.value,this.result<<=processBit,this.result|=this.process,this.result<<=timeBit$1,this.result|=this.time}}IdStruct._lastTime=0,IdStruct._idCount=0;const timeBit=32n,valueBit=32n,powTimeBit=2n**timeBit-1n,powValueBit=2n**valueBit-1n,epoch=new Date(2023,4,1).getTime();class InstanceIdStruct{static get inst(){return null==InstanceIdStruct._inst&&(InstanceIdStruct._inst=new InstanceIdStruct),InstanceIdStruct._inst}static generate(){0==this._lastTime&&(this._lastTime=this.timeSinceEpoch(),this._lastTime<=0&&(coreWarn("IdGenerator","{0}: lastTime less than 0: {1}",(new this).constructor.name,this._lastTime),this._lastTime=1));const e=this.timeSinceEpoch();e>this._lastTime?(this._lastTime=e,this._idCount=0):(++this._idCount,this._idCount>powValueBit&&(++this._lastTime,this._idCount=0,coreError("IdGenerator","{0}: idCount per sec overflow: {1} {2}",(new this).constructor.name,e,this._lastTime)));const t=InstanceIdStruct.inst;return t.init(this._lastTime,this._idCount),t.result}static convertToId(e,t){return InstanceIdStruct.inst.init(e,t).result}static parseId(e){return InstanceIdStruct.inst.initById(e)}static timeSinceEpoch(){const e=(TimeInfo.get().clientNow()-epoch)/1e3;return Math.floor(e)}initById(e){return this.result=e,this.time=e&powTimeBit,e>>=timeBit,this.value=e&powValueBit,this}init(e,t){return this.time=BigInt(e),this.value=BigInt(t),this.updateResult(),this}updateResult(){this.result=this.value,this.result<<=timeBit,this.result|=this.time}}InstanceIdStruct._lastTime=0,InstanceIdStruct._idCount=0;class IdGenerator extends Singleton{generateInstanceId(){return InstanceIdStruct.generate()}generateId(){return IdStruct.generate()}}class ObjectPool extends Singleton{constructor(){super(...arguments),this._pool=new Map}fetch(e){const t=this._pool.get(e);return t?0===t.length?new e:t.shift():new e}recycle(e){const t=e.constructor;let s=this._pool.get(t);s||(s=[],this._pool.set(t,s)),s.length>1e3?console.warn(`pool ${t.name} is too large`):s.push(e)}}class EntityCenter extends Singleton{constructor(){super(...arguments),this._allEntities=new Map}add(e){this._allEntities.set(e.instanceId,e)}remove(e){this._allEntities.delete(e)}get(e){return this._allEntities.get(e)}}var InstanceQueueIndex,EntityStatus,SceneType;!function(e){e[e.NONE=-1]="NONE",e[e.UPDATE=0]="UPDATE",e[e.LATE_UPDATE=1]="LATE_UPDATE",e[e.MAX=2]="MAX"}(InstanceQueueIndex||(InstanceQueueIndex={}));class EntityLifiCycleMgr extends Singleton{constructor(){super(...arguments),this._queues=new Array(InstanceQueueIndex.MAX)}awake(){for(let e=0;e<this._queues.length;e++)this._queues[e]=[]}registerSystem(e){e.update&&this._queues[InstanceQueueIndex.UPDATE].push(e.instanceId),e.lateUpdate&&this._queues[InstanceQueueIndex.LATE_UPDATE].push(e.instanceId)}awakeComEvent(e){e.awake()}destroyComEvent(e){e.destroy()}update(){const e=this._queues[InstanceQueueIndex.UPDATE],t=EntityCenter.get();for(let s=e.length-1;s>=0;s--){const i=e[s],r=t.get(i);r?r.isDisposed?e.splice(s,1):r.update():e.splice(s,1)}}lateUpdate(){const e=this._queues[InstanceQueueIndex.LATE_UPDATE],t=EntityCenter.get();for(let s=e.length-1;s>=0;s--){const i=e[s],r=t.get(i);r?r.isDisposed?e.splice(s,1):r.lateUpdate():e.splice(s,1)}}}!function(e){e[e.NONE=0]="NONE",e[e.IS_FROM_POOL=1]="IS_FROM_POOL",e[e.IS_REGISTER=2]="IS_REGISTER",e[e.IS_COMPONENT=4]="IS_COMPONENT",e[e.IS_CREATED=8]="IS_CREATED",e[e.IS_NEW=16]="IS_NEW"}(EntityStatus||(EntityStatus={}));class Entity{constructor(){this._status=EntityStatus.NONE}get parent(){return this._parent}set parent(e){if(null==e)throw new Error(`cant set parent null: ${this.constructor.name}`);if(e==this)throw new Error(`cant set parent self: ${this.constructor.name}`);if(null==e.domain)throw new Error(`cant set parent because parent domain is null: ${this.constructor.name} ${e.constructor.name}`);if(null!=this._parent){if(this._parent==e)throw new Error(`重复设置了Parent: ${this.constructor.name} parent: ${this._parent.constructor.name}`);this._parent.removeFromChildren(this)}this._parent=e,this.isComponent=!1,this._parent.addToChildren(this),this.domain=this.parent.domain}get domain(){return this._domain}set domain(e){if(null==e)throw new Error(`domain cant set null: ${this.constructor.name}`);if(this._domain==e)return;const t=this._domain;if(this._domain=e,null==t&&(this.instanceId=IdGenerator.get().generateInstanceId(),this.isRegister=!0),null!=this._children)for(const[e,t]of this._children.entries())t.domain=this._domain;if(null!=this._components)for(const[e,t]of this._components.entries())t.domain=this._domain;this.isCreated||(this.isCreated=!0)}get isDisposed(){return 0n==this.instanceId}get children(){return this._children??(this._children=ObjectPool.get().fetch(Map))}get components(){return this._components??(this._components=ObjectPool.get().fetch(Map))}get isFromPool(){return(this._status&EntityStatus.IS_FROM_POOL)==EntityStatus.IS_FROM_POOL}set isFromPool(e){e?this._status|=EntityStatus.IS_FROM_POOL:this._status&=~EntityStatus.IS_FROM_POOL}get isComponent(){return(this._status&EntityStatus.IS_COMPONENT)==EntityStatus.IS_COMPONENT}set isComponent(e){e?this._status|=EntityStatus.IS_COMPONENT:this._status&=~EntityStatus.IS_COMPONENT}get isCreated(){return(this._status&EntityStatus.IS_CREATED)==EntityStatus.IS_CREATED}set isCreated(e){e?this._status|=EntityStatus.IS_CREATED:this._status&=~EntityStatus.IS_CREATED}get isNew(){return(this._status&EntityStatus.IS_NEW)==EntityStatus.IS_NEW}set isNew(e){e?this._status|=EntityStatus.IS_NEW:this._status&=~EntityStatus.IS_NEW}get isRegister(){return(this._status&EntityStatus.IS_REGISTER)==EntityStatus.IS_REGISTER}set isRegister(e){if(this.isRegister!=e)if(e?this._status|=EntityStatus.IS_REGISTER:this._status&=~EntityStatus.IS_REGISTER,e){const e=this;EntityCenter.get().add(e),EntityLifiCycleMgr.get().registerSystem(e)}else EntityCenter.get().remove(this.instanceId)}set componentParent(e){if(null==e)throw new Error(`cant set parent null: ${this.constructor.name}`);if(e==this)throw new Error(`cant set parent self: ${this.constructor.name}`);if(null==e.domain)throw new Error(`cant set parent because parent domain is null: ${this.constructor.name} ${e.constructor.name}`);if(null!=this.parent){if(this.parent==e)throw new Error(`重复设置了Parent: ${this.constructor.name} parent: ${this.parent.constructor.name}`);this.parent.removeFromComponents(this)}this._parent=e,this.isComponent=!0,this._parent.addToComponents(this),this.domain=this.parent.domain}addCom(e,t){return e instanceof Entity?this.addComByEntity(e):this.addComByType(e,t)}tryAddCom(e){let t=this.getCom(e);return null==t&&(t=this.addCom(e)),t}addComByEntity(e){const t=e.constructor;if(null!=this._components&&this._components.has(t))throw new Error(`entity already has component: ${t.name}`);return e.componentParent=this,e}addComByType(e,t=!1){if(null!=this._components&&this._components.has(e))throw new Error(`entity already has component: ${e.name}`);const s=this.create(e,t);return s.id=this.id,s.componentParent=this,s.awake&&EntityLifiCycleMgr.get().awakeComEvent(s),s}addChild(e,t){return e instanceof Entity?this.addChildByEntity(e):this.addChildByType(e,t)}addChildWithId(e,t,s=!1){const i=this.create(e,s);return i.id=t,i.parent=this,i.awake&&EntityLifiCycleMgr.get().awakeComEvent(i),i}addChildByEntity(e){return e.parent=this,e}addChildByType(e,t=!1){const s=this.create(e,t);return s.id=IdGenerator.get().generateId(),s.parent=this,s.awake&&EntityLifiCycleMgr.get().awakeComEvent(s),s}create(e,t){let s;return s=t?ObjectPool.get().fetch(e):new e,s.isFromPool=t,s.isCreated=!0,s.isNew=!0,s.id=0n,s}removeFromChildren(e){null!=this._children&&(this._children.delete(e.id),0==this._children.size&&(ObjectPool.get().recycle(this._children),this._children=null))}removeFromComponents(e){null!=this._components&&(this._components.delete(e.constructor),0==this._components.size&&(ObjectPool.get().recycle(this._components),this._components=null))}addToComponents(e){this.components.set(e.constructor,e)}addToChildren(e){if(this.children.has(e.id))throw new Error(`entity already has child: ${e.id}`);this.children.set(e.id,e)}getCom(e){if(null==this._components)return null;const t=this._components.get(e);return t||null}removeCom(e){if(this.isDisposed)return;if(null==this._components)return;const t=this.getCom(e);null!=t&&(this.removeFromComponents(t),t.dispose())}getParent(e){return this.parent}getChild(e,t){if(null==this._children)return null;return this._children.get(t)}removeChild(e){if(null==this._children)return;const t=this._children.get(e);t&&(this._children.delete(e),t.dispose())}dispose(){if(!this.isDisposed){if(this.isRegister=!1,this.instanceId=0n,null!=this._children){for(const[e,t]of this._children.entries())t.dispose();this._children.clear(),ObjectPool.get().recycle(this._children),this._children=null}if(null!=this._components){for(const[e,t]of this._components.entries())t.dispose();this._components.clear(),ObjectPool.get().recycle(this._components),this._components=null}this.destroy&&EntityLifiCycleMgr.get().destroyComEvent(this),this._domain=null,null==this._parent||this._parent.isDisposed||(this.isComponent?this._parent.removeCom(this.getType()):this._parent.removeFromChildren(this)),this._parent=null,this.isFromPool&&ObjectPool.get().recycle(this),this._status=EntityStatus.NONE}}domainScene(){return this.domain}getType(){return this.constructor}}class Scene extends Entity{set domain(e){this._domain=e}get domain(){return this._domain}set parent(e){null!=e&&(this._parent=e,this._parent.children.set(this.id,this))}init(e){this.id=e.id,this.instanceId=e.instanceId,this.sceneType=e.sceneType,this.name=e.name,this.parent=e.parent,this.isCreated=!0,this.isNew=!0,this.domain=this,this.isRegister=!0,coreLog("scene","scene create sceneType = {0}, name = {1}, id = {2}",this.sceneType,this.name,this.id)}}!function(e){e.NONE="NONE",e.PROCESS="PROCESS",e.CLIENT="CLIENT",e.CURRENT="CURRENT"}(SceneType||(SceneType={}));class RecycleObj{constructor(){this._isRecycle=!1}static create(e){const t=ObjectPool.get().fetch(this);return e&&Object.assign(t,e),t._isRecycle=!0,t}dispose(){this._isRecycle&&ObjectPool.get().recycle(this)}}class AEvent extends RecycleObj{}class BeforeSingletonAdd extends AEvent{}class AfterSingletonAdd extends AEvent{}class BeforeProgramInit extends AEvent{}class AfterProgramInit extends AEvent{}class BeforeProgramStart extends AEvent{}class AfterProgramStart extends AEvent{}class AfterCreateClientScene extends AEvent{}class AfterCreateCurrentScene extends AEvent{}class DecoratorCollector{constructor(){this._decorators=new Map}static get inst(){return null==DecoratorCollector._inst&&(DecoratorCollector._inst=new DecoratorCollector),DecoratorCollector._inst}add(e,...t){let s=this._decorators.get(e);s||(s=[],this._decorators.set(e,s)),s.push(t)}get(e){return this._decorators.get(e)||[]}}const EventDecoratorType="EventDecoratorType";function EventDecorator(e,t){return function(s){null==t&&console.error("EventDecorator必须要传 sceneType"),DecoratorCollector.inst.add(EventDecoratorType,e,s,t)}}class EventInfo{constructor(e,t){this.eventHandler=e,this.sceneType=t}}class MoyeEventCenter{constructor(){this.allEvents=new Map}static get inst(){return null==this._inst&&(this._inst=new MoyeEventCenter,this._inst.reloadEvent()),this._inst}reloadEvent(){const e=DecoratorCollector.inst.get(EventDecoratorType);this.allEvents.clear();for(const t of e){const e=t[0],s=t[1],i=t[2];let r=this.allEvents.get(e);r||(r=[],this.allEvents.set(e,r)),r.push(new EventInfo(new s,i))}}publish(e){const t=this.allEvents.get(e.constructor);if(t){for(let s=0;s<t.length;s++){t[s].eventHandler.handle(null,e)}e.dispose()}}}class Task extends Promise{static create(e){let t;const s=new Task((e=>{t=e}));return s._resolve=t,s}setResult(e){if(!this._resolve)throw new Error("setResult but task has been disposed");this._resolve(e),this.dispose()}constructor(e){super(e)}dispose(){this._resolve=null}}class Game{static addSingleton(e,t=!0){if(Game._singletonMap.has(e))throw new Error(`already exist singleton: ${e.name}`);t&&MoyeEventCenter.inst.publish(BeforeSingletonAdd.create({singletonType:e}));const s=new e;e._inst=s,Game._singletonMap.set(e,s),Game._singletons.push(s);const i=s;return i.awake&&i.awake(),Game._destroys.push(i),i.update&&Game._updates.push(i),i.lateUpdate&&Game._lateUpdates.push(i),t&&MoyeEventCenter.inst.publish(AfterSingletonAdd.create({singletonType:e})),s}static async waitFrameFinish(){const e=Task.create();Game._frameFinishTaskQueue.push(e),await e}static update(){for(let e=0;e<Game._updates.length;e++){const t=Game._updates[e];t.isDisposed||t.update()}}static lateUpdate(){for(let e=0;e<Game._lateUpdates.length;e++){const t=Game._lateUpdates[e];t.isDisposed||t.lateUpdate()}}static frameFinishUpdate(){const e=Game._frameFinishTaskQueue.length;if(0!=e){for(let t=0;t<e;t++){Game._frameFinishTaskQueue[t].setResult()}Game._frameFinishTaskQueue=[]}}static dispose(){for(let e=Game._singletons.length-1;e>=0;e--){const t=Game._singletons[e];t.isDisposed||t._onPreDestroy()}}}Game._singletonMap=new Map,Game._singletons=[],Game._destroys=[],Game._updates=[],Game._lateUpdates=[],Game._frameFinishTaskQueue=[];class EventSystem extends Singleton{async publishAsync(e,t){const s=MoyeEventCenter.inst.allEvents.get(t.constructor);if(!s)return;const i=[];for(let r=0;r<s.length;r++){const n=s[r];n.sceneType!=e.sceneType&&"None"!=n.sceneType||i.push(n.eventHandler.handleAsync(e,t))}await Promise.all(i),t.dispose()}publish(e,t){const s=MoyeEventCenter.inst.allEvents.get(t.constructor);if(s){for(let i=0;i<s.length;i++){const r=s[i];r.sceneType!=e.sceneType&&"None"!=r.sceneType||r.eventHandler.handle(e,t)}t.dispose()}}}var __decorate$4=function(e,t,s,i){var r,n=arguments.length,o=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(n<3?r(o):n>3?r(t,s,o):r(t,s))||o);return n>3&&o&&Object.defineProperty(t,s,o),o};const{ccclass:ccclass$3,property:property$3}=_decorator;let MoyeRuntime=class extends Component{start(){director.addPersistRootNode(this.node)}update(e){Game.update()}lateUpdate(e){Game.lateUpdate(),Game.frameFinishUpdate()}onDestroy(){Game.dispose()}};MoyeRuntime=__decorate$4([ccclass$3("MoyeRuntime")],MoyeRuntime);class Root extends Singleton{get scene(){return this._scene}awake(){const e=new Scene;e.init({id:0n,sceneType:SceneType.PROCESS,name:"Process",instanceId:IdGenerator.get().generateInstanceId()}),this._scene=e}}class TimeHelper{static clientNow(){return TimeInfo.get().clientNow()}static clientNowSeconds(){return Math.floor(TimeHelper.clientNow()/1e3)}static serverNow(){return TimeInfo.get().serverNow()}}var TimerType;TimeHelper.OneDay=864e5,TimeHelper.Hour=36e5,TimeHelper.Minute=6e4,function(e){e[e.ONCE=0]="ONCE",e[e.REPEAT=1]="REPEAT"}(TimerType||(TimerType={}));class Timer{static create(){const e=ObjectPool.get().fetch(Timer);return e.reset(),e.id=Timer.getId(),e}static getId(){return++this._idGenerator}reset(){this.cb=null,this.tcs=null,this.id=0,this.expireTime=0,this.interval=0}dispose(){this.reset(),ObjectPool.get().recycle(this)}}Timer._idGenerator=1e3;class TimerMgr extends Singleton{constructor(){super(...arguments),this._timerMap=new Map,this._timers=[]}newRepeatedTimer(e,t,s=!1){const i=Timer.create();return i.type=TimerType.REPEAT,i.cb=t,i.interval=e,i.expireTime=e+TimeHelper.clientNow(),this._timerMap.set(i.id,i),this._timers.push(i),i.id}newOnceTimer(e,t){const s=Timer.create();return s.type=TimerType.ONCE,s.cb=t,s.expireTime=e+TimeHelper.clientNow(),this._timerMap.set(s.id,s),this._timers.push(s),s.id}newFrameTimer(e){const t=Timer.create();return t.type=TimerType.REPEAT,t.cb=e,t.interval=1,t.expireTime=t.interval+TimeHelper.clientNow(),this._timerMap.set(t.id,t),this._timers.push(t),t.id}remove(e){const t=this._timerMap.get(e);return!!t&&(t.id=0,this._timerMap.delete(e),!0)}update(){const e=TimeHelper.clientNow();for(let t=this._timers.length-1;t>=0;t--){const s=this._timers[t];0!=s.id?s.expireTime>e||(null!=s.cb&&s.cb(),null!=s.tcs&&s.tcs.setResult(),s.type==TimerType.REPEAT?s.expireTime+=s.interval:this.remove(s.id)):(this._timers.splice(t,1),s.dispose())}}async waitAsync(e,t){if(e<=0)return;const s=Task.create(),i=Timer.create();let r;i.type=TimerType.ONCE,i.tcs=s,i.expireTime=e+TimeHelper.clientNow(),this._timerMap.set(i.id,i),this._timers.push(i),t&&(r=()=>{this.remove(i.id)&&s.setResult()},t.add(r));try{await s}finally{t?.remove(r),r=null}}}const CoroutineLockTag="CoroutineLock";class CoroutineLockItem{init(e){this.key=e,this.task=Task.create(),Options.get().develop&&this.setTimeout(6e4,"CoroutineLock timeout")}setTimeout(e,t){this.deleteTimeout(),this._timerId=TimerMgr.get().newOnceTimer(e,this.timeout.bind(this)),this._timeoutInfo=t}deleteTimeout(){null!=this._timerId&&(TimerMgr.get().remove(this._timerId),this._timerId=null)}async timeout(){coreWarn("CoroutineLock","CoroutineLock timeout key: {0}, info: {1}",this.key,this._timeoutInfo)}dispose(){null!=this.key?(this.deleteTimeout(),CoroutineLock.get().runNextLock(this),this.key=null,this.task=null):coreWarn("CoroutineLock","repeat dispose CoroutineLockItem")}}class CoroutineLock extends Singleton{constructor(){super(...arguments),this._lockMap=new Map}async wait(e,t){const s=`${e}_${t}`;let i=this._lockMap.get(s);i||(i=new Set,this._lockMap.set(s,i));const r=ObjectPool.get().fetch(CoroutineLockItem);return r.init(s),i.add(r),i.size>1?await r.task:r.task.setResult(),r}runNextLock(e){const t=this._lockMap.get(e.key);t.delete(e),ObjectPool.get().recycle(e);for(const e of Array.from(t.values())){e.task.setResult();break}}}class SceneRefCom extends Entity{}class SceneFactory{static createClientScene(){const e=Root.get().scene.getCom(SceneRefCom);e.scene?.dispose();const t=new Scene;return t.init({id:1n,sceneType:SceneType.CLIENT,name:"Game",instanceId:IdGenerator.get().generateInstanceId(),parent:e}),t.addCom(SceneRefCom),e.scene=t,EventSystem.get().publish(t,AfterCreateClientScene.create()),t}static createCurrentScene(e,t){const s=Root.get().scene.getCom(SceneRefCom).scene.getCom(SceneRefCom);s.scene?.dispose();const i=new Scene;return i.init({id:e,sceneType:SceneType.CURRENT,name:t,instanceId:IdGenerator.get().generateInstanceId(),parent:s}),s.scene=i,EventSystem.get().publish(i,AfterCreateCurrentScene.create()),i}}class Program{static init(e){MoyeEventCenter.inst.publish(new BeforeProgramInit),Game.addSingleton(ObjectPool,!1),Game.addSingleton(Options),Game.addSingleton(Logger),Game.addSingleton(EventSystem),Game.addSingleton(TimeInfo),Game.addSingleton(TimerMgr),Game.addSingleton(CoroutineLock),Game.addSingleton(IdGenerator),Game.addSingleton(EntityCenter),Game.addSingleton(EntityLifiCycleMgr),Game.addSingleton(Root),e.addComponent(MoyeRuntime),MoyeEventCenter.inst.publish(new AfterProgramInit)}static start(){MoyeEventCenter.inst.reloadEvent(),MoyeEventCenter.inst.publish(new BeforeProgramStart),MoyeEventCenter.inst.publish(new AfterProgramStart),Root.get().scene.addCom(SceneRefCom),SceneFactory.createClientScene()}}async function safeCall(e){try{return await e}catch(e){coreError("safeCall",e)}}const EventHandlerTag="EventHandler";class AEventHandler{async handleAsync(e,t){try{await this.run(e,t)}catch(e){coreError("EventHandler",e)}}handle(e,t){try{const s=this.run(e,t);s instanceof Promise&&(coreWarn("EventHandler","{0}的run方法是异步的, 请尽量不要用publish来通知",this.constructor.name),safeCall(s))}catch(e){coreError("EventHandler",e)}}}const CancellationTokenTag="CancellationToken";class CancellationToken{constructor(){this._actions=new Set}add(e){null!=e?this._actions.add(e):coreError("CancellationToken","CancellationToken add error, callback is null")}remove(e){this._actions.delete(e)}cancel(){null!=this._actions?this.invoke():coreError("CancellationToken","CancellationToken cancel error, repeat cancel")}isCancel(){return null==this._actions}invoke(){const e=this._actions;this._actions=null;try{for(const t of e)t();e.clear()}catch(e){coreError("CancellationToken",e)}}}class AssetInfo{init(e,t){const s=(t=this.parseLocation(e,t)).split("/");let i="";for(let e=1;e<s.length;e++)i+=s[e],e!=s.length-1&&(i+="/");this.bundleName=s[0],this.assetPath=i,this.assetType=e,this.uuid=`${t}.${e.name}`}parseLocation(e,t){return e.name==SpriteFrame.name?t.endsWith("spriteFrame")||(t+="/spriteFrame"):e.name==Texture2D.name&&(t.endsWith("texture")||(t+="/texture")),t}}class AssetSystem{constructor(){this._waitLoads=[],this._loadingSet=new Set,this._frameAddCount=0}update(){this._frameAddCount=0,this.updateLoadingSet()}addProvider(e){this._waitLoads.push(e),this.updateLoadingSet()}updateLoadingSet(){if(this._frameAddCount>=AssetSystem._frameMaxAddQueueProvider)return;if(this._loadingSet.size>=AssetSystem._maxLoadingProvider)return;if(0==this._waitLoads.length)return;const e=this._waitLoads.shift();this._loadingSet.add(e),e.internalLoad()}removeProvider(e){this._loadingSet.delete(e),this.updateLoadingSet()}}AssetSystem._maxLoadingProvider=1,AssetSystem._frameMaxAddQueueProvider=1;const MoyeAssetTag="MoyeAsset";class AssetOperationHandle{constructor(){this.isDisposed=!1}getAsset(e){return this.provider.asset}dispose(){this.isDisposed?coreError("MoyeAsset","重复销毁AssetOperationHandle"):(this.isDisposed=!0,this.provider.releaseHandle(this))}instantiateSync(){return instantiate(this.provider.asset)}async instantiateAsync(){return instantiate(this.provider.asset)}}class BundleAssetProvider{constructor(){this.refCount=0,this._handleSet=new Set}async internalLoad(){const e=this.assetInfo.assetPath,t=this.assetInfo.assetType;this.bundleAsset.bundle.load(e,t,((e,t)=>{e?coreError("MoyeAsset","加载资源错误:{0},{1}",this.assetInfo.uuid,e):this.asset=t,this._task.setResult(),this.assetSystem.removeProvider(this)}))}async load(){this._task=Task.create(),this.assetSystem.addProvider(this),await this._task}createHandle(){this.refCount++;const e=new AssetOperationHandle;return e.provider=this,this._handleSet.add(e),e}releaseHandle(e){this.refCount<=0&&coreWarn("MoyeAsset","Asset provider reference count is already zero. There may be resource leaks !"),0==this._handleSet.delete(e)&&coreError("MoyeAsset","Should never get here !"),this.refCount--}}var AssetLockType;!function(e){e.BUNDLE_ASSET_LOAD="bundle_asset_load",e.BUNDLE_LOAD="bundle_load"}(AssetLockType||(AssetLockType={}));class BundleAsset{constructor(){this.refCount=0,this.isAutoRelease=!0,this._providerMap=new Map}async loadAssetAsync(e){let t=this._providerMap.get(e.uuid);t||(t=await this.createProvider(e));return t.createHandle()}async createProvider(e){const t=await CoroutineLock.get().wait(AssetLockType.BUNDLE_ASSET_LOAD,e.uuid);try{let t=this._providerMap.get(e.uuid);return t||(t=new BundleAssetProvider,t.assetInfo=e,t.assetSystem=this.assetSystem,t.bundleAsset=this,this.refCount++,await t.load(),this._providerMap.set(e.uuid,t),t)}finally{t.dispose()}}unloadUnusedAssets(){for(const[e,t]of this._providerMap)0==t.refCount&&(this.bundle.release(t.assetInfo.assetPath,t.assetInfo.assetType),this._providerMap.delete(e),this.refCount--)}}class MoyeAssets extends Singleton{awake(){MoyeAssets.assetSystem=new AssetSystem}update(){MoyeAssets.assetSystem.update()}static async loadAssetAsync(e,t){try{const s=new AssetInfo;s.init(e,t);const i=s.bundleName;let r=MoyeAssets._bundleMap.get(i);r||(r=await this.loadBundleAsync(i));return await r.loadAssetAsync(s)}catch(e){coreError("MoyeAsset",e)}}static async loadBundleAsync(e){const t=await CoroutineLock.get().wait(AssetLockType.BUNDLE_LOAD,e);try{let t=MoyeAssets._bundleMap.get(e);if(t)return t;const s=Task.create();if(!this._bundlePathMap.has(e)&&(this._bundlePathMap.set(e,e),NATIVE)){const t=`${native.fileUtils.getWritablePath()}hot/${e}`;native.fileUtils.isDirectoryExist(t)&&this._bundlePathMap.set(e,t)}const i=this._bundlePathMap.get(e);coreLog("MoyeAsset","加载bundle: {0}",i),assetManager.loadBundle(i,((t,i)=>{t?coreLog("MoyeAsset","加载Bundle错误, bundle={0}, error={1}",e,t):coreLog("MoyeAsset","加载Bundle完成, bundle={0}",e),s.setResult(i)}));const r=await s;return t=new BundleAsset,t.bundle=r,t.bundleName=e,t.assetSystem=MoyeAssets.assetSystem,MoyeAssets._bundleMap.set(e,t),t}finally{t.dispose()}}static releaseBundle(e){0==e.refCount?(this._bundleMap.delete(e.bundleName),assetManager.removeBundle(e.bundle),coreLog("卸载bundle:{0}",e.bundleName)):coreError("MoyeAsset","释放的bundle:{0}, 引用计数不为0",e.bundleName)}static unloadUnusedAssets(){for(const[e,t]of this._bundleMap)t.unloadUnusedAssets(),0==t.refCount&&t.isAutoRelease&&MoyeAssets.releaseBundle(t)}}MoyeAssets._bundleMap=new Map,MoyeAssets._bundlePathMap=new Map;var __decorate$3=function(e,t,s,i){var r,n=arguments.length,o=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(n<3?r(o):n>3?r(t,s,o):r(t,s))||o);return n>3&&o&&Object.defineProperty(t,s,o),o};let AfterProgramInitHandler=class extends AEventHandler{run(e,t){Game.addSingleton(MoyeAssets)}};AfterProgramInitHandler=__decorate$3([EventDecorator(AfterProgramInit,SceneType.NONE)],AfterProgramInitHandler);var __decorate$2=function(e,t,s,i){var r,n=arguments.length,o=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(n<3?r(o):n>3?r(t,s,o):r(t,s))||o);return n>3&&o&&Object.defineProperty(t,s,o),o};const{ccclass:ccclass$2,property:property$2,menu:menu$2}=_decorator;let SizeFollow=class extends Component{constructor(){super(...arguments),this._heightFollow=!0,this._widthFollow=!0,this._heightOffset=0,this._widthOffset=0,this._changeSize=new Size}get target(){return this._target}set target(e){this._target=e,this.updateSizeOffset()}set heightFollow(e){this._heightFollow=e,this.updateSizeOffset()}get heightFollow(){return this._heightFollow}set widthFollow(e){this._widthFollow=e,this.updateSizeOffset()}get widthFollow(){return this._widthFollow}onLoad(){null!=this._target&&this._target.node.on(NodeEventType.SIZE_CHANGED,this.onTargetSizeChange,this)}onDestroy(){null!=this._target&&(this._target.isValid?(this._target.node.off(NodeEventType.SIZE_CHANGED,this.onTargetSizeChange,this),this._target=null):this._target=null)}onTargetSizeChange(){const e=this.node.getComponent(UITransform),t=this._target;this._changeSize.set(e.contentSize),this._widthFollow&&(this._changeSize.width=Math.max(0,t.width+this._widthOffset)),this._heightFollow&&(this._changeSize.height=Math.max(0,t.height+this._heightOffset)),e.setContentSize(this._changeSize)}updateSizeOffset(){if(null==this._target)return;const e=this.node.getComponent(UITransform),t=this._target;if(this._widthFollow){const s=e.width,i=t.width;this._widthOffset=s-i}if(this._heightFollow){const s=e.height,i=t.height;this._heightOffset=s-i}}};__decorate$2([property$2({type:UITransform})],SizeFollow.prototype,"target",null),__decorate$2([property$2({type:UITransform})],SizeFollow.prototype,"_target",void 0),__decorate$2([property$2],SizeFollow.prototype,"heightFollow",null),__decorate$2([property$2],SizeFollow.prototype,"_heightFollow",void 0),__decorate$2([property$2],SizeFollow.prototype,"widthFollow",null),__decorate$2([property$2],SizeFollow.prototype,"_widthFollow",void 0),__decorate$2([property$2({type:CCFloat})],SizeFollow.prototype,"_heightOffset",void 0),__decorate$2([property$2({type:CCFloat})],SizeFollow.prototype,"_widthOffset",void 0),SizeFollow=__decorate$2([ccclass$2("SizeFollow"),menu$2("moye/SizeFollow")],SizeFollow);var __decorate$1=function(e,t,s,i){var r,n=arguments.length,o=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(n<3?r(o):n>3?r(t,s,o):r(t,s))||o);return n>3&&o&&Object.defineProperty(t,s,o),o};const{ccclass:ccclass$1,property:property$1,executeInEditMode:executeInEditMode,menu:menu$1}=_decorator;var WidgetBase,WidgetDirection;!function(e){e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.TOP=3]="TOP",e[e.BOTTOM=4]="BOTTOM"}(WidgetBase||(WidgetBase={})),function(e){e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.TOP=3]="TOP",e[e.BOTTOM=4]="BOTTOM",e[e.LEFT_EXTEND=5]="LEFT_EXTEND",e[e.RIGHT_EXTEND=6]="RIGHT_EXTEND",e[e.TOP_EXTEND=7]="TOP_EXTEND",e[e.BOTTOM_EXTEND=8]="BOTTOM_EXTEND"}(WidgetDirection||(WidgetDirection={}));let CTWidget=class extends Component{constructor(){super(...arguments),this._targetDir=WidgetDirection.TOP,this._dir=WidgetDirection.TOP,this.visibleOffset=0,this._isVertical=!0,this._distance=0,this._changePos=new Vec3(0,0,0),this._targetOldPos=new Vec3(0,0,0),this._targetOldSize=0,this._selfOldPos=new Vec3(0,0,0),this._selfOldSize=0}get target(){return this._target}set target(e){this._target=e,this.unregisterEvt(),this.registerEvt(),this.updateData()}set targetDir(e){if(EDITOR){if(e==WidgetDirection.LEFT||e==WidgetDirection.RIGHT){switch(this._dir){case WidgetDirection.TOP:case WidgetDirection.TOP_EXTEND:case WidgetDirection.BOTTOM:case WidgetDirection.BOTTOM_EXTEND:this._dir=WidgetDirection.LEFT}this._isVertical=!1}else{switch(this._dir){case WidgetDirection.LEFT:case WidgetDirection.LEFT_EXTEND:case WidgetDirection.RIGHT:case WidgetDirection.RIGHT_EXTEND:this._dir=WidgetDirection.TOP}this._isVertical=!0}this._targetDir=e,this.updateData()}}get targetDir(){return this._targetDir}set dir(e){if(EDITOR){switch(e){case WidgetDirection.LEFT:case WidgetDirection.LEFT_EXTEND:case WidgetDirection.RIGHT:case WidgetDirection.RIGHT_EXTEND:switch(this._targetDir){case WidgetDirection.TOP:case WidgetDirection.BOTTOM:this._targetDir=WidgetDirection.LEFT}this._isVertical=!1;break;case WidgetDirection.TOP:case WidgetDirection.TOP_EXTEND:case WidgetDirection.BOTTOM:case WidgetDirection.BOTTOM_EXTEND:switch(this._targetDir){case WidgetDirection.LEFT:case WidgetDirection.RIGHT:this._targetDir=WidgetDirection.TOP}this._isVertical=!0}this._dir=e,this.updateData()}}get dir(){return this._dir}onEnable(){EDITOR&&(this.registerEvt(),this.updateData())}onDisable(){EDITOR&&this.unregisterEvt()}onLoad(){this._trans=this.node.getComponent(UITransform),EDITOR||this.registerEvt()}onDestroy(){EDITOR||(this.unregisterEvt(),this._trans=null,this._target=null,this._changePos=null)}registerEvt(){this._target&&(EDITOR&&(this._target.node.on(NodeEventType.ANCHOR_CHANGED,this.updateData,this),this.node.on(NodeEventType.TRANSFORM_CHANGED,this.updateData,this),this.node.on(NodeEventType.SIZE_CHANGED,this.updateData,this)),this._target.node.on(NodeEventType.SIZE_CHANGED,this.onTargetChange,this),this._target.node.on(NodeEventType.TRANSFORM_CHANGED,this.onTargetChange,this),this._target.node.on(NodeEventType.ACTIVE_IN_HIERARCHY_CHANGED,this.onTargetChange,this))}unregisterEvt(){this._target&&this._target.isValid&&(EDITOR&&(this._target.node.off(NodeEventType.ANCHOR_CHANGED,this.updateData,this),this.node.off(NodeEventType.TRANSFORM_CHANGED,this.updateData,this),this.node.off(NodeEventType.SIZE_CHANGED,this.updateData,this)),this._target.node.off(NodeEventType.SIZE_CHANGED,this.onTargetChange,this),this._target.node.off(NodeEventType.TRANSFORM_CHANGED,this.onTargetChange,this),this._target.node.off(NodeEventType.ACTIVE_IN_HIERARCHY_CHANGED,this.onTargetChange,this))}updateData(){if(null!=this._target)switch(this._dir){case WidgetDirection.TOP:case WidgetDirection.BOTTOM:case WidgetDirection.LEFT:case WidgetDirection.RIGHT:this.updateDistance();break;case WidgetDirection.TOP_EXTEND:case WidgetDirection.BOTTOM_EXTEND:case WidgetDirection.LEFT_EXTEND:case WidgetDirection.RIGHT_EXTEND:this.updateTargetPos()}}onTargetChange(){if(null!=this._target)switch(this._dir){case WidgetDirection.TOP:case WidgetDirection.BOTTOM:case WidgetDirection.LEFT:case WidgetDirection.RIGHT:this.updatePos();break;case WidgetDirection.TOP_EXTEND:case WidgetDirection.BOTTOM_EXTEND:case WidgetDirection.LEFT_EXTEND:case WidgetDirection.RIGHT_EXTEND:this.updateSize()}}updateSize(){if(this._isVertical){const e=this._targetOldPos.y-this._target.node.position.y;let t=this._target.height-this._targetOldSize;const s=this._trans.anchorY;this._changePos.set(this._selfOldPos),this._target.getComponent(Label)&&!this._target.node.active&&(t=this._targetOldSize);const i=e+t;this._trans.height=this._selfOldSize+i,this._dir==WidgetDirection.TOP_EXTEND?this.node.setPosition(this._changePos):this._dir==WidgetDirection.BOTTOM_EXTEND&&(this._changePos.y-=i*(1-s),this.node.setPosition(v3(this._changePos)))}}updatePos(){const e=this._trans,t=this._target;let s=this.getPos(t,this._targetDir)-this._distance;if(this._changePos.set(this.node.worldPosition),this._isVertical){switch(this._dir){case WidgetDirection.TOP:s-=e.height*(1-e.anchorY);break;case WidgetDirection.BOTTOM:s+=e.height*e.anchorY;break}this._changePos.y=s}else this._changePos.x=s;this.node.worldPosition=this._changePos}updateTargetPos(){EDITOR&&null==this._changePos&&(console.error("编辑器数据错乱, 请重新添加本组件"),this._changePos=v3()),this.target.node.getPosition(this._targetOldPos),this.node.getPosition(this._selfOldPos),this._isVertical?(this._selfOldSize=this._trans.height,this._targetOldSize=this._target.height):(this._selfOldSize=this._trans.width,this._targetOldSize=this._target.height)}updateDistance(){if(!EDITOR)return;if(null==this._target)return;const e=this.node.getComponent(UITransform),t=this._target,s=this.getPos(e,this._dir),i=this.getPos(t,this._targetDir);this._distance=i-s}getPos(e,t){if(this._isVertical){let s=e.node.worldPosition.y;const i=e.height,r=e.anchorY;switch(t){case WidgetDirection.TOP:case WidgetDirection.TOP_EXTEND:return e.node.active||(s=s-i-this.visibleOffset),s+i*(1-r);case WidgetDirection.BOTTOM:case WidgetDirection.BOTTOM_EXTEND:return e.node.active||(s=s+i+this.visibleOffset),s-i*r}}else{const s=e.node.worldPosition.x,i=e.width,r=e.anchorX;switch(t){case WidgetDirection.LEFT:return s-i*r;case WidgetDirection.RIGHT:return s+i*(1-r)}}}};__decorate$1([property$1({type:UITransform})],CTWidget.prototype,"target",null),__decorate$1([property$1({type:UITransform})],CTWidget.prototype,"_target",void 0),__decorate$1([property$1({type:Enum(WidgetBase)})],CTWidget.prototype,"targetDir",null),__decorate$1([property$1],CTWidget.prototype,"_targetDir",void 0),__decorate$1([property$1({type:Enum(WidgetDirection)})],CTWidget.prototype,"dir",null),__decorate$1([property$1],CTWidget.prototype,"_dir",void 0),__decorate$1([property$1({type:CCFloat})],CTWidget.prototype,"visibleOffset",void 0),__decorate$1([property$1],CTWidget.prototype,"_isVertical",void 0),__decorate$1([property$1],CTWidget.prototype,"_distance",void 0),__decorate$1([property$1],CTWidget.prototype,"_changePos",void 0),__decorate$1([property$1],CTWidget.prototype,"_targetOldPos",void 0),__decorate$1([property$1],CTWidget.prototype,"_targetOldSize",void 0),__decorate$1([property$1],CTWidget.prototype,"_selfOldPos",void 0),__decorate$1([property$1],CTWidget.prototype,"_selfOldSize",void 0),CTWidget=__decorate$1([ccclass$1("CTWidget"),menu$1("moye/CTWidget"),executeInEditMode],CTWidget);const RoundBoxAssembler={GetIndexBuffer(e){const t=[0,1,2,2,3,0,4,5,6,6,7,4,8,9,10,10,11,8];let s=12;const i=function(i,r,n){let o=r;for(let r=0;r<e.segments-1;r++){const e=s;s++,t.push(i,o,e),o=e}t.push(i,o,n)};return e.leftBottom&&i(3,4,0),e.leftTop&&i(2,1,5),e.rightTop&&i(9,6,10),e.rightBottom&&i(8,11,7),t},createData(e){const t=e.requestRenderData();let s=0;s+=e.leftBottom?1:0,s+=e.leftTop?1:0,s+=e.rightTop?1:0,s+=e.rightBottom?1:0;const i=12+(e.segments-1)*s;t.dataLength=i,t.resize(i,18+3*e.segments*s);const r=RoundBoxAssembler.GetIndexBuffer(e);return t.chunk.setIndexBuffer(r),t},updateRenderData(e){const t=e.spriteFrame;dynamicAtlasManager.packToDynamicAtlas(e,t),this.updateUVs(e);const s=e.renderData;s&&t&&(s.vertDirty&&this.updateVertexData(e),s.updateRenderData(e,t))},updateWorldVerts(e,t){const s=e.renderData,i=t.vb,r=s.data,n=e.node.worldMatrix,o=s.floatStride;let a=0;const c=r.length;for(let e=0;e<c;e++){const t=r[e],s=t.x,c=t.y;let l=n.m03*s+n.m07*c+n.m15;l=l?1/l:1,a=e*o,i[a+0]=(n.m00*s+n.m04*c+n.m12)*l,i[a+1]=(n.m01*s+n.m05*c+n.m13)*l,i[a+2]=(n.m02*s+n.m06*c+n.m14)*l}},fillBuffers(e){if(null===e)return;const t=e.renderData,s=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVerts(e,s),t.vertDirty=!1),s.bufferId;const i=s.vertexOffset,r=s.meshBuffer,n=s.meshBuffer.iData;let o=r.indexOffset;const a=i,c=RoundBoxAssembler.GetIndexBuffer(e);for(let e=0;e<t.indexCount;e++)n[o++]=a+c[e];r.indexOffset+=t.indexCount},updateVertexData(e){const t=e.renderData;if(!t)return;const s=e.node._uiProps.uiTransformComp,i=t.data,r=s.width,n=s.height,o=s.anchorX*r,a=s.anchorY*n,c=0-o,l=r-o,h=n-a,d=0-a,u=c+e.radius,p=d+e.radius,_=h-e.radius,g=l-e.radius;i[0].x=c,i[0].y=e.leftBottom?p:d,i[1].x=c,i[1].y=e.leftTop?_:h,i[2].x=u,i[2].y=e.leftTop?_:h,i[3].x=u,i[3].y=e.leftBottom?p:d,i[4].x=u,i[4].y=d,i[5].x=u,i[5].y=h,i[6].x=g,i[6].y=h,i[7].x=g,i[7].y=d,i[8].x=g,i[8].y=e.rightBottom?p:d,i[9].x=g,i[9].y=e.rightTop?_:h,i[10].x=l,i[10].y=e.rightTop?_:h,i[11].x=l,i[11].y=e.rightBottom?p:d;let m=12;const T=function(t,s){for(let r=1;r<e.segments;r++){const n=s*Math.PI/180-r/e.segments*.5*Math.PI;i[m].x=t.x+Math.cos(n)*e.radius,i[m].y=t.y+Math.sin(n)*e.radius,m++}};e.leftBottom&&T(i[3],270),e.leftTop&&T(i[2],180),e.rightTop&&T(i[9],90),e.rightBottom&&T(i[8],0),t.vertDirty=!0},updateUVs(e){if(!e.spriteFrame)return;const t=e.renderData,s=t.chunk.vb,i=e.spriteFrame.uv,r=i[0],n=i[1],o=i[2],a=i[5],c=Math.abs(o-r),l=a-n,h=e.node._uiProps.uiTransformComp,d=t.data,u=h.width,p=h.height,_=h.anchorX*u,g=h.anchorY*p;for(let e=0;e<t.dataLength;e++)s[e*t.floatStride+3]=r+(d[e].x+_)/u*c,s[e*t.floatStride+4]=n+(d[e].y+g)/p*l},updateColor(e){const t=e.renderData,s=t.chunk.vb;let i=5;const r=e.color,n=r.r/255,o=r.g/255,a=r.b/255,c=r.a/255;for(let e=0;e<t.dataLength;e++,i+=t.floatStride)s[i]=n,s[i+1]=o,s[i+2]=a,s[i+3]=c}};var __decorate=function(e,t,s,i){var r,n=arguments.length,o=n<3?t:null===i?i=Object.getOwnPropertyDescriptor(t,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,s,i);else for(var a=e.length-1;a>=0;a--)(r=e[a])&&(o=(n<3?r(o):n>3?r(t,s,o):r(t,s))||o);return n>3&&o&&Object.defineProperty(t,s,o),o};const{ccclass:ccclass,property:property,type:type,menu:menu}=_decorator;var EventType;!function(e){e.SPRITE_FRAME_CHANGED="spriteframe-changed"}(EventType||(EventType={}));let RoundBoxSprite=class extends UIRenderer{constructor(){super(...arguments),this._sizeMode=Sprite.SizeMode.TRIMMED,this._atlas=null,this._segments=10,this._radius=20,this._spriteFrame=null,this._leftTop=!0,this._rightTop=!0,this._leftBottom=!0,this._rightBottom=!0}get sizeMode(){return this._sizeMode}set sizeMode(e){this._sizeMode!==e&&(this._sizeMode=e,e!==Sprite.SizeMode.CUSTOM&&this._applySpriteSize())}get spriteAtlas(){return this._atlas}set spriteAtlas(e){this._atlas!==e&&(this._atlas=e)}get segments(){return this._segments}set segments(e){this._segments=e,this._renderData=null,this._flushAssembler()}get radius(){return this._radius}set radius(e){this._radius=e,this._updateUVs(),this.markForUpdateRenderData(!0)}get spriteFrame(){return this._spriteFrame}set spriteFrame(e){if(this._spriteFrame===e)return;const t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(),this._applySpriteFrame(t),EDITOR&&this.node.emit(EventType.SPRITE_FRAME_CHANGED,this)}get leftTop(){return this._leftTop}set leftTop(e){this._leftTop=e,this.resetAssembler()}get rightTop(){return this._rightTop}set rightTop(e){this._rightTop=e,this.resetAssembler()}get leftBottom(){return this._leftBottom}set leftBottom(e){this._leftBottom=e,this.resetAssembler()}get rightBottom(){return this._rightBottom}set rightBottom(e){this._rightBottom=e,this.resetAssembler()}onLoad(){this._flushAssembler()}__preload(){this.changeMaterialForDefine(),super.__preload(),EDITOR&&(this._resized(),this.node.on(NodeEventType.SIZE_CHANGED,this._resized,this))}onEnable(){super.onEnable(),this._activateMaterial();this._spriteFrame&&this._updateUVs()}onDestroy(){EDITOR&&this.node.off(NodeEventType.SIZE_CHANGED,this._resized,this),super.onDestroy()}changeSpriteFrameFromAtlas(e){if(!this._atlas)return void console.warn("SpriteAtlas is null.");const t=this._atlas.getSpriteFrame(e);this.spriteFrame=t}changeMaterialForDefine(){let e;const t=this._instanceMaterialType;this._spriteFrame&&(e=this._spriteFrame.texture);let s=!1;if(e instanceof cclegacy.TextureBase){const t=e.getPixelFormat();s=t===cclegacy.TextureBase.PixelFormat.RGBA_ETC1||t===cclegacy.TextureBase.PixelFormat.RGB_A_PVRTC_4BPPV1||t===cclegacy.TextureBase.PixelFormat.RGB_A_PVRTC_2BPPV1}this._instanceMaterialType=s?InstanceMaterialType.USE_ALPHA_SEPARATED:InstanceMaterialType.ADD_COLOR_AND_TEXTURE,t!==this._instanceMaterialType&&this.updateMaterial()}_updateBuiltinMaterial(){let e=super._updateBuiltinMaterial();if(this.spriteFrame&&this.spriteFrame.texture instanceof RenderTexture){const t={SAMPLE_FROM_RT:!0,...e.passes[0].defines},s=new Material;s.initialize({effectAsset:e.effectAsset,defines:t}),e=s}return e}_render(e){e.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)}_canRender(){if(!super._canRender())return!1;const e=this._spriteFrame;return!(!e||!e.texture)}resetAssembler(){this._assembler=null,this._flushAssembler()}_flushAssembler(){const e=RoundBoxAssembler;this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateRenderData(this),this._updateColor())}_applySpriteSize(){if(this._spriteFrame){if(BUILD||!this._spriteFrame)if(Sprite.SizeMode.RAW===this._sizeMode){const e=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(e)}else if(Sprite.SizeMode.TRIMMED===this._sizeMode){const e=this._spriteFrame.rect;this.node._uiProps.uiTransformComp.setContentSize(e.width,e.height)}this.markForUpdateRenderData(!0),this._assembler.updateRenderData(this)}}_resized(){if(EDITOR&&this._spriteFrame){const e=this.node._uiProps.uiTransformComp.contentSize;let t=e.width,s=e.height;if(this._sizeMode===Sprite.SizeMode.RAW){const e=this._spriteFrame.originalSize;t=e.width,s=e.height}else if(this._sizeMode===Sprite.SizeMode.TRIMMED){const e=this._spriteFrame.rect;t=e.width,s=e.height}t===e.width&&s===e.height||(this._sizeMode=Sprite.SizeMode.CUSTOM)}}_activateMaterial(){const e=this._spriteFrame,t=this.getRenderMaterial(0);e&&t&&this.markForUpdateRenderData(),this.renderData&&(this.renderData.material=t)}_updateUVs(){this._assembler&&this._assembler.updateUVs(this)}_applySpriteFrame(e){const t=this._spriteFrame;let s=!1;t&&(e&&e.texture===t.texture||(s=!0),s&&(this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize())}};__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"_sizeMode",void 0),__decorate([type(Sprite.SizeMode)],RoundBoxSprite.prototype,"sizeMode",null),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"_atlas",void 0),__decorate([type(SpriteAtlas)],RoundBoxSprite.prototype,"spriteAtlas",null),__decorate([property({type:CCInteger,serializable:!0})],RoundBoxSprite.prototype,"_segments",void 0),__decorate([property({type:CCInteger,serializable:!0,min:1})],RoundBoxSprite.prototype,"segments",null),__decorate([property({type:CCFloat,serializable:!0})],RoundBoxSprite.prototype,"_radius",void 0),__decorate([property({type:CCFloat,serializable:!0,min:0})],RoundBoxSprite.prototype,"radius",null),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"_spriteFrame",void 0),__decorate([type(SpriteFrame)],RoundBoxSprite.prototype,"spriteFrame",null),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"_leftTop",void 0),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"leftTop",null),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"_rightTop",void 0),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"rightTop",null),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"_leftBottom",void 0),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"leftBottom",null),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"_rightBottom",void 0),__decorate([property({serializable:!0})],RoundBoxSprite.prototype,"rightBottom",null),RoundBoxSprite=__decorate([ccclass("RoundBoxSprite"),menu("moye/RoundBoxSprite")],RoundBoxSprite);export{AEvent,AEventHandler,AfterCreateClientScene,AfterCreateCurrentScene,AfterProgramInit,AfterProgramStart,AfterSingletonAdd,BeforeProgramInit,BeforeProgramStart,BeforeSingletonAdd,BundleAsset,CTWidget,CancellationToken,CancellationTokenTag,CoroutineLock,CoroutineLockItem,CoroutineLockTag,DecoratorCollector,Entity,EntityCenter,EventDecorator,EventDecoratorType,EventHandlerTag,EventSystem,Game,IdGenerator,IdStruct,InstanceIdStruct,JsHelper,Logger,MoyeAssets,ObjectPool,Options,Program,RecycleObj,RoundBoxSprite,Scene,SceneFactory,SceneRefCom,SceneType,Singleton,SizeFollow,TimeInfo,TimerMgr,error,log,safeCall,warn};