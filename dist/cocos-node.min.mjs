import Long from"long";class Singleton{constructor(){this._isDisposed=!1}static getInst(){let t=this,e=t._inst;if(null==e)throw new Error(`Singleton is not initialized, name is ${t.name}`);return e}get isDisposed(){return this._isDisposed}dispose(){this._onPreDestroy()}_onPreDestroy(){this._isDisposed||(this.destroy&&this.destroy(),Singleton._inst=null,this._isDisposed=!0)}}class Options extends Singleton{constructor(){super(...arguments),this.isServer=!1,this.process=1,this.zone=1,this.logLevel=1,this.develop=!0,this.console=!1,this._argsMap=new Map}_setArgs(t,e){this._argsMap.set(t,e)}getArgs(t){if(!this._argsMap.has(t))throw new Error(`Options.getArgs ${t} not exist`);return this._argsMap.get(t)}}class TimeInfo extends Singleton{awake(){this.serverMinusClientTime=0,this.frameTime=this.clientNow()}get ServerMinusClientTime(){return this.serverMinusClientTime}set ServerMinusClientTime(t){this.serverMinusClientTime=t}update(){this.frameTime=this.clientNow()}clientNow(){return Math.floor(Date.now())}serverNow(){return this.clientNow()+this.serverMinusClientTime}clientFrameTime(){return this.frameTime}serverFrameTime(){return this.frameTime+this.serverMinusClientTime}}class JsHelper{static getMethodName(){let t=(new Error).stack.split("at ")[2],e=t.indexOf(" ");return t.substring(0,e)}static getRootDirName(t){return t.split("/")[0]}static sleep(t){return new Promise((e=>setTimeout(e,t)))}static isNullOrEmpty(t){return null==t||(0==t.length||void 0)}static getStringHashCode(t){let e=5381,s=t.length;for(;s;)e=33*e^t.charCodeAt(--s);return e>>>0}static modeString(t,e){return this.getStringHashCode(t)%e}static formatStr(t,...e){let s;if("string"!=typeof t){let t=new Error("formatStr args[0] is not string");return t.name+t.stack}return 0==e.length?t:(s=t.replace(/\{\{|\}\}|\{(\d+)\}/g,(function(t,s){return"{{"==t?"{":"}}"==t?"}":e[s]})),s)}}class Logger extends Singleton{set iLog(t){this._iLog=t}log(t,...e){if(this.checkLogLevel(Logger.LOG_LEVEL)){let s=JsHelper.formatStr(t,...e);this._iLog.log(s)}}warn(t,...e){if(this.checkLogLevel(Logger.WARN_LEVEL)){let s=JsHelper.formatStr(t,...e);this._iLog.warn(s)}}error(t,...e){let s=JsHelper.formatStr(t,...e),i=new Error,n=JsHelper.formatStr("{0}, stack: {1}",s,i.stack);this._iLog.error(n)}checkLogLevel(t){return Options.getInst().logLevel<=t}coreLog(t,...e){let s=JsHelper.formatStr(t,...e);this._iLog.log(s)}coreWarn(t,...e){let s=JsHelper.formatStr(t,...e);this._iLog.warn(s)}coreError(t,...e){let s=JsHelper.formatStr(t,...e),i=new Error,n=JsHelper.formatStr("{0}, stack: {1}",s,i.stack);this._iLog.error(n)}}function log(t,...e){Logger.getInst().log(t,...e)}function warn(t,...e){Logger.getInst().warn(t,...e)}function error(t,...e){Logger.getInst().error(t,...e)}function coreLog(t,...e){let s=`[core]: ${JsHelper.formatStr(t,...e)}`;try{Logger.getInst().coreLog(s)}catch(t){console.log(s)}}function coreWarn(t,...e){let s=`[core]: ${JsHelper.formatStr(t,...e)}`;try{Logger.getInst().coreWarn(s)}catch(t){console.warn(s)}}function coreError(t,...e){let s=`[core]: ${JsHelper.formatStr(t,...e)}`;try{Logger.getInst().coreError(s)}catch(t){console.error(s)}}Logger.LOG_LEVEL=1,Logger.WARN_LEVEL=2;class IdStruct{static generate(){0==this.lastTime&&(this.lastTime=this.timeSinceEpoch(),this.lastTime<=0&&(coreWarn(`${(new this).constructor.name}: lastTime less than 0: ${this.lastTime}`),this.lastTime=1));let t=this.timeSinceEpoch();t>this.lastTime?(this.lastTime=t,this.idCount=0):(++this.idCount,this.idCount>IdStruct.PowValueBit&&(++this.lastTime,this.idCount=0,coreError(`${(new this).constructor.name}: idCount per sec overflow: ${t} ${this.lastTime}`)));let e=new this;return e.initArgs3(this.lastTime,Options.getInst().process,this.idCount),e.ToLong()}static timeSinceEpoch(){let t=(TimeInfo.getInst().frameTime-this.epoch)/1e3;return Math.floor(t)}ToLong(){return this.result.toNumber()}initArgs1(t){return this.result=Long.fromNumber(t,!0),this.Time=this.result.and(IdStruct.PowTimeBit).toNumber(),this.Process=this.result.shiftRight(IdStruct.TimeBit).and(IdStruct.PowProcessBit).toNumber(),this.Value=this.result.shiftRight(IdStruct.TimeBit+IdStruct.ProcessBit).and(IdStruct.PowValueBit).toNumber(),this}initArgs2(t,e){this.Time=0,this.Process=t,this.Value=e,this.updateResult()}initArgs3(t,e,s){return this.Time=t,this.Process=e,this.Value=s,this.updateResult(),this}updateResult(){this.result=Long.fromInt(0,!0).or(this.Value).shiftLeft(IdStruct.ProcessBit).or(this.Process).shiftLeft(IdStruct.TimeBit).or(this.Time)}}IdStruct.epoch=new Date(2023,4,1).getTime(),IdStruct.lastTime=0,IdStruct.idCount=0,IdStruct.TimeBit=28,IdStruct.ProcessBit=8,IdStruct.ValueBit=17,IdStruct.PowTimeBit=Math.pow(2,IdStruct.TimeBit)-1,IdStruct.PowProcessBit=Math.pow(2,IdStruct.ProcessBit)-1,IdStruct.PowValueBit=Math.pow(2,IdStruct.ValueBit)-1;class InstanceIdStruct{static generate(){0==this.lastTime&&(this.lastTime=this.timeSinceEpoch(),this.lastTime<=0&&(coreWarn(`${(new this).constructor.name}: lastTime less than 0: ${this.lastTime}`),this.lastTime=1));let t=this.timeSinceEpoch();t>this.lastTime?(this.lastTime=t,this.idCount=0):(++this.idCount,this.idCount>InstanceIdStruct.PowValueBit&&(++this.lastTime,this.idCount=0,coreError(`${(new this).constructor.name}: idCount per sec overflow: ${t} ${this.lastTime}`)));let e=new this;return e.initArgs3(this.lastTime,Options.getInst().process,this.idCount),e.ToLong()}static timeSinceEpoch(){let t=(TimeInfo.getInst().frameTime-this.epoch)/1e3;return Math.floor(t)}ToLong(){return this.result.toNumber()}initArgs1(t){return this.result=Long.fromNumber(t,!0),this.Time=this.result.and(InstanceIdStruct.PowTimeBit).toNumber(),this.Process=this.result.shiftRight(InstanceIdStruct.TimeBit).and(InstanceIdStruct.PowProcessBit).toNumber(),this.Value=this.result.shiftRight(InstanceIdStruct.TimeBit+InstanceIdStruct.ProcessBit).and(InstanceIdStruct.PowValueBit).toNumber(),this}initArgs2(t,e){this.Time=0,this.Process=t,this.Value=e,this.updateResult()}initArgs3(t,e,s){return this.Time=t,this.Process=e,this.Value=s,this.updateResult(),this}updateResult(){this.result=Long.fromInt(0,!0).or(this.Value).shiftLeft(InstanceIdStruct.ProcessBit).or(this.Process).shiftLeft(InstanceIdStruct.TimeBit).or(this.Time)}}InstanceIdStruct.epoch=new Date(2023,4,2).getTime(),InstanceIdStruct.lastTime=0,InstanceIdStruct.idCount=0,InstanceIdStruct.TimeBit=28,InstanceIdStruct.ProcessBit=8,InstanceIdStruct.ValueBit=17,InstanceIdStruct.PowTimeBit=Math.pow(2,InstanceIdStruct.TimeBit)-1,InstanceIdStruct.PowProcessBit=Math.pow(2,InstanceIdStruct.ProcessBit)-1,InstanceIdStruct.PowValueBit=Math.pow(2,InstanceIdStruct.ValueBit)-1;class IdGenerator extends Singleton{awake(){}generateInstanceId(){return InstanceIdStruct.generate()}generateId(){return IdStruct.generate()}}class ObjectPool extends Singleton{constructor(){super(...arguments),this._pool=new Map}fetch(t){let e=this._pool.get(t);return e?0===e.length?new t:e.shift():new t}recycle(t){let e=t.constructor,s=this._pool.get(e);s||(s=[],this._pool.set(e,s)),s.length>1e3?console.warn(`pool ${e.name} is too large`):s.push(t)}}class EntityCenter extends Singleton{constructor(){super(...arguments),this.allEntities=new Map}add(t){this.allEntities.set(t.instanceId,t)}remove(t){this.allEntities.delete(t)}get(t){return this.allEntities.get(t)}}var InstanceQueueIndex,EntityStatus,SceneType;!function(t){t[t.None=-1]="None",t[t.Update=0]="Update",t[t.LateUpdate=1]="LateUpdate",t[t.Max=2]="Max"}(InstanceQueueIndex||(InstanceQueueIndex={}));class EntityLifiCycleMgr extends Singleton{constructor(){super(...arguments),this.queues=new Array(InstanceQueueIndex.Max)}awake(){for(let t=0;t<this.queues.length;t++)this.queues[t]=new Array}registerSystem(t){t.update&&this.queues[InstanceQueueIndex.Update].push(t.instanceId),t.lateUpdate&&this.queues[InstanceQueueIndex.LateUpdate].push(t.instanceId)}awakeComEvent(t){t.awake()}destroyComEvent(t){t.destroy()}update(){let t=this.queues[InstanceQueueIndex.Update],e=EntityCenter.getInst();for(let s=t.length-1;s>=0;s--){let i=t[s],n=e.get(i);n?n.isDisposed?t.splice(s,1):n.update():t.splice(s,1)}}lateUpdate(){let t=this.queues[InstanceQueueIndex.LateUpdate],e=EntityCenter.getInst();for(let s=t.length-1;s>=0;s--){let i=t[s],n=e.get(i);n?n.isDisposed?t.splice(s,1):n.lateUpdate():t.splice(s,1)}}}!function(t){t[t.None=0]="None",t[t.IsFromPool=1]="IsFromPool",t[t.IsRegister=2]="IsRegister",t[t.IsComponent=4]="IsComponent",t[t.IsCreated=8]="IsCreated",t[t.IsNew=16]="IsNew"}(EntityStatus||(EntityStatus={}));class Entity{constructor(){this.status=EntityStatus.None}get parent(){return this._parent}set parent(t){if(null==t)throw new Error(`cant set parent null: ${this.constructor.name}`);if(t==this)throw new Error(`cant set parent self: ${this.constructor.name}`);if(null==t.domain)throw new Error(`cant set parent because parent domain is null: ${this.constructor.name} ${t.constructor.name}`);if(null!=this._parent){if(this._parent==t)throw new Error(`重复设置了Parent: ${this.constructor.name} parent: ${this._parent.constructor.name}`);this._parent.removeFromChildren(this)}this._parent=t,this.isComponent=!1,this._parent.addToChildren(this),this.domain=this.parent.domain}get domain(){return this._domain}set domain(t){if(null==t)throw new Error(`domain cant set null: ${this.constructor.name}`);if(this._domain==t)return;let e=this._domain;if(this._domain=t,null==e&&(this.instanceId=IdGenerator.getInst().generateInstanceId(),this.isRegister=!0),null!=this._children)for(let[t,e]of this._children.entries())e.domain=this._domain;if(null!=this._components)for(let[t,e]of this._components.entries())e.domain=this._domain;this.isCreated||(this.isCreated=!0)}get isDisposed(){return 0==this.instanceId}get children(){return this._children??(this._children=ObjectPool.getInst().fetch(Map))}get components(){return this._components??(this._components=ObjectPool.getInst().fetch(Map))}get isFromPool(){return(this.status&EntityStatus.IsFromPool)==EntityStatus.IsFromPool}set isFromPool(t){t?this.status|=EntityStatus.IsFromPool:this.status&=~EntityStatus.IsFromPool}get isComponent(){return(this.status&EntityStatus.IsComponent)==EntityStatus.IsComponent}set isComponent(t){t?this.status|=EntityStatus.IsComponent:this.status&=~EntityStatus.IsComponent}get isCreated(){return(this.status&EntityStatus.IsCreated)==EntityStatus.IsCreated}set isCreated(t){t?this.status|=EntityStatus.IsCreated:this.status&=~EntityStatus.IsCreated}get isNew(){return(this.status&EntityStatus.IsNew)==EntityStatus.IsNew}set isNew(t){t?this.status|=EntityStatus.IsNew:this.status&=~EntityStatus.IsNew}get isRegister(){return(this.status&EntityStatus.IsRegister)==EntityStatus.IsRegister}set isRegister(t){this.isRegister!=t&&(t?this.status|=EntityStatus.IsRegister:this.status&=~EntityStatus.IsRegister,t?(EntityCenter.getInst().add(this),EntityLifiCycleMgr.getInst().registerSystem(this)):EntityCenter.getInst().remove(this.instanceId))}set componentParent(t){if(null==t)throw new Error(`cant set parent null: ${this.constructor.name}`);if(t==this)throw new Error(`cant set parent self: ${this.constructor.name}`);if(null==t.domain)throw new Error(`cant set parent because parent domain is null: ${this.constructor.name} ${t.constructor.name}`);if(null!=this.parent){if(this.parent==t)throw new Error(`重复设置了Parent: ${this.constructor.name} parent: ${this.parent.constructor.name}`);this.parent.removeFromComponents(this)}this._parent=t,this.isComponent=!0,this._parent.addToComponents(this),this.domain=this.parent.domain}addComponent(t,e){return t instanceof Entity?this.addComponentByEntity(t):this.addComponentByCtor(t,e)}tryAddComponent(t){let e=this.getComponent(t);return null==e&&(e=this.addComponent(t)),e}addComponentByEntity(t){let e=t.constructor;if(null!=this._components&&this._components.has(e))throw new Error(`entity already has component: ${e.name}`);return t.componentParent=this,t}addComponentByCtor(t,e=!1){if(null!=this._components&&this._components.has(t))throw new Error(`entity already has component: ${t.name}`);let s=this.create(t,e);return s.id=this.id,s.componentParent=this,s.awake&&EntityLifiCycleMgr.getInst().awakeComEvent(s),s}addChild(t,e){return t instanceof Entity?this.addChildByEntity(t):this.addChildByType(t,e)}addChildWithId(t,e,s=!1){let i=this.create(t,s);return i.id=e,i.parent=this,i.awake&&EntityLifiCycleMgr.getInst().awakeComEvent(i),i}addChildByEntity(t){return t.parent=this,t}addChildByType(t,e=!1){let s=this.create(t,e);return s.id=IdGenerator.getInst().generateId(),s.parent=this,s.awake&&EntityLifiCycleMgr.getInst().awakeComEvent(s),s}create(t,e){let s;return s=e?ObjectPool.getInst().fetch(t):new t,s.isFromPool=e,s.isCreated=!0,s.isNew=!0,s.id=0,s}removeFromChildren(t){null!=this._children&&(this._children.delete(t.id),0==this._children.size&&(ObjectPool.getInst().recycle(this._children),this._children=null))}removeFromComponents(t){null!=this._components&&(this._components.delete(t.constructor),0==this._components.size&&(ObjectPool.getInst().recycle(this._components),this._components=null))}addToComponents(t){this.components.set(t.constructor,t)}addToChildren(t){if(this.children.has(t.id))throw new Error(`entity already has child: ${t.id}`);this.children.set(t.id,t)}getComponent(t){if(null==this._components)return null;let e=this._components.get(t);return e||null}removeComponent(t){if(this.isDisposed)return;if(null==this._components)return;let e=this.getComponent(t);null!=e&&(this.removeFromComponents(e),e.dispose())}getParent(t){return this.parent}getChild(t,e){if(null==this._children)return null;return this._children.get(e)}removeChild(t){if(null==this._children)return;let e=this._children.get(t);e&&(this._children.delete(t),e.dispose())}dispose(){if(!this.isDisposed){if(this.isRegister=!1,this.instanceId=0,null!=this._children){for(let[t,e]of this._children.entries())e.dispose();this._children.clear(),ObjectPool.getInst().recycle(this._children),this._children=null}if(null!=this._components){for(let[t,e]of this._components.entries())e.dispose();this._components.clear(),ObjectPool.getInst().recycle(this._components),this._components=null}this.destroy&&EntityLifiCycleMgr.getInst().destroyComEvent(this),this._domain=null,null==this._parent||this._parent.isDisposed||(this.isComponent?this._parent.removeComponent(this.getType()):this._parent.removeFromChildren(this)),this._parent=null,this.isFromPool&&ObjectPool.getInst().recycle(this),this.status=EntityStatus.None}}domainScene(){return this.domain}getType(){return this.constructor}}class Scene extends Entity{set domain(t){this._domain=t}get domain(){return this._domain}set parent(t){null!=t&&(this._parent=t,this._parent.children.set(this.id,this))}init(t){this.id=t.id,this.instanceId=t.instanceId,this.sceneType=t.sceneType,this.name=t.name,this.parent=t.parent,this.isCreated=!0,this.isNew=!0,this.domain=this,this.isRegister=!0,coreLog("scene create sceneType = {0}, name = {1}, id = {2}",this.sceneType,this.name,this.id)}}!function(t){t.None="None",t.Process="Process",t.Client="Client",t.Current="Current"}(SceneType||(SceneType={}));class Root extends Singleton{get scene(){return this._scene}awake(){let t=new Scene;t.init({id:0,sceneType:SceneType.Process,name:"Process",instanceId:IdGenerator.getInst().generateInstanceId()}),this._scene=t}}export{Entity,EntityLifiCycleMgr,Logger,ObjectPool,Root,Scene,SceneType,error,log,warn};